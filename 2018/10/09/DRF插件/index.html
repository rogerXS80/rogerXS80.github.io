<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="uW8bwgMGUwIA01nPfItoty1rmtmmuVkOVTeS9O0nAUg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="初是瀑布模型，后来是敏捷开发，现在是DevOps，这是现代开发人员构建出色的产品的技术路线。随着DevOps的兴起，出现了持续集成（Continuous Integration）、持续交付（Continuous Delivery） 、持续部署（Continuous Deployment） 的新方法。传统的软件开发和交付方法正在迅...">
<meta property="og:type" content="article">
<meta property="og:title" content="[Django框架]">
<meta property="og:url" content="http://yoursite.com/2018/10/09/DRF%E6%8F%92%E4%BB%B6/index.html">
<meta property="og:site_name" content="Lupinus">
<meta property="og:description" content="初是瀑布模型，后来是敏捷开发，现在是DevOps，这是现代开发人员构建出色的产品的技术路线。随着DevOps的兴起，出现了持续集成（Continuous Integration）、持续交付（Continuous Delivery） 、持续部署（Continuous Deployment） 的新方法。传统的软件开发和交付方法正在迅...">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207170730023.png">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207170706936.png">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207172817731.png">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207172843089.png">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207215355168.png">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207215422255.png">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207215500341.png">
<meta property="article:published_time" content="2018-10-09T00:49:58.000Z">
<meta property="article:modified_time" content="2018-10-09T02:41:37.000Z">
<meta property="article:author" content="Lupinus">
<meta property="article:tag" content="Django">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207170730023.png">

<link rel="canonical" href="http://yoursite.com/2018/10/09/DRF%E6%8F%92%E4%BB%B6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>[Django框架] | Lupinus</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Lupinus" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lupinus</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Re：从零开始的go学习生活(｀・ω・´)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/rogerXS80" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/DRF%E6%8F%92%E4%BB%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/20160715144434_fZCsF.jpeg">
      <meta itemprop="name" content="Lupinus">
      <meta itemprop="description" content="Re：从零开始的go学习生活(｀・ω・´)">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lupinus">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Django框架]
        </h1>

        <div class="post-meta">
          <!-- 置顶图标 -->
            <span class="post-meta-item">
              
              
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2018-10-09 08:49:58 / Modified: 10:41:37" itemprop="dateCreated datePublished" datetime="2018-10-09T08:49:58+08:00">2018-10-09</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">初是瀑布模型，后来是敏捷开发，现在是DevOps，这是现代开发人员构建出色的产品的技术路线。随着DevOps的兴起，出现了持续集成（Continuous Integration）、持续交付（Continuous Delivery） 、持续部署（Continuous Deployment） 的新方法。传统的软件开发和交付方法正在迅...</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Restful-API设计最佳实践"><a href="#Restful-API设计最佳实践" class="headerlink" title="Restful API设计最佳实践"></a>Restful API设计最佳实践</h1><h2 id="RESTFul"><a href="#RESTFul" class="headerlink" title="RESTFul"></a>RESTFul</h2><p>REST(Representational State Transfer)，表现层状态转移。<br> 它首次出现在2000年Roy Fielding的博士论文中，Roy Fielding是HTTP规范的主要编写者之一。</p>
<p>表现层是资源的表现层，对于网络中的资源就需要URI(Uniform Resource Identifier)来指向。REST指的 是资源的状态变化。</p>
<p><strong>注意：RESTFul没有标准</strong></p>
<h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><p>使用HTTP或者HTTPS。对外若有安全性要求，可以使用HTTPS。但是内部服务间调用可以使用HTTP或 HTTPS。</p>
<h2 id="HTTP方法"><a href="#HTTP方法" class="headerlink" title="HTTP方法"></a>HTTP方法</h2><p>HTTP请求中的方法表示执行的<strong>动作</strong></p>
<table>
<thead>
<tr>
<th align="center">常用方法(动词)</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET</td>
<td align="center">获取资源</td>
</tr>
<tr>
<td align="center">POST</td>
<td align="center">创建新的资源</td>
</tr>
<tr>
<td align="center">PUT</td>
<td align="center">更新资源</td>
</tr>
<tr>
<td align="center">PATCH</td>
<td align="center">部分更新资源</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td align="center">删除资源</td>
</tr>
</tbody></table>
<h2 id="使用名词"><a href="#使用名词" class="headerlink" title="使用名词"></a>使用名词</h2><p>URL指向<strong>资源</strong>，在URL路径的描述中，只需要出现名词，而不要出现动词。动词由HTTP方法提供。 不要单复数混用，建议名词使用复数。 </p>
<p>Restful的核心是资源，URL应该指向资源，所以应该是使用名称表达，而不是动词表达。</p>
<table>
<thead>
<tr>
<th align="center">常用方法(动词)</th>
<th align="center"></th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET</td>
<td align="center">/posts</td>
<td align="center">返回所有文章</td>
</tr>
<tr>
<td align="center">GET</td>
<td align="center">/posts/10</td>
<td align="center">返回id为10的文章</td>
</tr>
<tr>
<td align="center">POST</td>
<td align="center">/posts</td>
<td align="center">创建新的文章</td>
</tr>
<tr>
<td align="center">PUT</td>
<td align="center">/posts/10</td>
<td align="center">更新id为10的文章</td>
</tr>
<tr>
<td align="center">PATCH</td>
<td align="center">/posts/10</td>
<td align="center">删除id为10的文章</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td align="center">/posts/10</td>
<td align="center">部分更新id为10的文章数据</td>
</tr>
</tbody></table>
<p>不要出现下面的访问资源的路径</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/getAllPosts</span><br><span class="line">/addPost</span><br><span class="line">/updatePost</span><br><span class="line">/delPost 上面URL中动作和资源混在一起，不好</span><br></pre></td></tr></table></figure>

<p>GET方法只是获取资源，而不是改变资源状态。改变资源请使用POST、PUT、DELETE等方法。 例如，使用 就可以获取资源了，但是却使用<code>GET /post/10/del</code>或 <code>GET /post/10/?v=10</code>，本意是想删除。但这样不好，GET方法请求只为获取资源，不要改变资源状态。</p>
<p>子资源的访问</p>
<table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">路径Endpoint</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET</td>
<td align="center">/posts/10/authors</td>
<td align="center">返回id为10的文章的所有作者</td>
</tr>
<tr>
<td align="center">POST</td>
<td align="center">/posts/10/authors/8</td>
<td align="center">返回id为10的文章的作者中id为8的</td>
</tr>
</tbody></table>
<h2 id="集合功能"><a href="#集合功能" class="headerlink" title="集合功能"></a>集合功能</h2><p> <strong>过滤 Filtering</strong> </p>
<p>指定过滤条件 <code>GET /posts?tag=python</code></p>
<p><strong>排序 Sorting</strong></p>
<p>指定排序条件。有很多种设计风格，例如使用+表示asc，-表示desc。<code>GET /posts?sort=+title,-id</code>或<code>GET /posts?sort=title_asc,id_desc</code></p>
<p><strong>分页 Pagination</strong></p>
<p>一般情况下，查询返回的记录数非常多，必须分页。<code>GET /posts?page=5&amp;size=20</code></p>
<h2 id="状态码"><a href="#状态码" class="headerlink" title="状态码"></a>状态码</h2><p>使用HTTP响应的状态码表示动作的成功与否。 </p>
<ul>
<li><p>2XX表示用户请求被服务器端成功的处理</p>
</li>
<li><p>4XX表示用户请求的错误</p>
</li>
<li><p>5XX表示服务器端出错了</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Status Code</th>
<th align="center">说明</th>
<th align="center">Method</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">200</td>
<td align="center">OK</td>
<td align="center">GET</td>
<td align="center">成功获取资源</td>
</tr>
<tr>
<td align="center">201</td>
<td align="center">CREATED</td>
<td align="center">POST、PUT、PATCH</td>
<td align="center">成功创建或修改</td>
</tr>
<tr>
<td align="center">204</td>
<td align="center">NO CONTENT</td>
<td align="center">DELETE</td>
<td align="center">成功删除资源</td>
</tr>
<tr>
<td align="center">400</td>
<td align="center">Bad Request</td>
<td align="center">ALL</td>
<td align="center">请求中有错误，例如 GET时参数有问题 PUT时提交的数据错误等</td>
</tr>
<tr>
<td align="center">401</td>
<td align="center">Unauthorized</td>
<td align="center">ALL</td>
<td align="center">权限未通过认证</td>
</tr>
<tr>
<td align="center">403</td>
<td align="center">Forbidden</td>
<td align="center">ALL</td>
<td align="center">有无权限都禁止访问该资源</td>
</tr>
<tr>
<td align="center">404</td>
<td align="center">Not Found</td>
<td align="center">ALL</td>
<td align="center">请求的资源不存在</td>
</tr>
<tr>
<td align="center">500</td>
<td align="center">Internal Server Error</td>
<td align="center">ALL</td>
<td align="center">服务器端错误</td>
</tr>
</tbody></table>
<p>详细状态码参考：<a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html" target="_blank" rel="noopener">https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html</a></p>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><p>在Restful API设计中，错误处理也非常重要。单单从状态码中无法详尽描述错误的信息。 </p>
<p>返回消息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   <span class="string">"error"</span>:<span class="string">"User Not Found"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从错误消息中了解到错误号、错误信息、错误描述等信息。甚至更详细的信息可以通过code查阅文档</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"code"</span>:<span class="number">10056</span>,</span><br><span class="line">    <span class="string">"message"</span>:<span class="string">"Invalid ID"</span>,</span><br><span class="line">    <span class="string">"description"</span>:<span class="string">"More details"</span>:</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>code 为 0 表示无错误。非0表示有错误，就要看message中的错误描述了。 </p>
<h2 id="版本"><a href="#版本" class="headerlink" title="版本"></a>版本</h2><p>在较大项目开发时，由于业务升级，需要对接口调用做出改动，例如请求参数、返回状态码、json数据 发生变化等。如果使用同一套接口，在原有接口上直接修改会导致原有调用者调用出问题。解决方法： </p>
<ol>
<li><p>完全兼容原有接口，虽然这样做可以，但是很难做到所有接口的完全兼容设计。实在不行的，老的 接口保留不动，建立新的API接口以供调用</p>
</li>
<li><p>对已经发布使用的接口规定版本号访问。新增的、改进的、删除的API重新发布新的版本。项目开 发时，指定版本和接口即可。老项目可以不必升级到这个新版本。</p>
</li>
</ol>
<p>强烈要求使用版本，版本号使用简单数字，例如v2。</p>
<p>2种风格 </p>
<ul>
<li><p><a href="http://api.magedu.com/v1/posts/10" target="_blank" rel="noopener">http://api.magedu.com/v1/posts/10</a> 这种风格会跨域，适合较大的项目 </p>
</li>
<li><p><a href="http://www.magedu.com/api/v1/posts/10" target="_blank" rel="noopener">http://www.magedu.com/api/v1/posts/10</a> </p>
</li>
</ul>
<h2 id="返回结果"><a href="#返回结果" class="headerlink" title="返回结果"></a>返回结果</h2><table>
<thead>
<tr>
<th align="center">方法</th>
<th align="center">路径</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">GET</td>
<td align="center">/posts</td>
<td align="center">返回所有文章的列表</td>
</tr>
<tr>
<td align="center">GET</td>
<td align="center">/posts/10</td>
<td align="center">返回id为10的文章对象</td>
</tr>
<tr>
<td align="center">POST</td>
<td align="center">/posts</td>
<td align="center">创建新的文章并返回这个对象</td>
</tr>
<tr>
<td align="center">PUT</td>
<td align="center">/posts/10</td>
<td align="center">更新id为10的文章并返回这个对象</td>
</tr>
<tr>
<td align="center">DELETE</td>
<td align="center">/posts/10</td>
<td align="center">删除id为10的文章返回一个空对象</td>
</tr>
<tr>
<td align="center">PATCH</td>
<td align="center">/posts/10</td>
<td align="center">部分更新id为10的文章数据并返回这个对象</td>
</tr>
</tbody></table>
<p>返回数据一律采用JSON格式。</p>
<h2 id="视图函数"><a href="#视图函数" class="headerlink" title="视图函数"></a>视图函数</h2><p>视图函数(Function-based View)，即视图功能由函数实现。</p>
<h3 id="JSON响应"><a href="#JSON响应" class="headerlink" title="JSON响应"></a>JSON响应</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_index</span><span class="params">(request:HttpRequest)</span>:</span></span><br><span class="line">    data = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(data)</span><br><span class="line">  </span><br><span class="line"><span class="comment">#抛出异常</span></span><br><span class="line">TypeError: In order to allow non-dict objects to be serialized set the safe</span><br><span class="line">parameter to <span class="literal">False</span>. 。意思是，safe参数为<span class="literal">False</span>才可使用非字典数据，所以，除非有必要，否则还是使用字典</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse, JsonResponse</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_index</span><span class="params">(request:HttpRequest)</span>:</span></span><br><span class="line">    data = &#123;<span class="string">'a'</span>:<span class="number">100</span>, <span class="string">'b'</span>:<span class="string">'abc'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(data)</span><br></pre></td></tr></table></figure>

<h3 id="请求方法限制装饰器"><a href="#请求方法限制装饰器" class="headerlink" title="请求方法限制装饰器"></a>请求方法限制装饰器</h3><p>如果需要对请求方法限制，例如只允许GET方法请求怎么办？当然可以自己判断，也可以使用Django提供的装饰器函数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse, JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views.decorators.http <span class="keyword">import</span> require_http_methods, require_GET, require_POST</span><br><span class="line"></span><br><span class="line"><span class="comment"># @require_http_methods(['GET', 'POST'])</span></span><br><span class="line"><span class="comment"># @require_GET</span></span><br><span class="line"><span class="meta">@require_POST</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_index</span><span class="params">(request:HttpRequest)</span>:</span></span><br><span class="line">    data = &#123;<span class="string">'a'</span>:<span class="number">100</span>, <span class="string">'b'</span>:<span class="string">'abc'</span>&#125;</span><br><span class="line">    <span class="keyword">return</span> JsonResponse(data)</span><br></pre></td></tr></table></figure>

<p>测试过程中，当使用不被允许的方法请求时，返回405状态码，表示 <code>Method Not Allowed</code></p>
<p><strong>装饰完后，</strong>test_index<strong>就是新的视图函数，装饰器内部的</strong>inner<strong>函数</strong>。这类似于在装饰器一章学过的logger装饰器。</p>
<h3 id="CSRF处理"><a href="#CSRF处理" class="headerlink" title="CSRF处理"></a>CSRF处理</h3><p>在Post数据的时候，发现出现了下面的提示</p>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207170730023.png" alt="image-20230207170730023"></p>
<p>原因：<strong>默认</strong>Django CsrfViewMiddleware<strong>中间件会对所有</strong>POST<strong>方法提交的信息做</strong>CSRF<strong>校验</strong>。</p>
<p>CSRF或XSRF（Cross-site Request Forgery），即跨站请求伪造。它也被称为：one click </p>
<p>attack/session riding，是一种对网站的恶意利用。它伪装成来自受信任用户发起请求，难以防范。</p>
<p><strong>原理</strong></p>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207170706936.png" alt="image-20230207170706936"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> 用户登录某网站A完成登录认证，网站返回敏感信息的Cookie，即使是会话级的Cookie</span><br><span class="line"><span class="number">2.</span> 用户没有关闭浏览器，或认证的Cookie一段时间内不过期还持久化了，用户就访问攻击网站B</span><br><span class="line"><span class="number">3.</span> 攻击网站B看似一切正常，但是某些页面里面有一些隐藏运行的代码，或者诱骗用户操作的按钮等</span><br><span class="line"><span class="number">4.</span> 这些代码一旦运行就是悄悄地向网站A发起特殊请求，由于网站A的Cookie还有效，且访问的是网站A，则其Cookie就可以一并发给网站A</span><br><span class="line"><span class="number">5.</span> 网站A看到这些Cookie就只能认为是登录用户发起的合理合法的请求，就会执行</span><br></pre></td></tr></table></figure>

<h3 id="CSRF解决"><a href="#CSRF解决" class="headerlink" title="CSRF解决"></a>CSRF解决</h3><ol>
<li>关闭CSRF中间件（不推荐）</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    <span class="comment">#'django.middleware.csrf.CsrfViewMiddleware',# 注释掉</span></span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>



2. csrftoken验证
   - 在表单POST提交时，需要发给服务器一个csrf_token 
   - 模板中的表单Form中增加{% csrf_token %}，它返回到了浏览器端就会为cookie增加 csrftoken 字段，还会在表单中增加一个名为csrfmiddlewaretoken隐藏控件  
   - POST提交表单数据时，需要将csrfmiddlewaretoken一并提交，Cookie中的csrf_token 也一 并会提交，最终在中间件中比较，相符通过，不相符就看到上面的403提示
   - 假设正常网站为A，攻击网站为B，在访问网站B网页时，这个网页并不是来自网站A的网页， 而只是在这个网页中包含着提交到网站A的请求的代码，注意只有访问网站A返回的HTML页 面，才会有{% csrf_token %}产生set-cookie和input hidden。网站B的网页恶意代码执行， 由于发起对网站A的请求，会带上cookie，但是没有input hidden带的值，验证失败 
2. 双cookie验证 

   - 访问本站先获得csrftoken的cookie 
   - 如果使用AJAX进行POST，需要在每一次请求Header中增加自定义字段X-CSRFTOKEN，其值 来自cookie中获取的csrftoken值 

   - 在服务器端比较cookie和X-CSRFTOKEN中的csrftoken，相符通过 
   - 假设正常网站为A，攻击网站为B，双Cookie验证中，用户访问攻击网站B时，网站B网页中代 码悄悄发起对A的请求，由于跨域不能获得正常网站A的Cookie值，它只能发起请求时，浏览器自动带上A的Cookie，但是A检查请求头中并没有X-CSRFTOKEN的值，或这个随机token值 对不上，验证失败 现在没有前端代码，为了测试方便，可以选择第一种方法先禁用中间件，测试完成后开启。



<h2 id="视图类"><a href="#视图类" class="headerlink" title="视图类"></a>视图类</h2><p>视图类（Class-based View），即视图功能由一个类和其方法实现 </p>
<p>参考：<a href="https://docs.djangoproject.com/en/3.2/topics/class-based-views/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/topics/class-based-views/</a> </p>
<h4 id="View类原理"><a href="#View类原理" class="headerlink" title="View类原理"></a>View类原理</h4><blockquote>
<p>django.views.View类本质就是一个对请求方法分发到与请求方法同名函数的调度器。</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> TestIndex <span class="comment"># 视图类</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, TestIndex.as_view()), <span class="comment"># 二级路由包含前缀emp/，对应URL是/emp/</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>django.views.View类，定义了http的方法的小写名称列表，这些小写名称其实就是处理请求的方法名的 小写。 </p>
<p>View类的类方法as_view()方法调用后返回一个内建的 <code>view(request, *args, **kwargs)</code> 新函数（为 了后面叙述方便，称它为fn），本质上其实还是url映射到了这个fn函数上。注意这个fn函数的签名，就 是视图函数的签名。</p>
<p>请求request到来后，直接发给fn函数，fn函数内部 </p>
<ul>
<li>构建TestIndex实例self。注意：阅读源码可以看到，每一个请求创建一个实例 </li>
<li>dispatch派发请求，<code>self.dispatch(request, *args, **kwargs)</code> dispatch方法内部比对请求方法method，如果存在请求的get、post等方法，则调用，否则返回405 看到了getattr等反射函数，说明基于反射实现的。 </li>
</ul>
<blockquote>
<p>本质上，as_view()方法还是把一个类伪装成了一个视图函数。 </p>
<p>这个视图函数，内部使用了一个分发函数，使用请求方法名称把请求分发给存在的同名函数处理。</p>
</blockquote>
<h4 id="视图类实现"><a href="#视图类实现" class="headerlink" title="视图类实现"></a>视图类实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse, JsonResponse</span><br><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestIndex</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span> <span class="comment"># 支持GET</span></span><br><span class="line">        data = &#123;<span class="string">'a'</span>:<span class="number">100</span>, <span class="string">'b'</span>:<span class="string">'abc'</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(data)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span> <span class="comment"># 支持POST</span></span><br><span class="line">        data = &#123;<span class="string">'a'</span>:<span class="number">200</span>, <span class="string">'b'</span>:<span class="string">'xyz'</span>&#125;</span><br><span class="line">        <span class="keyword">return</span> JsonResponse(data)</span><br></pre></td></tr></table></figure>

<h4 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h4><p>由上面的原理分析，as_view()后，就可以看做是一个普通的视图函数。由此，得到方法装饰器的一种用法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> TestIndex <span class="comment"># 视图类</span></span><br><span class="line"><span class="keyword">from</span> django.views.decorators.http <span class="keyword">import</span> require_http_methods, require_GET</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment">#path('', require_GET(TestIndex.as_view())),</span></span><br><span class="line">    path(<span class="string">''</span>, require_http_methods([<span class="string">'POST'</span>])(TestIndex.as_view())),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>装饰器本质就是函数调用， require_http_methods([‘POST’])(TestIndex.as_view()) 返回一个新 的视图函数。 </p>
<p>虽然，TestIndex有get、post方法，但是之前却要现经过require_http_methods函数检查。</p>
<h2 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h2><h3 id="洋葱模型"><a href="#洋葱模型" class="headerlink" title="洋葱模型"></a>洋葱模型</h3><p>中间件和视图，如同洋葱一层层包裹着最中心的视图，想要见到视图函数或返回给浏览器端很不容易， 需要在来路和去路都要经过这些中间件。</p>
<p> get_response 非常重要，表示去调用下一层的对象。对象可能是下一级中间件，也可能是洋葱心儿 —— 视图。 </p>
<p>在阅读wsgi.py源码中，进入 django.core.handlers.wsgi.WSGIHandler 类，可以看到 <strong>init</strong> 中 加载了中间件，在 <strong>call</strong> 中调用了get_response。</p>
<h3 id="中间件定义"><a href="#中间件定义" class="headerlink" title="中间件定义"></a>中间件定义</h3><p>Django1.10版本开始，中间件帮助文档已经不能很好的体现其技术原理了。在官网切换到1.8版本帮 助，看到下面内容：<a href="https://docs.djangoproject.com/en/1.8/topics/http/middleware/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/1.8/topics/http/middleware/</a></p>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207172817731.png" alt="image-20230207172817731"></p>
<p>再看看目前的版本的文档：<a href="https://docs.djangoproject.com/en/3.2/topics/http/middleware/" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/topics/http/middleware/</a> </p>
<p>从文档中可以看出保留 process_view、process_exception、process_template_response 这些钩子函数。</p>
<p>process_view参考：<a href="https://docs.djangoproject.com/en/3.2/topics/http/middleware/#process-view" target="_blank" rel="noopener">https://docs.djangoproject.com/en/3.2/topics/http/middleware/#process-view</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">applicaiton</span><br><span class="line">		__init__   <span class="comment"># 装载中间件，实例化一次。拦截所有请求和响应</span></span><br><span class="line">    __call__</span><br><span class="line">    		environ -&gt; request对象</span><br><span class="line">      	response = get_response(request)</span><br><span class="line">        </span><br><span class="line">        start_response()</span><br><span class="line">        <span class="keyword">return</span> [response.body]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleMiddleware</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, get_response)</span>:</span></span><br><span class="line">        self.get_response = get_response</span><br><span class="line">        <span class="comment"># One-time configuration and initialization.</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># request请求去视图的路上</span></span><br><span class="line">        response = self.get_response(request)</span><br><span class="line">        <span class="comment"># 视图函数调用完成返回response的路上</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>

<p>新建包utils，在里面增加一个middlewares.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MagMiddleware1</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, get_response)</span>:</span></span><br><span class="line">        <span class="string">"""执行一次"""</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"init~~~~"</span>)</span><br><span class="line">        self.get_response = get_response</span><br><span class="line">        </span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># request请求去视图的路上</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"__call__~~~~"</span>)</span><br><span class="line">        <span class="comment"># return HttpResponse(self.__class__.__name__) # 测试点</span></span><br><span class="line">        response = self.get_response(request)</span><br><span class="line">        <span class="comment"># 视图函数调用完成返回response的路上</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"__call__#####"</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""调用视图前被调用，返回值是None或HttpResponse对象"""</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"process_view~~~~"</span>, view_func.__name__, view_args, view_kwargs)</span><br><span class="line">        <span class="comment"># return HttpResponse(self.__class__.__name__ + ' process_view') # 测试点</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MagMiddleware2</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, get_response)</span>:</span></span><br><span class="line">        <span class="string">"""执行一次"""</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"init~~~~"</span>)</span><br><span class="line">        self.get_response = get_response</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># request请求去视图的路上</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"__call__~~~~"</span>)</span><br><span class="line">        <span class="comment"># return HttpResponse(self.__class__.__name__) # 测试点</span></span><br><span class="line">        response = self.get_response(request)</span><br><span class="line">        <span class="comment"># 视图函数调用完成返回response的路上</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"__call__#####"</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""调用视图前被调用，返回值是None或HttpResponse对象"""</span></span><br><span class="line">        print(self.__class__.__name__, <span class="string">"process_view~~~~"</span>, view_func.__name__, view_args, view_kwargs)</span><br><span class="line">        <span class="comment"># return HttpResponse(self.__class__.__name__ + ' process_view') #测试点</span></span><br></pre></td></tr></table></figure>

<p>定义2个中间件，注册</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">    <span class="string">'utils.middlewares.MagMiddleware1'</span>,</span><br><span class="line">    <span class="string">'utils.middlewares.MagMiddleware2'</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>将测试代码中 测试点 打开，观察效果，理解中间件原理。</p>
<p><strong>原理</strong></p>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207172843089.png" alt="image-20230207172843089"></p>
<p>结论 </p>
<ul>
<li>Django中间件使用的洋葱式，但有特殊的地方 </li>
<li>settings.py中配置着中间件的顺序 中间件初始化一次，但是初始化顺序和配置序相反，如同包粽子，先从芯开始包 </li>
<li>新版中间件先在 <strong>call</strong> 中 get_response(request) 之前代码（相当于老版本中的 process_request） </li>
<li>按照配置顺序先后执行所有中间件的get_response(request)之前代码 </li>
<li>全部执行完解析路径映射得到 view_func </li>
<li>process_view 函数按照配置顺序，依次向后执行 <ul>
<li>return None 继续向后执行 </li>
<li>return HttpResponse() 就不在执行其它函数的 preview 函数了，此函数返回值作为浏览器端 的响应 </li>
</ul>
</li>
<li>执行view函数，前提是前面的所有中间件 process_view 都返回 None </li>
<li>逆序执行所有中间件的 get_response(request) 之后代码 </li>
<li>特别注意，如果 get_response(request) 之前代码中 return HttpResponse()，将从当前中间件立即 返回给浏览器端，从洋葱中依次反弹</li>
</ul>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>应用场景：如果绝大多数请求或响应都需要拦截，个别例外，采用中间件较为合适。 </p>
<p>中间件有很多用途，适合拦截所有请求和响应。例如浏览器端的IP是否禁用、UserAgent分析、异常响 应的统一处理 </p>
<h3 id="内建中间件"><a href="#内建中间件" class="headerlink" title="内建中间件"></a>内建中间件</h3><ul>
<li>SessionMiddleware 从请求报文中提取 sessionid，提供 request.session 属性 </li>
<li>AuthenticationMiddleware 依赖 SessionMiddleware，提供 request.user属性。根据 session 认证，如果成功，request.user 就是可用的用户对象，is_authenticated 为 True；如果失败，返回一 个匿名用户对象，is_authenticated 为 False。</li>
</ul>
<h2 id="Session和Cookie"><a href="#Session和Cookie" class="headerlink" title="Session和Cookie"></a>Session和Cookie</h2><p>浏览器端和服务器端身份认证的一种方式。简单讲，就是为了让服务端确定你是谁。 </p>
<ul>
<li><p>无状态，无连接 </p>
</li>
<li><p>无连接：Http 1.1之前，都是一个请求一个连接，连接用完即刻断开，其实是无连接。 </p>
<ul>
<li>有连接：是因为它基于TCP协议，是面向连接的，需要3次握手、4次断开。 </li>
<li>短连接：而Tcp的连接创建销毁成本高，对服务器有很大的影响。所以，自Http 1.1开始，支 持keep-alive，默认也开启，一个连接打开后，会保持一段时间（可设置），浏览器再访问该 服务器就使用这个Tcp连接，减轻了服务器压力，提高了效率。 </li>
</ul>
</li>
<li><p>无状态：服务器端没有记录每次客户端请求相关的任何状态数据，服务器无法确定2次请求之间的 联系，即使是前后2次同一个浏览器也没有任何数据能够判断出是同一个浏览器的请求。后来可以 通过cookie、session来判断。</p>
</li>
</ul>
<h3 id="Cookie技术"><a href="#Cookie技术" class="headerlink" title="Cookie技术"></a>Cookie技术</h3><ul>
<li>键值对信息 </li>
<li>是一种客户端、服务器端传递数据的技术 </li>
<li>一般来说cookie信息是在服务器端生成，返回给浏览器端的 </li>
<li>浏览器端可以保持这些值，浏览器对同一域发起每一请求时，都会把Cookie信息发给服务器端 </li>
<li>服务端收到浏览器端发过来的Cookie，处理这些信息，可以用来判断这次请求是否和之前的请求有 关联 </li>
</ul>
<p>曾经Cookie唯一在浏览器端存储数据的手段，目前浏览器端存储数据的方案很多，Cookie正在被淘汰。 </p>
<p>当服务器收到HTTP请求时，服务器可以在响应头里面添加一个Set-Cookie键值对。浏览器收到响应后通 常会保存这些Cookie，之后对该服务器每一次请求中都通过Cookie请求头部将Cookie信息发送给服务 器。 </p>
<p>另外，Cookie的过期时间、域、路径、有效期、适用站点都可以根据需要来指定。 可以使用 Set－Cookie:NAME=VALUE；Expires=DATE；Path=PATH；Domain=DOMAIN_NAME；SECURE </p>
<p>例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie:aliyungf_tc=AQAAAJDwJ3Bu8gkAHbrHb4zlNZGw4Y; Path=/; HttpOnly</span><br><span class="line">set-cookie:test_cookie=CheckForPermission; expires=Tue, <span class="number">19</span>-Mar<span class="number">-2018</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">02</span> GMT; path=/; domain=.doubleclick.net</span><br><span class="line"></span><br><span class="line">Set-Cookie: BD_HOME=<span class="number">1</span>; path=/</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">key</th>
<th align="center">value说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Cookie过期</td>
<td align="center">Cookie可以设定过期终止时间，过期后将被浏览器清除。<br> 如果缺省，Cookie不会持久化，浏览器关闭Cookie消失，称为会话级Cookie</td>
</tr>
<tr>
<td align="center">Cookie域</td>
<td align="center">域确定有哪些域可以存取这个Cookie。 <br>缺省设置属性值为当前主机，例如 <a href="http://www.magedu.com" target="_blank" rel="noopener">www.magedu.com</a> 。 <br>如果设置为 magedu.com 表示包含子域</td>
</tr>
<tr>
<td align="center">Path</td>
<td align="center">确定哪些目录及子目录访问可以使用该Cookie</td>
</tr>
<tr>
<td align="center"><strong>Secure</strong></td>
<td align="center">表示Cookie随着HTTPS加密过得请求发送给服务端<br> 有些浏览器已经不允许http://协议使用Secure了 这个Secure不能保证Cookie是安全的，Cookie中不要传输敏感信息</td>
</tr>
<tr>
<td align="center">HttpOnly</td>
<td align="center">将Cookie设置此标记，就不能被JavaScript访问，只能发给服务器端</td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: id=a3fWa; Expires=Wed, <span class="number">21</span> Oct <span class="number">2015</span> <span class="number">07</span>:<span class="number">28</span>:<span class="number">00</span> GMT; Secure; HttpOnly</span><br><span class="line">告诉浏览器端设置这个Cookie的键值对，有过期时间，使用HTTPS加密传输到服务器端，且不能被浏览器中JS脚本访问该Cookie</span><br><span class="line"></span><br><span class="line">Cookie的作用域：Domain和Path定义Cookie的作用域</span><br><span class="line"></span><br><span class="line">Domain</span><br><span class="line">domain=www.magedu.com 表示只有该域的URL才能使用</span><br><span class="line">domain=magedu.com 表示可以包含子域，例如www.magedu.com、python.magedu.com等</span><br><span class="line"></span><br><span class="line">Path</span><br><span class="line">path=/ 所有/的子路径可以使用</span><br><span class="line">domain=www.magedu.com; path=/webapp 表示只有www.magedu.com/webapp下的URL匹配，例</span><br><span class="line">如http://www.magedu.com/webapp/a.html就可以</span><br></pre></td></tr></table></figure>

<p>缺点</p>
<ul>
<li>Cookie一般明文传输（Secure是加密传输），安全性极差，不要传输敏感数据 </li>
<li>有4kB大小限制 </li>
<li>每次请求中都会发送Cookie，增加了流量</li>
</ul>
<h3 id="其它持久化技术"><a href="#其它持久化技术" class="headerlink" title="其它持久化技术"></a>其它持久化技术</h3><p>LocalStorage</p>
<ul>
<li>浏览器端持久化方案之一，HTML5标准增加的技术 </li>
<li>依然采用键值对存储数据</li>
<li>数据会存储在不同的域名下面</li>
<li>不同浏览器对单个域名下存储数据的长度支持不同，有的最多支持2MB。</li>
</ul>
<p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage" target="_blank" rel="noopener">https://developer.mozilla.org/zh-CN/docs/Web/API/Window/localStorage</a></p>
<p>SessionStorage和LocalStorage差不多，它是会话级的，浏览器关闭，会话结束，数据清除。</p>
<p>IndexedDB</p>
<ul>
<li>一个域一个datatable</li>
<li>key-valuede检索方式</li>
<li>建立在关系型的数据模型之上，具有索引表、游标、事务等概念</li>
</ul>
<h3 id="Session技术"><a href="#Session技术" class="headerlink" title="Session技术"></a>Session技术</h3><p>WEB 服务器端，尤其是动态网页服务端Server，有时需要知道浏览器方是谁?但是HTTP是无状态的，怎么办? </p>
<p>服务端会为每一次浏览器端第一次访问生成一个SessionID，用来唯一标识该浏览器，通过响应报文的Set-Cookie发送到浏览器端。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie:SESSIONID=<span class="number">741248</span>A52EEB83DF182009912A4ABD86.Tomcat1;Path=/; HttpOnly</span><br></pre></td></tr></table></figure>

<p>浏览器端收到之后并不永久保持这个Cookie，可以是会话级的。浏览器访问服务端时，会使用与请求域 相关的Cookies，也会带上这个SessionID的Cookie值。</p>
<p>动态网页技术，也需要知道用户身份，但是HTTP是无状态协议，无法知道。必须提出一种技术，让客户 端提交的信息可以表明身份。只能是服务端发出一个凭证，即SessionID，让浏览器端每次请求时发出 Cookies的同时带上这个SessionID，且过期作废，浏览器还不能更改。这个技术为了给浏览器发凭证就 使用了现有的Cookie技术。</p>
<p>服务端会维持这个SessionID一段时间，如果超时，会清理这些超时没有人访问的SessionID。如果浏览 器端发来的SessionID无法在服务端找到，就会自动再次分配新的SessionID，并通过Set-Cookie发送到 浏览器端以覆盖原有的存在浏览器中的会话级的SessionID。</p>
<p>也就是说服务器端会为浏览器端在内存开辟空间保存SessionID，同时和这个SessionID关联存储更多键 值对。这种为客户端在服务端维护相关状态数据的技术，就是Session技术。</p>
<p><strong>推荐图书《HTTP权威指南》</strong></p>
<p>Session开启后，会为浏览器端设置一个Cookie值，即SessionID。 这个SessionID的Cookie如果是会话级的，浏览器不做持久化存储只放在内存中，并且浏览器关闭自动 清除。 浏览器端发起HTTP请求后，这个SessionID会通过Cookie发到服务器端，服务器端就可以通过这个ID查 到对应的一个字典结构。如果查无此ID，就为此浏览器重新生成一个SessionID，为它建立一个 SessionID和空字典的映射关系。</p>
<p>可以在这个SessionID关联的字典中，存入键值对来保持与当前会话相关的更多信息</p>
<ul>
<li>Session会定期过期清除</li>
<li>Session占用服务器端内存</li>
<li>Session如果没有持久化，如果服务程序崩溃，那么所有Session信息丢失</li>
<li>Session可以持久化到数据库中，如果服务程序崩溃，那么可以从数据库中恢复</li>
</ul>
<h4 id="开启session支持"><a href="#开启session支持" class="headerlink" title="开启session支持"></a>开启session支持</h4><p>Django可以使用Session</p>
<ul>
<li>在 settings 中，MIDDLEWARE 设置中，启用 ‘django.contrib.sessions.middleware.SessionMiddleware’ </li>
<li>INSTALLED_APPS 设置中，启用 ‘django.contrib.sessions’。它是基于数据库存储的 Session </li>
<li>Session 不使用，可以关闭上述配置，以减少开销 </li>
<li>在数据库的表中的 django_session 表，记录 session 信息。但可以使用文件系统或其他 cache 来存储</li>
</ul>
<h4 id="session清除"><a href="#session清除" class="headerlink" title="session清除"></a>session清除</h4><p>登录成功，为当前session在django_session表中增加一条记录，如果没有显式调用logout函数或</p>
<p>request.session.flush()，那么该记录不会消失。Django也没有自动清除失效记录的功能。 request.session.flush()会清除当前session，同时删除表记录。 但Django提供了一个命令clearsessions，建议放在cron中定期执行。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ django-admin.py clearsessions</span><br><span class="line">$ manage.py clearsessions</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpRequest, HttpResponse</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_index</span><span class="params">(request:HttpRequest)</span>:</span> </span><br><span class="line">		<span class="string">'''cookie和session测试'''</span></span><br><span class="line">		print(<span class="string">'~'</span> * <span class="number">30</span>) </span><br><span class="line">    print(request.session.get(<span class="string">'abc'</span>))</span><br><span class="line">		res = HttpResponse(<span class="string">'test'</span>) </span><br><span class="line">    res.cookies[<span class="string">'tttt'</span>] = <span class="string">'vvvvvv'</span> </span><br><span class="line">    print(request.session.keys()) <span class="comment"># SessionStore import random</span></span><br><span class="line">    request.session[<span class="string">'abc'</span>] = str(random.randint(<span class="number">100</span>, <span class="number">200</span>))</span><br><span class="line">    print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  </span><br><span class="line"><span class="keyword">from</span> django.contrib.sessions.models <span class="keyword">import</span> Session</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用sessionid查询数据库中session相关的数据</span></span><br><span class="line">s = Session.objects.get(pk=<span class="string">'m600uyia87y0imcn6ghwfv79hgotyf4r'</span>) </span><br><span class="line">print(s.expire_date)</span><br><span class="line">print(s.session_data) <span class="comment"># 序列化后的数据</span></span><br><span class="line">print(s.get_decoded())</span><br></pre></td></tr></table></figure>

<h2 id="DRF及序列化器原理"><a href="#DRF及序列化器原理" class="headerlink" title="DRF及序列化器原理"></a>DRF及序列化器原理</h2><p>DRF(Django Rest Framework)是可以快速基于Restful开发的Django应用的插件，功能非常多，被广 泛应用。</p>
<p><strong>安装</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ pip install djangorestframework</span><br></pre></td></tr></table></figure>

<p>Django 需要 2.2+ </p>
<p><strong>注册</strong></p>
<p>settings.py中增加</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">'rest_framework'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="序列化器"><a href="#序列化器" class="headerlink" title="序列化器"></a>序列化器</h3><p>采用前后端分离后 </p>
<ul>
<li>序列化:后端发给前端的数据就是Json，核心就是把数据结构序列化成Json发给浏览器端<ul>
<li>字典 =&gt; Json字符串</li>
<li>更进一步，实例 =&gt; 字典，字典交给Response类序列化成Json </li>
</ul>
</li>
<li>反序列化:前端发给后端的数据依然是request请求，但是提交的数据是Json，需要反序列化<ul>
<li>Json字符串 =&gt; 字典 一般建议使用字典包封装数据。</li>
</ul>
</li>
</ul>
<h3 id="序列化器类"><a href="#序列化器类" class="headerlink" title="序列化器类"></a>序列化器类</h3><p>参考：<a href="https://www.django-rest-framework.org/api-guide/serializers/" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/serializers/</a> </p>
<p>rest_framework.serializers.BaseSerializer是序列化器类的基类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseSerializer</span><span class="params">(Field)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, instance=None, data=empty, **kwargs)</span>:</span></span><br><span class="line">        self.instance = instance <span class="comment"># 如果送第一个参数表示实例， </span></span><br><span class="line">        <span class="keyword">if</span> data <span class="keyword">is</span> <span class="keyword">not</span> empty:</span><br><span class="line">        		self.initial_data = data <span class="comment">#</span></span><br><span class="line">        self.partial = kwargs.pop(<span class="string">'partial'</span>, <span class="literal">False</span>) </span><br><span class="line">        self._context = kwargs.pop(<span class="string">'context'</span>, &#123;&#125;) </span><br><span class="line">        kwargs.pop(<span class="string">'many'</span>, <span class="literal">None</span>) <span class="comment"># many表示数据是多个还是一个 </span></span><br><span class="line">        super().__init__(**kwargs)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_valid</span><span class="params">(self, raise_exception=False)</span>:</span> </span><br><span class="line">  	<span class="string">"""反序列化时校验数据，也就是对浏览器端提交的数据进行验证"""</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">		<span class="keyword">if</span> hasattr(self, <span class="string">'initial_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_validated_data'</span>):  <span class="comment"># 如果有浏览器提交数据但没有校验过数据，先调用is_valid()校验</span></span><br><span class="line">		msg = (</span><br><span class="line">    		<span class="string">'When a serializer is passed a `data` keyword argument you '</span></span><br><span class="line">        <span class="string">'must call `.is_valid()` before attempting to access the '</span></span><br><span class="line">        <span class="string">'serialized `.data` representation.\n'</span></span><br><span class="line">        <span class="string">'You should either call `.is_valid()` first, '</span></span><br><span class="line">        <span class="string">'or access `.initial_data` instead.'</span></span><br><span class="line">     )</span><br><span class="line">     <span class="keyword">raise</span> AssertionError(msg)</span><br><span class="line">     <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_data'</span>): <span class="comment"># 没有_data立即开始计算</span></span><br><span class="line">     		<span class="keyword">if</span> self.instance <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> <span class="keyword">not</span> getattr(self, <span class="string">'_errors'</span>, <span class="string">'_errors'</span>, <span class="literal">None</span>):</span><br><span class="line">        		<span class="comment"># 序列化。有实例，没有错误</span></span><br><span class="line">        		self._data = self.to_representation(self.instance)</span><br><span class="line">        <span class="keyword">elif</span> hasattr(self, <span class="string">'_validated_data'</span>) <span class="keyword">and</span> <span class="keyword">not</span> getattr(self,                                                                                                          </span><br><span class="line">        		<span class="comment"># 反序列化。is_valid()校验后的数据(提交的数据被验证过了)且无错误 </span></span><br><span class="line">            self._data = self.to_representation(self.validated_data)</span><br><span class="line">         <span class="keyword">else</span>: <span class="comment"># 否则?</span></span><br><span class="line">          	self._data = self.get_initial()</span><br><span class="line">		<span class="keyword">return</span> self._data</span><br><span class="line"></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validated_data</span><span class="params">(self)</span>:</span> </span><br><span class="line">		<span class="string">"""校验后获取反序列化的数据"""</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Serializer</span><span class="params">(BaseSerializer, metaclass=SerializerMetaclass)</span>:</span></span><br><span class="line"><span class="meta">		@property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">    		ret = super().data</span><br><span class="line">    		<span class="keyword">return</span> ReturnDict(ret, serializer=self) <span class="comment"># OrderedDict</span></span><br></pre></td></tr></table></figure>

<h3 id="序列化器原理"><a href="#序列化器原理" class="headerlink" title="序列化器原理"></a>序列化器原理</h3><h4 id="序列化器-1"><a href="#序列化器-1" class="headerlink" title="序列化器"></a>序列化器</h4><p>在应用目录下构建serializers.py，根据Model类Employee编写EmpSerializer。 需要什么字段就在EmpSerializer中定义什么属性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    emp_no = serializers.IntegerField()</span><br><span class="line">    birth_date = serializers.DateField()</span><br><span class="line">    first_name = serializers.CharField(max_length=<span class="number">14</span>) <span class="comment"># max_length反序列化验证用</span></span><br><span class="line">    last_name = serializers.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    gender = serializers.ChoiceField(choices=Employee.Gender.choices)</span><br><span class="line">    hire_date = serializers.DateField()</span><br><span class="line">    </span><br><span class="line">print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">print(EmpSerializer())</span><br><span class="line">print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<h4 id="序列化"><a href="#序列化" class="headerlink" title="序列化"></a>序列化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects <span class="comment"># 单个对象</span></span><br><span class="line">emp = emgr.get(pk=<span class="number">10010</span>) print(emp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给实例准备序列化为Json字符串</span></span><br><span class="line">serializer = EmpSerializer(instance=emp) </span><br><span class="line">data = serializer.data <span class="comment"># 序列化 </span></span><br><span class="line">print(type(data), data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询集，多个实例，使用many</span></span><br><span class="line">emps = emgr.filter(pk__gt=<span class="number">10017</span>) </span><br><span class="line">print(*emps)</span><br><span class="line">serializer = EmpSerializer(emps, many=<span class="literal">True</span>) </span><br><span class="line">data = serializer.data</span><br><span class="line">print(type(data), data) <span class="comment"># 列表套着字典</span></span><br></pre></td></tr></table></figure>

<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line"><span class="comment"># POST方法提交上来的数据被request封装为字典 </span></span><br><span class="line">data = &#123;</span><br><span class="line">		<span class="string">'emp_no'</span>: <span class="number">10010</span>, </span><br><span class="line">  	<span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>,</span><br><span class="line">    <span class="string">'first_name'</span>: <span class="string">'Duangkaew'</span>, </span><br><span class="line">    <span class="string">'last_name'</span>: <span class="string">'Piveteau'</span>,</span><br><span class="line">    <span class="string">'gender'</span>: <span class="string">'2'</span>, </span><br><span class="line">  	<span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span></span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># gender的2故意使用了字符串</span></span><br><span class="line">serializer = EmpSerializer(data=data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(serializer.data) # 没有调用.is_valid()直接报错，第一步需要验证 </span></span><br><span class="line">validated = serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># is_valid方法调用内部成功会把数据放在_validated_data属性</span></span><br><span class="line"><span class="comment"># raise_exception验证失败是否抛异常</span></span><br><span class="line">print(validated)</span><br><span class="line">print(serializer.data)</span><br></pre></td></tr></table></figure>

<h3 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h3><p>对浏览器端提交的数据一定要校验，所以，<font color="red"><strong>校验是入库前必须要做的。</strong>  </font></p>
<p><strong>字段选项参数校验</strong></p>
<ul>
<li>字符串长度<ul>
<li>长度测试min_length和max_length</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">t1 = serializers.CharField(label=<span class="string">"长度限制和必须"</span>, min_length=<span class="number">4</span>, max_length=<span class="number">8</span>)</span><br><span class="line">测试 <span class="string">"t1"</span>: <span class="string">"ab"</span></span><br><span class="line">错误 &#123;<span class="string">'t1'</span>: [ErrorDetail(string=<span class="string">'Ensure this field has at least 4 characters.'</span>, code=<span class="string">'min_length'</span>)]&#125; </span><br><span class="line">注意，异常返回的[]列表，说明一个字段可以有多个校验器，这和前端开发校验一样</span><br></pre></td></tr></table></figure>

<ul>
<li>字段值是否必须<ul>
<li>字段默认require=True，也就是说必须提供</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">t1=serializers.CharField(label=<span class="string">"长度限制和必须"</span>,min_length=<span class="number">4</span>, max_length=<span class="number">8</span>)</span><br><span class="line">测试 Post的数据不提供t1</span><br><span class="line">错误 &#123;<span class="string">'t1'</span>: [ErrorDetail(string=<span class="string">'This field is required.'</span>,code=<span class="string">'required'</span>)]&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>只读<ul>
<li>read_only不校验该字段，只会出现在序列化中，仅仅只能给人看 </li>
<li>read_only和require不可以同时为True</li>
<li>read_only=True表示序列化时可以序列化t2这个属性的数据，反序列化不使用它，提供了值 也不校验也不输出，serializer.data输出结果中没有t2</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t2=serializers.CharField(read_only=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<ul>
<li>只写<ul>
<li>write_only=True，表示反序列化用，要校验。不会被序列化，不返回给浏览器</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">t3=serializers.CharField(write_only=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>对<strong>序列化器</strong>略作修改做测试，这个测试主要测试的是反序列化的校验</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    emp_no = serializers.IntegerField()</span><br><span class="line">    birth_date = serializers.DateField()</span><br><span class="line">    first_name = serializers.CharField(max_length=<span class="number">14</span>)</span><br><span class="line">    last_name = serializers.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    gender = serializers.ChoiceField(choices=Employee.Gender.choices)</span><br><span class="line">    hire_date = serializers.DateField()</span><br><span class="line">		t1 = serializers.CharField(label=<span class="string">"长度限制和必须"</span>, min_length=<span class="number">4</span>, max_length=<span class="number">8</span>)</span><br><span class="line">    t2 = serializers.CharField(read_only=<span class="literal">True</span>)</span><br><span class="line">    t3 = serializers.CharField(write_only=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects <span class="comment"># 单个对象</span></span><br><span class="line">emp = emgr.get(pk=<span class="number">10010</span>) print(emp.__dict__)</span><br><span class="line"><span class="comment"># 为序列化凑几个字段 </span></span><br><span class="line">emp.t1 = <span class="string">'t1'</span> </span><br><span class="line">emp.t2 = <span class="string">'t2'</span> </span><br><span class="line">emp.t3 = <span class="string">'t3'</span></span><br><span class="line"><span class="comment"># 给实例准备序列化为Json字符串</span></span><br><span class="line">serializer = EmpSerializer(instance=emp) </span><br><span class="line">data = serializer.data <span class="comment"># 序列化 print(data) # 字典</span></span><br></pre></td></tr></table></figure>

<p>序列化结果如下:</p>
<ul>
<li>序列化时，不校验t1 </li>
<li>t2是read_only，所以有它 </li>
<li>t3是write_only，不参与序列化，所以没有它</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'emp_no'</span>:<span class="number">10010</span>,<span class="string">'birth_date'</span>:<span class="string">'1963-06-01'</span>,<span class="string">'first_name'</span>:<span class="string">'Duangkaew'</span>, <span class="string">'last_name'</span>: <span class="string">'Piveteau'</span>, <span class="string">'gender'</span>: <span class="number">2</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>, <span class="string">'t1'</span>: <span class="string">'t1'</span>, <span class="string">'t2'</span>: <span class="string">'t2'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line"><span class="comment"># POST方法提交上来的数据被request封装为字典 </span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'emp_no'</span>: <span class="number">10010</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>,</span><br><span class="line">    <span class="string">'first_name'</span>: <span class="string">'Duangkaew'</span>, <span class="string">'last_name'</span>: <span class="string">'Piveteau'</span>,</span><br><span class="line">    <span class="string">'gender'</span>: <span class="string">"2"</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>,</span><br><span class="line">    <span class="string">'t1'</span>:<span class="string">'abcd'</span>,</span><br><span class="line">		<span class="string">'t2'</span>:<span class="string">'t2++'</span>, <span class="comment"># t2给不给无所谓</span></span><br><span class="line">		<span class="string">'t3'</span>:<span class="string">'t3=='</span></span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line">serializer = EmpSerializer(data=data)</span><br><span class="line"><span class="comment"># print(serializer.data) # 没有调用.is_valid()直接报错，第一步需要验证 </span></span><br><span class="line">validated = serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># is_valid方法调用内部成功会把数据放在_validated_data属性</span></span><br><span class="line"><span class="comment"># raise_exception验证失败是否抛异常</span></span><br><span class="line">print(validated)</span><br><span class="line">print(serializer.data)</span><br></pre></td></tr></table></figure>

<p>反序列化结果如下:</p>
<ul>
<li>校验t1</li>
<li>t2是read_only，所以没有它 </li>
<li>t3是write_only，反序列化必须有它，还要校验它</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">'emp_no'</span>: <span class="number">10010</span>, <span class="string">'birth_date'</span>: datetime.date(<span class="number">1963</span>, <span class="number">6</span>, <span class="number">1</span>), <span class="string">'first_name'</span>: <span class="string">'Duangkaew'</span>, <span class="string">'last_name'</span>: <span class="string">'Piveteau'</span>, <span class="string">'gender'</span>: <span class="number">2</span>, <span class="string">'hire_date'</span>: datetime.date(<span class="number">1989</span>, <span class="number">8</span>, <span class="number">24</span>), <span class="string">'t1'</span>: <span class="string">'abcd'</span>, <span class="string">'t3'</span>: <span class="string">'t3=='</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="字段级校验器"><a href="#字段级校验器" class="headerlink" title="字段级校验器"></a>字段级校验器</h4><p>参考：<a href="https://www.django-rest-framework.org/api-guide/serializers/#field-level-validation" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/serializers/#field-level-validation</a></p>
<p>这是针对某一个字段的校验，在序列化器类中增加validate_&lt;字段名&gt;方法，校验失败抛异常 serializers.ValidationError ，成功返回正确的值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    emp_no = serializers.IntegerField()</span><br><span class="line">    birth_date = serializers.DateField()</span><br><span class="line">    first_name = serializers.CharField() <span class="comment"># 使用单独字段的校验器 last_name = serializers.CharField(max_length=16)</span></span><br><span class="line">        gender = serializers.ChoiceField(choices=Employee.Gender.choices)</span><br><span class="line">        hire_date = serializers.DateField()</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">    		print(value, <span class="string">'+++++'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="number">4</span> &lt;= len(value) &lt;= <span class="number">14</span>:</span><br><span class="line">   		  		<span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">'The length must be between 4 and 14'</span>)</span><br></pre></td></tr></table></figure>

<p>还有一种写法，使用字段选项参数 validators=[validator, …]</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">validate_fn</span><span class="params">(value)</span>:</span></span><br><span class="line">    print(value, <span class="string">'+++++'</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="number">4</span> &lt;= len(value) &lt;= <span class="number">14</span>:</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    <span class="keyword">raise</span> serializers.ValidationError(<span class="string">'The length must be between 4 and 14'</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    emp_no = serializers.IntegerField()</span><br><span class="line">    birth_date = serializers.DateField()</span><br><span class="line">    first_name = serializers.CharField(validators=[validate_fn]) <span class="comment"># 使用校验器</span></span><br><span class="line">    last_name = serializers.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    gender = serializers.ChoiceField(choices=Employee.Gender.choices)</span><br><span class="line">    hire_date = serializers.DateField()</span><br></pre></td></tr></table></figure>

<p>除非有复用的必要，不要把校验器定义在外部。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>)</span><br><span class="line">django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line"><span class="comment"># POST方法提交上来的数据被request封装为字典</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'emp_no'</span>: <span class="number">10010</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>, <span class="string">'first_name'</span>: <span class="string">'Duangkaew'</span>, <span class="string">'last_name'</span>: <span class="string">'Piveteau'</span>, <span class="string">'gender'</span>: <span class="string">"2"</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>,</span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line">serializer = EmpSerializer(data=data)</span><br><span class="line"><span class="comment"># print(serializer.data) # 没有调用.is_valid()直接报错，第一步需要验证</span></span><br><span class="line">validated = serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"><span class="comment"># is_valid方法调用内部成功会把数据放在_validated_data属性</span></span><br><span class="line"><span class="comment"># raise_exception验证失败是否抛异常</span></span><br><span class="line">print(validated)</span><br><span class="line">print(serializer.data)</span><br></pre></td></tr></table></figure>

<h4 id="对象级校验器"><a href="#对象级校验器" class="headerlink" title="对象级校验器"></a>对象级校验器</h4><p>参考：<a href="https://www.django-rest-framework.org/api-guide/serializers/#object-level-validation" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/serializers/#object-level-validation</a> </p>
<p>对象级校验器就是对实例所有字段数据的校验</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    emp_no = serializers.IntegerField()</span><br><span class="line">    birth_date = serializers.DateField()</span><br><span class="line">    first_name = serializers.CharField() <span class="comment"># 使用校验器</span></span><br><span class="line">    last_name = serializers.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    gender = serializers.ChoiceField(choices=Employee.Gender.choices)</span><br><span class="line">    hire_date = serializers.DateField()</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_first_name</span><span class="params">(self, value)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="number">4</span> &lt;= len(value) &lt;= <span class="number">14</span>:</span><br><span class="line">            <span class="keyword">return</span> value</span><br><span class="line">        <span class="keyword">raise</span> serializers.ValidationError(<span class="string">'The length must be between 4 and 14'</span>)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate</span><span class="params">(self, data)</span>:</span></span><br><span class="line">        print(data, <span class="string">'===='</span>) <span class="comment"># 字典</span></span><br><span class="line">        last_name = data.get(<span class="string">'last_name'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="keyword">if</span> len(last_name) &lt; <span class="number">2</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">'The length must be greater than 1'</span>)</span><br><span class="line">        <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure>

<h3 id="入库"><a href="#入库" class="headerlink" title="入库"></a>入库</h3><p>参考：<a href="https://www.django-rest-framework.org/api-guide/serializers/#saving-instances" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/serializers/#saving-instances</a> </p>
<p>校验后的数据是安全的，可以写入数据库。</p>
<p>原理</p>
<p>BaseSerializer中定义了save方法 </p>
<ul>
<li>save()之前一定要.is_valid() </li>
<li>BaseSerializer(instance=None, data=empty)，无实例就是新增，调用create；有实例就是更新， 调用update。最终返回实例 </li>
<li>在BaseSerializer中，create、update是未实现的抽象方法，Serializer也没有实现这2个方法。言 下之意，就是需要用户自己实现。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    emp_no = serializers.IntegerField()</span><br><span class="line">    birth_date = serializers.DateField()</span><br><span class="line">    first_name = serializers.CharField(max_length=<span class="number">14</span>)</span><br><span class="line">    last_name = serializers.CharField(max_length=<span class="number">16</span>)</span><br><span class="line">    gender = serializers.ChoiceField(choices=Employee.Gender.choices)</span><br><span class="line">    hire_date = serializers.DateField()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 基类只负责调用create或update，但未实现</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(self, validated_data)</span>:</span></span><br><span class="line">        <span class="comment"># validated_data校验过的数据</span></span><br><span class="line">        <span class="comment"># 管理器实现了create方法完成数据新增</span></span><br><span class="line">        <span class="keyword">return</span> Employee.objects.create(**validated_data)</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(self, instance:Employee, validated_data)</span>:</span></span><br><span class="line">        instance.first_name = validated_data.get(<span class="string">'first_name'</span>, instance.first_name)</span><br><span class="line">        instance.last_name = validated_data.get(<span class="string">'last_name'</span>, instance.last_name)</span><br><span class="line">        instance.gender = validated_data.get(<span class="string">'gender'</span>, instance.gender)</span><br><span class="line">        instance.save()</span><br><span class="line">        <span class="keyword">return</span> instance</span><br></pre></td></tr></table></figure>

<p>增</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>)</span><br><span class="line">django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line"><span class="comment"># POST方法提交上来的数据被request封装为字典</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'emp_no'</span>: <span class="number">10021</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>, <span class="string">'first_name'</span>: <span class="string">'san'</span>, <span class="string">'last_name'</span>: <span class="string">'zhang'</span>, <span class="string">'gender'</span>: <span class="string">"1"</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>,</span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有data没有实例，是新增</span></span><br><span class="line">serializer = EmpSerializer(data=data)</span><br><span class="line">validated = serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#print(serializer.data) # save前不能调用data，只能使用validated_data查看</span></span><br><span class="line">serializer.save()</span><br><span class="line">print(serializer.data)</span><br></pre></td></tr></table></figure>

<p>改</p>
<p>先查再改：先查返回结果填充实例，然后根据这个实例修改数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>)</span><br><span class="line">django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10021</span>)</span><br><span class="line">print(emp)</span><br><span class="line"><span class="comment"># POST方法提交上来的数据被request封装为字典</span></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'emp_no'</span>: <span class="number">10021</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>, <span class="string">'first_name'</span>: <span class="string">'si'</span>, <span class="string">'last_name'</span>: <span class="string">'li'</span>, <span class="string">'gender'</span>: <span class="number">1</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>,</span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有实例，有data，是更新</span></span><br><span class="line">serializer = EmpSerializer(emp, data=data)</span><br><span class="line">validated = serializer.is_valid(raise_exception=<span class="literal">True</span>)</span><br><span class="line"><span class="comment">#print(serializer.data) # save前不能调用data，只能使用validated_data查看</span></span><br><span class="line">serializer.save()</span><br><span class="line">print(serializer.data)</span><br></pre></td></tr></table></figure>

<p>总结</p>
<ul>
<li>序列化 <ul>
<li>查库：查询数据库得到单个实例或多个实例 </li>
<li>构造序列化器实例：构造序列化器实例 </li>
<li>输出：使用data属性获取字典 </li>
</ul>
</li>
<li>反序列化 <ul>
<li>反序列化：将Json数据反序列化为字典 </li>
<li>构造序列化器实例：使用字典构造序列化器实例 </li>
<li>校验：调用is_valid方法校验各个字段的值 </li>
<li>入库：调用save方法</li>
</ul>
</li>
</ul>
<p>从前面的知识点可以明白DRF的基本原理，也感觉到了Serializer类比较简陋，很多东西都需要自己写代码。 可以观察到，序列化器字段定义和Model类中的严重重复，能否利用Model类来简化？ </p>
<p>所有的增、改都差不多，能否把create、update也实现了？</p>
<h2 id="ModelSerializer"><a href="#ModelSerializer" class="headerlink" title="ModelSerializer"></a>ModelSerializer</h2><p>参考：<a href="https://www.django-rest-framework.org/api-guide/serializers/#modelserializer" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/serializers/#modelserializer</a> </p>
<p>ModelSerializer是Serializer的子类除了具有Serializer的功能外:</p>
<ul>
<li>根据Model类，自动生成字段</li>
<li>为序列化器自动生成校验器</li>
<li>为序列化器提供了简单的create()和update()方法实现，所以可以直接save()</li>
</ul>
<h3 id="序列化器-2"><a href="#序列化器-2" class="headerlink" title="序列化器"></a>序列化器</h3><p>需要解决2个问题:</p>
<p>依照那个Model类 需要哪些字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line">print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">print(EmpSerializer())</span><br><span class="line">print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">EmpSerializer():</span><br><span class="line">emp_no = IntegerField(label=<span class="string">'工号'</span>, max_value=<span class="number">2147483647</span>,</span><br><span class="line">min_value=<span class="number">-2147483648</span>, validators=</span><br><span class="line">[&lt;UniqueValidator(queryset=Employee.objects.all())&gt;])</span><br><span class="line">    birth_date = DateField(label=<span class="string">'生日'</span>)</span><br><span class="line">    first_name = CharField(label=<span class="string">'名'</span>, max_length=<span class="number">14</span>)</span><br><span class="line">    last_name = CharField(label=<span class="string">'姓'</span>, max_length=<span class="number">16</span>)</span><br><span class="line">		gender = ChoiceField(choices=[(<span class="number">1</span>, <span class="string">'男'</span>), (<span class="number">2</span>, <span class="string">'女'</span>)], </span><br><span class="line">    label=<span class="string">'性别'</span>,</span><br><span class="line">validators=[&lt;django.core.validators.MinValueValidator object&gt;,</span><br><span class="line">&lt;django.core.validators.MaxValueValidator object&gt;])</span><br><span class="line">    hire_date = DateField()</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = [<span class="string">'emp_no'</span>, <span class="string">'first_name'</span>, <span class="string">'last_name'</span>] <span class="comment"># 指定字段</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        exclude = [<span class="string">'gender'</span>] <span class="comment"># 排除某些字段</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'hire_date'</span>] <span class="comment"># 单独指定readonly字段</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'hire_date'</span>] <span class="comment"># 单独指定readonly字段 </span></span><br><span class="line">        extra_kwargs = &#123;<span class="string">'gender'</span>: &#123;<span class="string">'write_only'</span>: <span class="literal">True</span>&#125;&#125;</span><br><span class="line">        <span class="comment"># 额外字段选项定义，gender为write_only</span></span><br></pre></td></tr></table></figure>

<h3 id="序列化-1"><a href="#序列化-1" class="headerlink" title="序列化"></a>序列化</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10010</span>)</span><br><span class="line">serializer = EmpSerializer(emp)</span><br><span class="line">print(serializer.data)</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">'emp_no'</span>: <span class="number">10010</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>, <span class="string">'first_name'</span>: <span class="string">'Duangkaew'</span>, <span class="string">'last_name'</span>: <span class="string">'Piveteau'</span>, <span class="string">'gender'</span>: <span class="number">2</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>&#125;</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emps = emgr.filter(pk__gt=<span class="number">10018</span>)</span><br><span class="line">serializer = EmpSerializer(emps, many=<span class="literal">True</span>) <span class="comment"># 多个 print(serializer.data)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[OrderedDict([(<span class="string">'emp_no'</span>, <span class="number">10019</span>), (<span class="string">'birth_date'</span>, <span class="string">'1953-01-23'</span>), (<span class="string">'first_name'</span>,<span class="string">'Lillian'</span>), (<span class="string">'last_name'</span>, <span class="string">'Haddadi'</span>), (<span class="string">'gender'</span>, <span class="number">1</span>), (<span class="string">'hire_date'</span>, <span class="string">'1999-04-30'</span>)]), OrderedDict([(<span class="string">'emp_no'</span>, <span class="number">10020</span>), (<span class="string">'birth_date'</span>,<span class="string">'1952-12-24'</span>),(<span class="string">'first_name'</span>, <span class="string">'Mayuko'</span>), (<span class="string">'last_name'</span>, <span class="string">'Warwick'</span>), (<span class="string">'gender'</span>, <span class="number">1</span>), (<span class="string">'hire_date'</span>, <span class="string">'1991-01-26'</span>)]), OrderedDict([(<span class="string">'emp_no'</span>, <span class="number">10021</span>), (<span class="string">'birth_date'</span>,<span class="string">'1963-06-01'</span>), (<span class="string">'first_name'</span>, <span class="string">'si'</span>), (<span class="string">'last_name'</span>, <span class="string">'li'</span>), (<span class="string">'gender'</span>, <span class="number">1</span>), (<span class="string">'hire_date'</span>, <span class="string">'1989-08-24'</span>)])]</span><br></pre></td></tr></table></figure>

<h3 id="反序列化-1"><a href="#反序列化-1" class="headerlink" title="反序列化"></a>反序列化</h3><p>ModelSerializer提供了create、update方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line">data = &#123;</span><br><span class="line">    <span class="string">'emp_no'</span>: <span class="number">10022</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>,</span><br><span class="line">    <span class="string">'first_name'</span>: <span class="string">'wu'</span>, <span class="string">'last_name'</span>: <span class="string">'wang'</span>,</span><br><span class="line">    <span class="string">'gender'</span>: <span class="number">1</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>,</span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 只有data，是新增</span></span><br><span class="line">serializer = EmpSerializer(data=data) </span><br><span class="line">serializer.is_valid(<span class="literal">True</span>)</span><br><span class="line">x = serializer.save() <span class="comment"># 返回持久化的实例 </span></span><br><span class="line">print(type(x), x)</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10022</span>) <span class="comment"># 查实例</span></span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">'emp_no'</span>: <span class="number">10022</span>, <span class="string">'birth_date'</span>: <span class="string">'1963-06-01'</span>, <span class="string">'first_name'</span>: <span class="string">'三'</span>, <span class="string">'last_name'</span>: <span class="string">'张'</span>, <span class="string">'gender'</span>: <span class="number">1</span>, <span class="string">'hire_date'</span>: <span class="string">'1989-08-24'</span>,</span><br><span class="line">&#125; <span class="comment"># 注意，这是字典数据是data，不是Employee的实例</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 有实例，有data，是更新</span></span><br><span class="line">serializer = EmpSerializer(emp, data=data) </span><br><span class="line">serializer.is_valid(<span class="literal">True</span>)</span><br><span class="line">x = serializer.save() <span class="comment"># 更新</span></span><br><span class="line">print(type(x), x) <span class="comment"># 返回实例</span></span><br></pre></td></tr></table></figure>

<h3 id="外键关系"><a href="#外键关系" class="headerlink" title="外键关系"></a>外键关系</h3><p>员工和工资，是一对多关系</p>
<h3 id="Model类"><a href="#Model类" class="headerlink" title="Model类"></a>Model类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line">		</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gender</span><span class="params">(models.IntegerChoices)</span>:</span> <span class="comment"># 枚举类型，限定取值范围</span></span><br><span class="line">		MAN = <span class="number">1</span>, <span class="string">'男'</span></span><br><span class="line">		FEMALE = <span class="number">2</span>, <span class="string">'女'</span> <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'employees'</span></span><br><span class="line">		verbose_name = <span class="string">'员工'</span></span><br><span class="line">		emp_no = models.IntegerField(primary_key=<span class="literal">True</span>, verbose_name=<span class="string">'工号'</span>) </span><br><span class="line">    birth_date = models.DateField(verbose_name=<span class="string">'生日'</span>)</span><br><span class="line">		first_name = models.CharField(max_length=<span class="number">14</span>, verbose_name=<span class="string">'名'</span>) </span><br><span class="line">    last_name = models.CharField(max_length=<span class="number">16</span>, verbose_name=<span class="string">'姓'</span>) </span><br><span class="line">    gender = models.SmallIntegerField(verbose_name=<span class="string">'性别'</span>, choices=Gender.choices)</span><br><span class="line">    hire_date = models.DateField()</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Salary</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">				db_table = <span class="string">"salaries"</span></span><br><span class="line">				<span class="comment">#id = models.AutoField(primary_key=True) # 额外增加的主键，Django不支持联合主键</span></span><br><span class="line">				emp_no = models.ForeignKey(Employee, on_delete=models.CASCADE, db_column=<span class="string">'emp_no'</span>, related_name=<span class="string">'salaries'</span>)</span><br><span class="line">				from_date = models.DateField()</span><br><span class="line">				salary = models.IntegerField(verbose_name=<span class="string">'工资'</span>) </span><br><span class="line">        to_date = models.DateField()</span><br></pre></td></tr></table></figure>

<h3 id="序列化器-3"><a href="#序列化器-3" class="headerlink" title="序列化器"></a>序列化器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee, Salary</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalarySerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Salary</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line">print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">print(EmpSerializer())</span><br><span class="line">print(SalarySerializer())</span><br><span class="line">print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br></pre></td></tr></table></figure>

<p>序列化器如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">EmpSerializer():</span><br><span class="line">    emp_no = IntegerField(label=<span class="string">'工号'</span>, max_value=<span class="number">2147483647</span>, min_value=<span class="number">-2147483648</span>, validators= [&lt;UniqueValidator(queryset=Employee.objects.all())&gt;])</span><br><span class="line">    birth_date = DateField(label=<span class="string">'生日'</span>)</span><br><span class="line">    first_name = CharField(label=<span class="string">'名'</span>, max_length=<span class="number">14</span>)</span><br><span class="line">    last_name = CharField(label=<span class="string">'姓'</span>, max_length=<span class="number">16</span>)</span><br><span class="line">    gender = ChoiceField(choices=[(<span class="number">1</span>, <span class="string">'男'</span>), (<span class="number">2</span>, <span class="string">'女'</span>)], label=<span class="string">'性别'</span>,</span><br><span class="line">    validators=[&lt;django.core.validators.MinValueValidator object&gt;,</span><br><span class="line">    &lt;django.core.validators.MaxValueValidator object&gt;])</span><br><span class="line">		hire_date = DateField()</span><br><span class="line">    </span><br><span class="line">SalarySerializer():</span><br><span class="line">		id = IntegerField(label=<span class="string">'ID'</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">		from_date = DateField()</span><br><span class="line">		salary = IntegerField(label=<span class="string">'工资'</span>, max_value=<span class="number">2147483647</span>, min_value=<span class="number">-2147483648</span>)</span><br><span class="line">    to_date = DateField()</span><br><span class="line">    emp_no = PrimaryKeyRelatedField(queryset=Employee.objects.all())</span><br></pre></td></tr></table></figure>

<p>SalarySerializer有一个外键关联</p>
<h3 id="序列化-2"><a href="#序列化-2" class="headerlink" title="序列化"></a>序列化</h3><h3 id="各自独立查询"><a href="#各自独立查询" class="headerlink" title="各自独立查询"></a>各自独立查询</h3><p>先查员工，再去查相关工资信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> django</span><br><span class="line"></span><br><span class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'salary.settings'</span>) django.setup(set_prefix=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有测试代码，都要在上面4行之下</span></span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer, SalarySerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10003</span>)</span><br><span class="line">print(EmpSerializer(emp).data)</span><br><span class="line">print(SalarySerializer(emp.salaries.all(), many=<span class="literal">True</span>).data)</span><br></pre></td></tr></table></figure>

<h3 id="关联主键"><a href="#关联主键" class="headerlink" title="关联主键"></a>关联主键</h3><p>参考：<a href="https://www.django-rest-framework.org/api-guide/relations/#primarykeyrelatedfield" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/relations/#primarykeyrelatedfield</a></p>
<p>直接获取所有<strong>关联pk</strong>，利用 serializers.PrimaryKeyRelatedField 来关联</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee, Salary</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">      	model = Employee</span><br><span class="line">				fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># salaries必须和Model类中的属性对应</span></span><br><span class="line">    salaries = serializers.PrimaryKeyRelatedField(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>) <span class="comment"># salaries =</span></span><br><span class="line">    serializers.PrimaryKeyRelatedField(queryset=Salary.objects.all(), many=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">SalarySerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">            model = Salary</span><br><span class="line">            fields = <span class="string">'__all__'</span></span><br><span class="line">            </span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer, SalarySerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10003</span>)</span><br><span class="line">print(EmpSerializer(emp).data)</span><br><span class="line"></span><br><span class="line">&#123;<span class="string">'emp_no'</span>: <span class="number">10003</span>, <span class="string">'salaries'</span>: [<span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>], <span class="string">'birth_date'</span>: <span class="string">'1959-12-03'</span>, <span class="string">'first_name'</span>: <span class="string">'Parto'</span>, <span class="string">'last_name'</span>: <span class="string">'Bamford'</span>, <span class="string">'gender'</span>: <span class="number">1</span>, <span class="string">'hire_date'</span>: <span class="string">'1986-08-28'</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关联字符串表达"><a href="#关联字符串表达" class="headerlink" title="关联字符串表达"></a>关联字符串表达</h3><p>参考：<a href="https://www.django-rest-framework.org/api-guide/relations/#stringrelatedfield" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/relations/#stringrelatedfield</a></p>
<p>直接获取所有关联对象的字符串表达，需要用到 <strong>str</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee, Salary</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">    		model = Employee</span><br><span class="line">      	fields = <span class="string">'__all__'</span></span><br><span class="line">    <span class="comment"># salaries必须和Model类中的属性对应</span></span><br><span class="line">    salaries = serializers.StringRelatedField(many=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalarySerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Salary</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer, SalarySerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10003</span>)</span><br><span class="line">print(EmpSerializer(emp).data) <span class="comment"># 使用的是Salary模型类的__str__</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span></span><br><span class="line">&#123;<span class="string">'emp_no'</span>: <span class="number">10003</span>, <span class="string">'salaries'</span>: [<span class="string">'&lt;S 24, 10003, 40006&gt;'</span>, <span class="string">'&lt;S 25, 10003, 43616&gt;'</span>, <span class="string">'&lt;S 26, 10003, 43466&gt;'</span>, <span class="string">'&lt;S 27, 10003, 43636&gt;'</span>, <span class="string">'&lt;S 28, 10003, 43478&gt;'</span>, <span class="string">'&lt;S 29, 10003, 43699&gt;'</span>, <span class="string">'&lt;S 30, 10003, 43311&gt;'</span>], <span class="string">'birth_date'</span>: <span class="string">'1959-12-03'</span>, <span class="string">'first_name'</span>: <span class="string">'Parto'</span>, <span class="string">'last_name'</span>: <span class="string">'Bamford'</span>, <span class="string">'gender'</span>: <span class="number">1</span>, <span class="string">'hire_date'</span>: <span class="string">'1986-08-28'</span>&#125;</span><br></pre></td></tr></table></figure>

<h3 id="关联对象"><a href="#关联对象" class="headerlink" title="关联对象"></a>关联对象</h3><p>参考：<a href="https://www.django-rest-framework.org/api-guide/relations/#nested-relationships" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/relations/#nested-relationships</a></p>
<p>如果需要更加完整的关联数据，可以使用关联对象的方式，要利用对方的序列化器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee, Salary</span><br><span class="line"></span><br><span class="line"><span class="comment"># 颠倒一下序列化器的定义次序</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalarySerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Salary</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">				fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line">    <span class="comment"># salaries必须和Model类中的属性对应</span></span><br><span class="line">    salaries = SalarySerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line"><span class="keyword">from</span> employee.models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> employee.serializers <span class="keyword">import</span> EmpSerializer, SalarySerializer</span><br><span class="line"></span><br><span class="line">emgr = Employee.objects</span><br><span class="line">emp = emgr.get(pk=<span class="number">10003</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line">print(json.dumps(EmpSerializer(emp).data))</span><br></pre></td></tr></table></figure>

<p>返回的数据序列化成Json格式如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">		<span class="string">"emp_no"</span>:<span class="number">10003</span>,</span><br><span class="line">    <span class="string">"salaries"</span>:[</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">24</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"1995-12-03"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">40006</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"1996-12-02"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">        &#125;, &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">25</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"1996-12-02"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">43616</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"1997-12-02"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">26</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"1997-12-02"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">43466</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"1998-12-02"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">27</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"1998-12-02"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">43636</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"1999-12-02"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">28</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"1999-12-02"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">43478</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"2000-12-01"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">29</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"2000-12-01"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">43699</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"2001-12-01"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">       &#125;,</span><br><span class="line">       &#123;</span><br><span class="line">            <span class="string">"id"</span>:<span class="number">30</span>,</span><br><span class="line">            <span class="string">"from_date"</span>:<span class="string">"2001-12-01"</span>,</span><br><span class="line">            <span class="string">"salary"</span>:<span class="number">43311</span>,</span><br><span class="line">            <span class="string">"to_date"</span>:<span class="string">"9999-01-01"</span>,</span><br><span class="line">            <span class="string">"emp_no"</span>:<span class="number">10003</span></span><br><span class="line">       &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"birth_date"</span>:<span class="string">"1959-12-03"</span>,</span><br><span class="line">    <span class="string">"first_name"</span>:<span class="string">"Parto"</span>,</span><br><span class="line">    <span class="string">"last_name"</span>:<span class="string">"Bamford"</span>,</span><br><span class="line">    <span class="string">"gender"</span>:<span class="number">1</span>,</span><br><span class="line">    <span class="string">"hire_date"</span>:<span class="string">"1986-08-28"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="DRF视图"><a href="#DRF视图" class="headerlink" title="DRF视图"></a>DRF视图</h2><p><strong>请求传参</strong></p>
<p>利用HTTP请求报文传递参数有3种方式</p>
<ol>
<li>查询字符串，GET方法，参数在URL中， <a href="http://127.0.0.1:8000/emp/?x=123&amp;x=abc&amp;y=789" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/?x=123&amp;x=abc&amp;y=789</a> </li>
<li>表单，前端网页中填写表单，一般使用POST方法，参数在body中</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST /xxx/yyy?id=5&amp;name=magedu HTTP/1.1</span><br><span class="line">HOST: <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">9999</span></span><br><span class="line">content-length: <span class="number">26</span></span><br><span class="line">content-type: application/x-www-form-urlencoded</span><br><span class="line"></span><br><span class="line">age=<span class="number">5</span>&amp;weight=<span class="number">80</span>&amp;height=<span class="number">170</span></span><br></pre></td></tr></table></figure>

<p>也可以POST、PUT提交Json格式数据</p>
<ol start="3">
<li>URL本身就是数据的表达， <a href="http://127.0.0.1:8080/python/2010/u101" target="_blank" rel="noopener">http://127.0.0.1:8080/python/2010/u101</a></li>
</ol>
<h3 id="APIView"><a href="#APIView" class="headerlink" title="APIView"></a>APIView</h3><p>在Django中，View是视图类基类，路由配置中需要把类通过as_view()伪装成视图函数，请求通过路由 进入到这个视图函数中，内部为每一个请求实例化一个视图类实例，并根据request.method找到对应的 handler。而这个基本流程已经被View类固定在其内部，我们只需要定义get、post等方法即可，简化了 编程。</p>
<p>使用DRF，基于Django，也要使用View类。请求参数是Json格式，先要序列化它，然后验证，验证合格 可以入库。响应的数据应该序列化成Json格式。你会发现这也是固定的套路，是否也能够简化呢?</p>
<p>参考 <a href="https://www.django-rest-framework.org/api-guide/views/" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/views/</a> </p>
<p>APIView</p>
<ul>
<li>as_view()调用基类View的，但是使用了csrf_exempt(view)来排除CSRF保护 </li>
<li>重新定义了Request类来替代Django的，虽是重写，但是依然有联系 </li>
<li>重新定义了Response类来增强替代Django的 </li>
<li>异常类都是基于APIException类的</li>
</ul>
<p>对请求进行认证和授权 APIView没有提供增删改查的handler方法，也就是说和View一样，需要自己定义get、post、put、delete方法。</p>
<h4 id="GET请求测试"><a href="#GET请求测试" class="headerlink" title="GET请求测试"></a>GET请求测试</h4><p>GET请求：<a href="http://127.0.0.1:8000/emp/?x=123&amp;x=abc&amp;y=789" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/?x=123&amp;x=abc&amp;y=789</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestIndex</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">        print(request.method) <span class="comment"># HttpRequest的属性 print(request.GET) # HttpRequest的属性 print(request.query_params) # Request的属性，使用小写的 print(request.content_type)</span></span><br><span class="line">        print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;&#125;)</span><br><span class="line">      </span><br><span class="line">GET</span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'x'</span>: [<span class="string">'123'</span>, <span class="string">'abc'</span>], <span class="string">'y'</span>: [<span class="string">'789'</span>]&#125;&gt;</span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'x'</span>: [<span class="string">'123'</span>, <span class="string">'abc'</span>], <span class="string">'y'</span>: [<span class="string">'789'</span>]&#125;&gt;</span><br><span class="line">text/plain</span><br></pre></td></tr></table></figure>

<p>QueryDict本质就是字典，对于同一个参数有多值情况使用了列表。</p>
<h4 id="POST请求测试"><a href="#POST请求测试" class="headerlink" title="POST请求测试"></a>POST请求测试</h4><p>POST请求：<a href="http://127.0.0.1:8000/emp/?x=123&amp;x=abc&amp;y=789" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/?x=123&amp;x=abc&amp;y=789</a> </p>
<h4 id="采用表单提交方式"><a href="#采用表单提交方式" class="headerlink" title="采用表单提交方式"></a>采用表单提交方式</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestIndex</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">        print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">        print(request.method)</span><br><span class="line">        print(request.GET)</span><br><span class="line">        print(request.query_params)</span><br><span class="line">        print(request.content_type)</span><br><span class="line">        print(request.POST)</span><br><span class="line">        print(request.data)</span><br><span class="line">        print(<span class="string">'~'</span> * <span class="number">30</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(&#123;&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207215355168.png" alt="image-20230207215355168"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b'm=111&amp;n=222&amp;t=333'</span> 这是request报文的body的原始数据</span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'x'</span>: [<span class="string">'123'</span>, <span class="string">'abc'</span>], <span class="string">'y'</span>: [<span class="string">'789'</span>]&#125;&gt; </span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'x'</span>: [<span class="string">'123'</span>, <span class="string">'abc'</span>], <span class="string">'y'</span>: [<span class="string">'789'</span>]&#125;&gt; application/x-www-form-urlencoded 表单提交的方法 </span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'m'</span>: [<span class="string">'111'</span>], <span class="string">'n'</span>: [<span class="string">'222'</span>], <span class="string">'t'</span>: [<span class="string">'333'</span>]&#125;&gt; </span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'m'</span>: [<span class="string">'111'</span>], <span class="string">'n'</span>: [<span class="string">'222'</span>], <span class="string">'t'</span>: [<span class="string">'333'</span>]&#125;&gt;</span><br></pre></td></tr></table></figure>

<h4 id="Json数据"><a href="#Json数据" class="headerlink" title="Json数据"></a>Json数据</h4><p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207215422255.png" alt="image-20230207215422255"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b'&#123;\r\n    "a":123,\r\n    "b":"abc",\r\n    "c":true,\r\n    "d":null\r\n&#125;'</span></span><br><span class="line">text/plain</span><br><span class="line"></span><br><span class="line">Unsupported Media Type: /emp/</span><br></pre></td></tr></table></figure>

<p>说明上例解析失败，原因就是类型选择了Text，改为Json</p>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_sre/image-20230207215500341.png" alt="image-20230207215500341"></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">b'&#123;\r\n    "a": 123,\r\n    "b": "abc",\r\n    "c": true,\r\n    "d":</span></span><br><span class="line"><span class="string">null\r\n&#125;'</span></span><br><span class="line"></span><br><span class="line">POST</span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'x'</span>: [<span class="string">'123'</span>, <span class="string">'abc'</span>], <span class="string">'y'</span>: [<span class="string">'789'</span>]&#125;&gt;</span><br><span class="line">&lt;QueryDict: &#123;<span class="string">'x'</span>: [<span class="string">'123'</span>, <span class="string">'abc'</span>], <span class="string">'y'</span>: [<span class="string">'789'</span>]&#125;&gt;</span><br><span class="line">application/json</span><br><span class="line">&lt;QueryDict: &#123;&#125;&gt;</span><br><span class="line">&#123;<span class="string">'a'</span>: <span class="number">123</span>, <span class="string">'b'</span>: <span class="string">'abc'</span>, <span class="string">'c'</span>: <span class="literal">True</span>, <span class="string">'d'</span>: <span class="literal">None</span>&#125;</span><br></pre></td></tr></table></figure>

<h4 id="请求总结"><a href="#请求总结" class="headerlink" title="请求总结"></a>请求总结</h4><ul>
<li>GET请求，查询字符串使用query_params提取 </li>
<li>POST请求，访问data属性<ul>
<li>支持了POST、PUT、PATCH方法(增、改) </li>
<li>统一将请求处理放到data属性中 </li>
<li>如果是Json数据，帮我们序列化</li>
</ul>
</li>
</ul>
<h3 id="响应"><a href="#响应" class="headerlink" title="响应"></a>响应</h3><p>DRF对Django的响应类也做了增强，使用更加简单方便。</p>
<p><code>Response(data=None, status=None, template_name=None, headers=None,content_type=None)</code></p>
<ul>
<li>兼具了模板渲染的能力 </li>
<li>data将要序列化的数据，例如字典 </li>
<li>staus状态码，默认200 </li>
<li>headers响应报文头，字典 </li>
<li>content_type响应内容类型，有时候需要手动设置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestIndex</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request:Request)</span>:</span></span><br><span class="line">				print(request.query_params) <span class="comment"># Request的属性，使用小写的 return Response(&#123;&#125;)</span></span><br><span class="line">        </span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request:Request)</span>:</span> print(request.query_params) <span class="comment"># Request的属性，使用小写的 print(request.data) # Request的属性，使用小写的 </span></span><br><span class="line">    		<span class="keyword">return</span> Response(&#123;</span><br><span class="line">            <span class="string">'host'</span>:<span class="string">'python'</span>, <span class="string">'domain'</span>:<span class="string">'magedu.com'</span></span><br><span class="line">        &#125;, status=<span class="number">201</span>, headers=&#123;<span class="string">'X-Server'</span>:<span class="string">'Magedu'</span>&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h3><p>需要构建2个类</p>
<ul>
<li>列表页，返回列表和新增功能 </li>
<li>详情页，基于主键的查看详情、修改、删除</li>
</ul>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> EmpsView, EmpView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, EmpsView.as_view()), <span class="comment"># /emp/</span></span><br><span class="line">    path(<span class="string">'&lt;int:pk&gt;/'</span>, EmpView.as_view()), <span class="comment"># /emp/10021/</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="列表页"><a href="#列表页" class="headerlink" title="列表页"></a>列表页</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpsView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""实现列表页get、新增post http://127.0.0.1:8000/emp/ """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">            <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h4 id="详情页"><a href="#详情页" class="headerlink" title="详情页"></a>详情页</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""实现详情页get、修改put、删除delete http://127.0.0.1:8000/emp/10021 """</span></span><br><span class="line">		<span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">    		<span class="keyword">pass</span></span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<h2 id="异常处理-☆☆☆☆☆"><a href="#异常处理-☆☆☆☆☆" class="headerlink" title="异常处理(☆☆☆☆☆)"></a>异常处理(☆☆☆☆☆)</h2><p>参考：<a href="https://www.django-rest-framework.org/api-guide/exceptions/" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/exceptions/</a> </p>
<p>测试<a href="http://127.0.0.1:8000/emp/100，返回500服务器内部错误。" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/100，返回500服务器内部错误。</a></p>
<p>按平常做法，就应该出什么问题，返回什么出错信息。但这样做会有安全风险，且在浏览器端的普通用 户根本不管什么错误，就认为网站出问题了。所以，返回更加友好的出错页面是有必要的，例如更换 404页面。</p>
<p>我们的项目采用前后端分离，返回出错页面不合适，需要返回Json格式的出错信息，有必要拦截所有的 异常做处理。</p>
<h3 id="异常全局配置"><a href="#异常全局配置" class="headerlink" title="异常全局配置"></a>异常全局配置</h3><p>自定义全局异常处理器，参考 rest_framework.views.exception_handler 实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'EXCEPTION_HANDLER'</span>: <span class="string">'utils.exceptions.global_exception_handler'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全局异常处理"><a href="#全局异常处理" class="headerlink" title="全局异常处理"></a>全局异常处理</h3><p>exception_handler会转化Django的Http404、PermissionDenied为DRF的基于APIException的类。 项目根目录下新建包utils，其中新建模块exceptions.py，内容如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> PermissionDenied</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> set_rollback</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> exceptions</span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> Response, exception_handler</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MagBaseException</span><span class="params">(exceptions.APIException)</span>:</span> </span><br><span class="line">		<span class="string">"""基类定义基本的异常"""</span></span><br><span class="line">		code = <span class="number">10000</span> <span class="comment"># code为0表示正常，非0都是错误 </span></span><br><span class="line">    message = <span class="string">'非法请求'</span> <span class="comment"># 错误描述</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_message</span><span class="params">(cls)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> &#123;<span class="string">'code'</span>: cls.code, <span class="string">'message'</span>: cls.message&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 内部异常暴露细节 </span></span><br><span class="line">exc_map = &#123; &#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">global_exception_handler</span><span class="params">(exc, context)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">		全局异常处理</span></span><br><span class="line"><span class="string">    照抄rest_framework.views.exception_handler，略作修改 不管什么异常这里统一处理。根据不同类型显示不同的 为了前端解析方便，这里响应的状态码采用默认的200 异常对应处理后返回对应的错误码和错误描述 异常找不到对应就返回缺省</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isinstance(exc, Http404):</span><br><span class="line">        exc = exceptions.NotFound()</span><br><span class="line">    <span class="keyword">elif</span> isinstance(exc, PermissionDenied):</span><br><span class="line">        exc = exceptions.PermissionDenied()</span><br><span class="line">        </span><br><span class="line">    print(<span class="string">'异常'</span>, <span class="string">'='</span> * <span class="number">30</span>) </span><br><span class="line">    print(type(exc), exc.__dict__) </span><br><span class="line">    print(<span class="string">'='</span> * <span class="number">30</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> isinstance(exc, exceptions.APIException):</span><br><span class="line">        headers = &#123;&#125;</span><br><span class="line">    		<span class="keyword">if</span> getattr(exc, <span class="string">'auth_header'</span>, <span class="literal">None</span>):</span><br><span class="line">            headers[<span class="string">'WWW-Authenticate'</span>] = exc.auth_header</span><br><span class="line">        <span class="keyword">if</span> getattr(exc, <span class="string">'wait'</span>, <span class="literal">None</span>):</span><br><span class="line">            headers[<span class="string">'Retry-After'</span>] = <span class="string">'%d'</span> % exc.wait</span><br><span class="line">        <span class="keyword">if</span> isinstance(exc.detail, (list, dict)):</span><br><span class="line">            data = exc.detail</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            data = &#123;<span class="string">'detail'</span>: exc.detail&#125;</span><br><span class="line">        set_rollback()</span><br><span class="line">        errmsg = exc_map.get(exc.__class__.__name__, MagBaseException).get_message()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(errmsg, status=<span class="number">200</span>) <span class="comment"># 状态恒为200</span></span><br><span class="line">      </span><br><span class="line">    <span class="comment">#return Response(data, status=exc.status_code, headers=headers)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>抛出异常后，拦截它们，这里做统一的处理</p>
<h2 id="列表页和新增实现"><a href="#列表页和新增实现" class="headerlink" title="列表页和新增实现"></a>列表页和新增实现</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpsView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现列表页get、新增post http://127.0.0.1:8000/emp/ </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">            emps = Employee.objects.all()</span><br><span class="line">            <span class="keyword">return</span> Response(EmpSerializer(emps, many=<span class="literal">True</span>).data)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        serializer = EmpSerializer(data=request.data)</span><br><span class="line">        serializer.is_valid(<span class="literal">True</span>)</span><br><span class="line">        serializer.save()</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br></pre></td></tr></table></figure>

<p>post测试数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"emp_no"</span>: <span class="number">10023</span>,</span><br><span class="line">    <span class="string">"birth_date"</span>: <span class="string">"2000-06-01"</span>,</span><br><span class="line">    <span class="string">"first_name"</span>: <span class="string">"sam"</span>,</span><br><span class="line">    <span class="string">"last_name"</span>: <span class="string">"lee"</span>,</span><br><span class="line">    <span class="string">"gender"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"hire_date"</span>: <span class="string">"2020-08-24"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="详情页、修改和删除实现"><a href="#详情页、修改和删除实现" class="headerlink" title="详情页、修改和删除实现"></a>详情页、修改和删除实现</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现详情页get、修改put、删除delete http://127.0.0.1:8000/emp/10021</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">            obj = Employee.objects.get(pk=pk)</span><br><span class="line">            <span class="keyword">return</span> Response(EmpSerializer(obj).data)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, pk:int)</span>:</span> <span class="comment"># 必须先查后改</span></span><br><span class="line">            obj = Employee.objects.get(pk=pk)</span><br><span class="line">            serializer = EmpSerializer(obj, data=request.data)</span><br><span class="line">            serializer.is_valid(<span class="literal">True</span>)</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, <span class="number">201</span>)</span><br><span class="line">          </span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">            Employee.objects.get(pk=pk).delete()</span><br><span class="line">            <span class="keyword">return</span> Response(status=<span class="number">204</span>)</span><br></pre></td></tr></table></figure>

<p>PUT测试用Json</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">"emp_no"</span>: <span class="number">10023</span>,</span><br><span class="line">    <span class="string">"birth_date"</span>: <span class="string">"2000-06-01"</span>,</span><br><span class="line">    <span class="string">"first_name"</span>: <span class="string">"sam"</span>,</span><br><span class="line">    <span class="string">"last_name"</span>: <span class="string">"lee"</span>,</span><br><span class="line">    <span class="string">"gender"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"hire_date"</span>: <span class="string">"2019-08-24"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="完整参考代码"><a href="#完整参考代码" class="headerlink" title="完整参考代码"></a>完整参考代码</h3><p>employee/views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView, Request, Response</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpsView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">		实现列表页get、新增post http://127.0.0.1:8000/emp/</span></span><br><span class="line"><span class="string">		"""</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        emps = Employee.objects.all()</span><br><span class="line">        <span class="keyword">return</span> Response(EmpSerializer(emps, many=<span class="literal">True</span>).data)</span><br><span class="line">      </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        serializer = EmpSerializer(data=request.data)</span><br><span class="line">        serializer.is_valid(<span class="literal">True</span>)</span><br><span class="line">        serializer.save()</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现详情页get、修改put、删除delete http://127.0.0.1:8000/emp/10021 </span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">            obj = Employee.objects.get(pk=pk)</span><br><span class="line">            <span class="keyword">return</span> Response(EmpSerializer(obj).data)</span><br><span class="line">        </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, pk:int)</span>:</span> <span class="comment"># 必须先查后改</span></span><br><span class="line">            obj = Employee.objects.get(pk=pk)</span><br><span class="line">            serializer = EmpSerializer(obj, data=request.data)</span><br><span class="line">            serializer.is_valid(<span class="literal">True</span>)</span><br><span class="line">            serializer.save()</span><br><span class="line">            <span class="keyword">return</span> Response(serializer.data, <span class="number">201</span>)</span><br><span class="line">          </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self, request, pk:int)</span>:</span></span><br><span class="line">        Employee.objects.get(pk=pk).delete()</span><br><span class="line">        <span class="keyword">return</span> Response(status=<span class="number">204</span>)</span><br></pre></td></tr></table></figure>

<p>employee/models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span><span class="params">(models.Model)</span>:</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Gender</span><span class="params">(models.IntegerChoices)</span>:</span> <span class="comment"># 枚举类型，限定取值范围</span></span><br><span class="line">    MAN = <span class="number">1</span>, <span class="string">'男'</span></span><br><span class="line">    FEMALE = <span class="number">2</span>, <span class="string">'女'</span> <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">            db_table = <span class="string">'employees'</span></span><br><span class="line">    verbose_name = <span class="string">'员工'</span></span><br><span class="line">    emp_no = models.IntegerField(primary_key=<span class="literal">True</span>, verbose_name=<span class="string">'工号'</span>) birth_date = models.DateField(verbose_name=<span class="string">'生日'</span>)</span><br><span class="line">    first_name = models.CharField(max_length=<span class="number">14</span>, verbose_name=<span class="string">'名'</span>) last_name = models.CharField(max_length=<span class="number">16</span>, verbose_name=<span class="string">'姓'</span>) gender = models.SmallIntegerField(verbose_name=<span class="string">'性别'</span>,</span><br><span class="line">    choices=Gender.choices)</span><br><span class="line">    hire_date = models.DateField()</span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Salary</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">"salaries"</span></span><br><span class="line">        <span class="comment">#id = models.AutoField(primary_key=True) # 额外增加的主键，Django不支持联合主</span></span><br><span class="line">        键</span><br><span class="line">        emp_no = models.ForeignKey(Employee, on_delete=models.CASCADE,db_column=<span class="string">'emp_no'</span>, related_name=<span class="string">'salaries'</span>)</span><br><span class="line">        from_date = models.DateField()</span><br><span class="line">        salary = models.IntegerField(verbose_name=<span class="string">'工资'</span>) to_date = models.DateField()</span><br></pre></td></tr></table></figure>

<p>employee/serializers.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee, Salary</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SalarySerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Salary</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpSerializer</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Employee</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br></pre></td></tr></table></figure>

<h2 id="通用视图"><a href="#通用视图" class="headerlink" title="通用视图"></a>通用视图</h2><p>APIView是较为底层的封装，给我们的感觉，主要是对请求对象的封装，为查询字符串、提交的Json数据提供方便的属性等。</p>
<p>首先，EmpsView、EmpView的代码具有普遍性，其它对象增删改查也差不多。</p>
<p>其次，能否实现更加灵活的功能？有些需要列表页，有些需要详情页，有些则需要修改，有些需要新增，有些需要删除的功能，而能灵活做到这一点的可以是Mixin技术。</p>
<p>能否进一步封装，且做到自由组合？这就是GenericAPIView，它派生自APIView。</p>
<p>参考：<a href="https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/generic-views/#genericapiview</a></p>
<p>它只提供了</p>
<ul>
<li>serializer_class，类属性，表示序列化类型，<strong>必须指定</strong>或覆盖get_serializer_class()</li>
<li>get_serializer_class()返回值才是真正的被使用的序列化类，默认是serializer_class。如有必要，覆盖</li>
<li>queryset，类属性，默认为None，<strong>必须指定</strong>或者覆盖get_queryset()</li>
<li>搜索单个对象是按照某些字段搜索，需要提供某些参数，也就是在URL conf中定义的使用关键字传参注入到方法中的参数<ul>
<li>lookup_field，其默认值为’pk’，该类属性一般不需要修改</li>
<li>lookup_url_kwarg默认None，如果为None就使用lookup_field，如果不是’pk’，建议一定要设置</li>
<li>rest_framework.generics.GenericAPIView.get_object中有lookup_url_kwarg =self.lookup_url_kwarg or self.lookup_field</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">'&lt;int:pk&gt;'</span>, EmpView.as_view())         <span class="comment"># lookup_url_kwarg </span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(GenericAPIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request:Request, pk:int)</span>:</span>  <span class="comment"># lookup_url_kwarg </span></span><br><span class="line"><span class="keyword">pass</span></span><br></pre></td></tr></table></figure>

<ul>
<li>get_queryset()，其内部使用queryset类属性。Mixin里面查数据集，调用都是get_queryset方法。如有必要，覆盖</li>
<li>get_object()，详情页使用，其内部使用了get_queryset方法。Mixin里面获取单个对象调用它。如有必要，覆盖</li>
</ul>
<p>简单讲，它定义了序列化、查询、分页功能接口。</p>
<p><font color="red"><strong>注意：GenericAPIView不能增删改查，增删改查需要Mixin其他类。</strong></font></p>
<h2 id="Mixins"><a href="#Mixins" class="headerlink" title="Mixins"></a>Mixins</h2><p>参考：<a href="https://www.django-rest-framework.org/api-guide/generic-views/#mixins" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/generic-views/#mixins</a></p>
<p>以下是孤立的功能Mixin类，需要和GenericAPIView类组合</p>
<ol>
<li><p>ListModelMixin，list方法，列出所有数据，成功返回200。可以分页</p>
</li>
<li><p>CreateModelMixin，create方法，创建并保存一个对象，成功返回201，失败返回400</p>
</li>
<li><p>RetrieveModelMixin，retrieve方法，取回一个对象，成功返回200，失败返回404</p>
</li>
<li><p>UpdateModelMixin，update方法，更新并保存一个对象，成功返回200，失败返回400</p>
</li>
<li><p>DestroyModelMixin，destroy方法，对已存在对象进行删除，成功返回204，失败返回404</p>
</li>
</ol>
<p>仅仅使用GenericAPIView不能简化什么代码，因为在EmpsView、EmpView中，写的最多的就是get、</p>
<p>put、post、delete方法，省略方法也是目标。当然，派生自GenericAPIView后，不要忘了指定queryset和serializer_class。</p>
<p>下面就利用GenericAPIView和Mixins重构View代码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> (</span><br><span class="line">    ListModelMixin,     <span class="comment"># list -&gt; get</span></span><br><span class="line">    CreateModelMixin,   <span class="comment"># create -&gt; post</span></span><br><span class="line">    RetrieveModelMixin, <span class="comment"># retrieve -&gt; get</span></span><br><span class="line">    UpdateModelMixin,   <span class="comment"># update -&gt; put</span></span><br><span class="line">    DestroyModelMixin   <span class="comment"># destroy -&gt; delete</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpsView</span><span class="params">(ListModelMixin, CreateModelMixin, GenericAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现列表页get、新增post</span></span><br><span class="line"><span class="string">    http://127.0.0.1:8000/emp/</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Employee.objects.all()</span><br><span class="line">    serializer_class = EmpSerializer</span><br><span class="line">    get = ListModelMixin.list</span><br><span class="line">    post = CreateModelMixin.create</span><br><span class="line">    <span class="comment"># def get(self, request):</span></span><br><span class="line">    <span class="comment">#     emps = Employee.objects.all()</span></span><br><span class="line">    <span class="comment">#     return Response(EmpSerializer(emps, many=True).data)</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># def post(self, request):</span></span><br><span class="line">    <span class="comment">#     serializer = EmpSerializer(data=request.data)</span></span><br><span class="line">    <span class="comment">#     serializer.is_valid(True)</span></span><br><span class="line">    <span class="comment">#     serializer.save()</span></span><br><span class="line">    <span class="comment">#     return Response(serializer.data)</span></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(RetrieveModelMixin, UpdateModelMixin,</span></span></span><br><span class="line"><span class="class"><span class="params">              DestroyModelMixin, GenericAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现详情页get、修改put、删除delete</span></span><br><span class="line"><span class="string">    http://127.0.0.1:8000/emp/10021</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Employee.objects.all()</span><br><span class="line">    serializer_class = EmpSerializer</span><br><span class="line">    get = RetrieveModelMixin.retrieve</span><br><span class="line">    put = UpdateModelMixin.update</span><br><span class="line">    delete = DestroyModelMixin.destroy</span><br><span class="line">    patch = UpdateModelMixin.partial_update</span><br><span class="line">    <span class="comment"># def get(self, request, pk:int):</span></span><br><span class="line">    <span class="comment">#     obj = Employee.objects.get(pk=pk)</span></span><br><span class="line">    <span class="comment">#     return Response(EmpSerializer(obj).data)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># def put(self, request, pk:int):</span></span><br><span class="line">    <span class="comment"># # 必须先查后改</span></span><br><span class="line">    <span class="comment">#     obj = Employee.objects.get(pk=pk)</span></span><br><span class="line">    <span class="comment">#     serializer = EmpSerializer(obj, data=request.data)</span></span><br><span class="line">    <span class="comment">#     serializer.is_valid(True)</span></span><br><span class="line">    <span class="comment">#     serializer.save()</span></span><br><span class="line">    <span class="comment">#     return Response(serializer.data, 201)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># def delete(self, request, pk:int):</span></span><br><span class="line">    <span class="comment">#     Employee.objects.get(pk=pk).delete()</span></span><br><span class="line">    <span class="comment">#     return Response(status=204)</span></span><br></pre></td></tr></table></figure>

<p>利用了写好的Mixin省掉了大量的代码。 </p>
<p>能把上面代码中的get、post、put、delete方法也能简化掉吗?可以，DRF替你写好了</p>
<h2 id="Concrete视图类"><a href="#Concrete视图类" class="headerlink" title="Concrete视图类"></a>Concrete视图类</h2><p>Concrete View类是由GenericAPIView和诸多Mixin类构成的子类。</p>
<blockquote>
<p>Concrete具体的，也指混凝土，可以认为就是用泛型类GenericAPIView和各种Mixin类混合浇筑成的现成的、具体的，直接可以用的类。</p>
<p>Concrete View Class，就简称CVS</p>
</blockquote>
<p>如果不需要自定义的话，可以考虑使用这些提前定义好的通用的View类。</p>
<table>
<thead>
<tr>
<th align="center">列表页View</th>
<th align="center">继承</th>
<th align="center">方法</th>
<th align="center">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="center">CreateAPIView</td>
<td align="center">GenericAPIView、CreateModelMixin</td>
<td align="center">post</td>
<td align="center">列表页新增对象功能</td>
</tr>
<tr>
<td align="center">ListAPIView</td>
<td align="center">GenericAPIView、ListModelMixin</td>
<td align="center">get</td>
<td align="center">获得列表页内容</td>
</tr>
<tr>
<td align="center"><strong>ListCreateAPIView</strong></td>
<td align="center">GenericAPIView、ListModelMixin、CreateModelMixin</td>
<td align="center">get、post</td>
<td align="center"><strong>完整列表页功能</strong></td>
</tr>
<tr>
<td align="center">RetrieveAPIView</td>
<td align="center">GenericAPIView、RetrieveModelMixin</td>
<td align="center">get</td>
<td align="center">获取单个对象</td>
</tr>
<tr>
<td align="center">UpdateAPIView</td>
<td align="center">GenericAPIView、UpdateModelMixin</td>
<td align="center">get、put</td>
<td align="center">修改单个对象</td>
</tr>
<tr>
<td align="center">DestroyAPIView</td>
<td align="center">GenericAPIView、DestroyModelMixin</td>
<td align="center">delete</td>
<td align="center">删除单个对象</td>
</tr>
<tr>
<td align="center">RetrieveUpdateDestroyAPIView</td>
<td align="center">GenericAPIView、RetrieveModelMixin,、UpdateModelMixin、DestroyModelMixin</td>
<td align="center">get、put、patch、 delete</td>
<td align="center"><strong>详情页 查、 改、删 功能</strong></td>
</tr>
<tr>
<td align="center">RetrieveUpdateAPIView</td>
<td align="center">GenericAPIView、RetrieveModelMixin、UpdateModelMixin</td>
<td align="center">get、 put、 patch</td>
<td align="center"></td>
</tr>
<tr>
<td align="center">RetrieveDestroyAPIView</td>
<td align="center">GenericAPIView、RetrieveModelMixin、DestroyModelMixin</td>
<td align="center">get、 delete</td>
<td align="center"></td>
</tr>
</tbody></table>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListCreateAPIView,</span><br><span class="line">RetrieveUpdateDestroyAPIView</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpsView</span><span class="params">(ListCreateAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现列表页get、新增post http://127.0.0.1:8000/emp/</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Employee.objects.all() </span><br><span class="line">    serializer_class = EmpSerializer</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(RetrieveUpdateDestroyAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现详情页get、修改put、删除delete </span></span><br><span class="line"><span class="string">    http://127.0.0.1:8000/emp/10021</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Employee.objects.all() </span><br><span class="line">    serializer_class = EmpSerializer </span><br><span class="line">    <span class="comment">#lookup_url_kwarg = 'id' # 路由配置中不是pk可以设置</span></span><br></pre></td></tr></table></figure>

<h2 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h2><p>参考：<a href="https://www.django-rest-framework.org/api-guide/pagination/#setting-the-pagination-style" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/pagination/#setting-the-pagination-style</a></p>
<h3 id="全局配置"><a href="#全局配置" class="headerlink" title="全局配置"></a>全局配置</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_PAGINATION_CLASS'</span>:<span class="string">'rest_framework.pagination.PageNumberPagination'</span>,</span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>: <span class="number">10</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试 <a href="http://127.0.0.1:8000/emp/" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/</a> ，分页返回数据了。 测试 <a href="http://127.0.0.1:8000/emp/?page=3，返回了第3页。" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/?page=3，返回了第3页。</a></p>
<h3 id="自定义分页类"><a href="#自定义分页类" class="headerlink" title="自定义分页类"></a>自定义分页类</h3><p>测试<a href="http://127.0.0.1:8000/emp/?page=3&amp;page_size=2，page_size似乎没有用，为什么?因为安全，" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/?page=3&amp;page_size=2，page_size似乎没有用，为什么?因为安全，</a> 默认不接受客户端发来的参数。通过page_size_query_param设置类属性来接收浏览器发来的参数的。</p>
<p>工具包下面创建类 utils.paginations.PageNumberPagination ，代码如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> pagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PageNumberPagination</span><span class="params">(pagination.PageNumberPagination)</span>:</span> </span><br><span class="line">    page_size_query_param = <span class="string">'size'</span> <span class="comment"># size=20</span></span><br><span class="line">    page_size = <span class="number">4</span> <span class="comment"># 每页显示4个</span></span><br><span class="line">    max_page_size = <span class="number">8</span> <span class="comment"># 对page_size进行限制</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListCreateAPIView,RetrieveUpdateDestroyAPIView</span><br><span class="line"><span class="keyword">from</span> utils.paginations <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpsView</span><span class="params">(ListCreateAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现列表页get、新增post</span></span><br><span class="line"><span class="string">    http://127.0.0.1:8000/emp/</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Employee.objects.all()</span><br><span class="line">    serializer_class = EmpSerializer</span><br><span class="line">    pagination_class = PageNumberPagination <span class="comment"># 指定自定义分页类，不使用全局</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">EmpView</span><span class="params">(RetrieveUpdateDestroyAPIView)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    实现详情页get、修改put、删除delete http://127.0.0.1:8000/emp/10021</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Employee.objects.all() </span><br><span class="line">    serializer_class = EmpSerializer </span><br><span class="line">    <span class="comment">#lookup_url_kwarg = 'id' # 路由配置中不是pk可以设置</span></span><br></pre></td></tr></table></figure>

<p>测试 <a href="http://127.0.0.1:8000/emp/" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/</a> 、<a href="http://127.0.0.1:8000/emp/?size=2" target="_blank" rel="noopener">http://127.0.0.1:8000/emp/?size=2</a></p>
<p>CVS已经很方便了，已经简化到用列表页、详情页2个类配置一下就行了。但是，可以看到它们也有重复 的地方，是否还可以简化?</p>
<p>这就需要使用视图集ViewSet。</p>
<h2 id="视图集"><a href="#视图集" class="headerlink" title="视图集"></a>视图集</h2><p>参考：<a href="https://www.django-rest-framework.org/api-guide/viewsets/" target="_blank" rel="noopener">https://www.django-rest-framework.org/api-guide/viewsets/</a></p>
<h3 id="视图集类关系"><a href="#视图集类关系" class="headerlink" title="视图集类关系"></a>视图集类关系</h3><table>
<thead>
<tr>
<th align="center">类</th>
<th align="center">继承</th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">ViewSet</td>
<td align="center">ViewSetMixin、APIView</td>
<td align="center">不提供操作，一般不用</td>
</tr>
<tr>
<td align="center"><br>ViewSetMixin</td>
<td align="center"></td>
<td align="center">重写了 as_view，使用 actions 字典建立<br>method 到函数的映射<br> method =&gt; handler</td>
</tr>
<tr>
<td align="center">GenericViewSet</td>
<td align="center">ViewSetMixin、GenericAPIView</td>
<td align="center">具有 get_object, get_queryset，但是没有提供增删改查方法</td>
</tr>
<tr>
<td align="center"><strong>ModelViewSet</strong></td>
<td align="center">ListModelMixin、CreateModelMixin、RetrieveModelMixin、UpdateModelMixin、DestroyModelMixin、GenericViewSet</td>
<td align="center">在 GenericViewSet 和 Mixins 基础上，提供了list()、create()、retrieve()、 update()、destroy()、partial_update()</td>
</tr>
<tr>
<td align="center"><strong>ReadOnlyModelViewSet</strong></td>
<td align="center">ListModelMixin、RetrieveModelMixin、GenericAPIView</td>
<td align="center">list()、retrieve()</td>
</tr>
</tbody></table>
<p><code>ViewSetMixin.as_view(cls, actions=None, **initkwargs)</code> 通过actions字典来解决method和handler映射，例如<code>ViewSet.as_view({&#39;get&#39;: &#39;list&#39;, &#39;post&#39;: &#39;create&#39;})</code>2个get方法可以通过路径配置不一样解决。</p>
<p><strong>ModelViewSet</strong></p>
<ul>
<li>5个Mixin提供了方法，例如list、retrieve、create等</li>
<li>ViewSetMixin解决了类二合一路由问题<ul>
<li>要指定action，指明request method和handler映射关系</li>
</ul>
</li>
<li>GenericAPIView<ul>
<li>要指定queryset、serializer_class</li>
</ul>
</li>
</ul>
<h3 id="视图集应用"><a href="#视图集应用" class="headerlink" title="视图集应用"></a>视图集应用</h3><h4 id="视图层代码"><a href="#视图层代码" class="headerlink" title="视图层代码"></a>视图层代码</h4><p>注意：一定要在路由中配置一下actions</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Employee</span><br><span class="line"><span class="keyword">from</span> .serializers <span class="keyword">import</span> EmpSerializer</span><br><span class="line"></span><br><span class="line"><span class="comment"># from rest_framework.generics import ListCreateAPIView,RetrieveUpdateDestroyAPIView</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EmpViewSet</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset = Employee.objects.all() </span><br><span class="line">    serializer_class = EmpSerializer </span><br><span class="line">    <span class="comment">#lookup_url_kwarg = 'id' # 路由配置中不是pk可以设置</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># class EmpsView(ListCreateAPIView): </span></span><br><span class="line"><span class="comment"># 		"""</span></span><br><span class="line"><span class="comment"># 		实现列表页get、新增post</span></span><br><span class="line"><span class="comment"># 		http://127.0.0.1:8000/emp/</span></span><br><span class="line"><span class="comment"># 		"""</span></span><br><span class="line"><span class="comment">#     queryset = Employee.objects.all()</span></span><br><span class="line"><span class="comment">#     serializer_class = EmpSerializer</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># class EmpView(RetrieveUpdateDestroyAPIView):</span></span><br><span class="line"><span class="comment">#     """</span></span><br><span class="line"><span class="comment"># 		实现详情页get、修改put、删除delete # http://127.0.0.1:8000/emp/10021 </span></span><br><span class="line"><span class="comment">#     """</span></span><br><span class="line"><span class="comment">#     queryset = Employee.objects.all()</span></span><br><span class="line"><span class="comment">#     serializer_class = EmpSerializer</span></span><br><span class="line"><span class="comment"># #lookup_url_kwarg = 'id' # 路由配置中不是pk可以设置</span></span><br></pre></td></tr></table></figure>

<h4 id="路由配置"><a href="#路由配置" class="headerlink" title="路由配置"></a>路由配置</h4><p>employee/urls.py 指定列表页、详情页的action，建立到handler的映射</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">''</span>, EmpViewSet.as_view(&#123;<span class="string">'get'</span>:<span class="string">'list'</span>, <span class="string">'post'</span>:<span class="string">'create'</span>&#125;)), <span class="comment"># /emp/</span></span><br><span class="line">    path(<span class="string">'&lt;int:pk&gt;/'</span>, EmpViewSet.as_view(&#123;</span><br><span class="line">        <span class="string">'get'</span>: <span class="string">'retrieve'</span>, <span class="string">'put'</span>: <span class="string">'update'</span>, <span class="string">'delete'</span>: <span class="string">'destroy'</span></span><br><span class="line">    &#125;)), <span class="comment"># /emp/10021/</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p><strong>路由器</strong></p>
<p>视图集的action配置很固定，能否也简化? 下面就以简单路由器类实现路由的简化。 </p>
<p>SimpleRouter注册需要2个参数</p>
<ul>
<li><p>prefix:前缀，可以为空串 </p>
</li>
<li><p>viewset:提供视图集</p>
</li>
</ul>
<p>最终返回路由配置的<strong>列表</strong></p>
<p>employee/urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> .views <span class="keyword">import</span> EmpViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> SimpleRouter</span><br><span class="line"></span><br><span class="line">router = SimpleRouter()</span><br><span class="line">router.register(<span class="string">''</span>, EmpViewSet) <span class="comment"># 在一级路由中配置过了前缀，这里省略</span></span><br><span class="line"></span><br><span class="line">urlpatterns = router.urls</span><br><span class="line"><span class="comment"># urlpatterns = [</span></span><br><span class="line"><span class="comment">#     path('', EmpViewSet.as_view(&#123;'get':'list', 'post':'create'&#125;)), # /emp/</span></span><br><span class="line"><span class="comment">#     path('&lt;int:pk&gt;/', EmpViewSet.as_view(&#123;</span></span><br><span class="line"><span class="comment">#         'get': 'retrieve', 'put': 'update', 'delete': 'destroy'</span></span><br><span class="line"><span class="comment"># &#125;)), # /emp/10021/ #]</span></span><br><span class="line"></span><br><span class="line">print(<span class="string">'+'</span> * <span class="number">30</span>)</span><br><span class="line">print(urlpatterns)</span><br><span class="line">print(<span class="string">'+'</span> * <span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">&lt;URLPattern<span class="string">'^$'</span>[name=<span class="string">'employee-list'</span>]&gt;</span><br><span class="line">&lt;URLPattern<span class="string">'^(?P&lt;pk&gt;[^/.]+)/$'</span>[name=<span class="string">'employee-detail'</span>]&gt;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Lupinus
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="http://yoursite.com/2018/10/09/DRF%E6%8F%92%E4%BB%B6/" title="[Django框架]">http://yoursite.com/2018/10/09/DRF插件/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Django/" rel="tag"># Django</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2018/10/07/Django%E6%A1%86%E6%9E%B6%E8%AF%A6%E8%A7%A3/" rel="prev" title="[Django框架]">
      <i class="fa fa-chevron-left"></i> [Django框架]
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/03/01/Linux%E5%9F%BA%E7%A1%80/" rel="next" title="[Linux基础]">
      [Linux基础] <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Restful-API设计最佳实践"><span class="nav-number">1.</span> <span class="nav-text">Restful API设计最佳实践</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#RESTFul"><span class="nav-number">1.1.</span> <span class="nav-text">RESTFul</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#协议"><span class="nav-number">1.2.</span> <span class="nav-text">协议</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP方法"><span class="nav-number">1.3.</span> <span class="nav-text">HTTP方法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用名词"><span class="nav-number">1.4.</span> <span class="nav-text">使用名词</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集合功能"><span class="nav-number">1.5.</span> <span class="nav-text">集合功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#状态码"><span class="nav-number">1.6.</span> <span class="nav-text">状态码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#错误处理"><span class="nav-number">1.7.</span> <span class="nav-text">错误处理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#版本"><span class="nav-number">1.8.</span> <span class="nav-text">版本</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#返回结果"><span class="nav-number">1.9.</span> <span class="nav-text">返回结果</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图函数"><span class="nav-number">1.10.</span> <span class="nav-text">视图函数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON响应"><span class="nav-number">1.10.1.</span> <span class="nav-text">JSON响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#请求方法限制装饰器"><span class="nav-number">1.10.2.</span> <span class="nav-text">请求方法限制装饰器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF处理"><span class="nav-number">1.10.3.</span> <span class="nav-text">CSRF处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CSRF解决"><span class="nav-number">1.10.4.</span> <span class="nav-text">CSRF解决</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图类"><span class="nav-number">1.11.</span> <span class="nav-text">视图类</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#View类原理"><span class="nav-number">1.11.0.1.</span> <span class="nav-text">View类原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#视图类实现"><span class="nav-number">1.11.0.2.</span> <span class="nav-text">视图类实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#装饰器"><span class="nav-number">1.11.0.3.</span> <span class="nav-text">装饰器</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#中间件"><span class="nav-number">1.12.</span> <span class="nav-text">中间件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#洋葱模型"><span class="nav-number">1.12.1.</span> <span class="nav-text">洋葱模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#中间件定义"><span class="nav-number">1.12.2.</span> <span class="nav-text">中间件定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用"><span class="nav-number">1.12.3.</span> <span class="nav-text">应用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内建中间件"><span class="nav-number">1.12.4.</span> <span class="nav-text">内建中间件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Session和Cookie"><span class="nav-number">1.13.</span> <span class="nav-text">Session和Cookie</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Cookie技术"><span class="nav-number">1.13.1.</span> <span class="nav-text">Cookie技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#其它持久化技术"><span class="nav-number">1.13.2.</span> <span class="nav-text">其它持久化技术</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Session技术"><span class="nav-number">1.13.3.</span> <span class="nav-text">Session技术</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#开启session支持"><span class="nav-number">1.13.3.1.</span> <span class="nav-text">开启session支持</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#session清除"><span class="nav-number">1.13.3.2.</span> <span class="nav-text">session清除</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DRF及序列化器原理"><span class="nav-number">1.14.</span> <span class="nav-text">DRF及序列化器原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化器"><span class="nav-number">1.14.1.</span> <span class="nav-text">序列化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化器类"><span class="nav-number">1.14.2.</span> <span class="nav-text">序列化器类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化器原理"><span class="nav-number">1.14.3.</span> <span class="nav-text">序列化器原理</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#序列化器-1"><span class="nav-number">1.14.3.1.</span> <span class="nav-text">序列化器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#序列化"><span class="nav-number">1.14.3.2.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反序列化"><span class="nav-number">1.14.3.3.</span> <span class="nav-text">反序列化</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#校验"><span class="nav-number">1.14.4.</span> <span class="nav-text">校验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#字段级校验器"><span class="nav-number">1.14.4.1.</span> <span class="nav-text">字段级校验器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#对象级校验器"><span class="nav-number">1.14.4.2.</span> <span class="nav-text">对象级校验器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#入库"><span class="nav-number">1.14.5.</span> <span class="nav-text">入库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ModelSerializer"><span class="nav-number">1.15.</span> <span class="nav-text">ModelSerializer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化器-2"><span class="nav-number">1.15.1.</span> <span class="nav-text">序列化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化-1"><span class="nav-number">1.15.2.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反序列化-1"><span class="nav-number">1.15.3.</span> <span class="nav-text">反序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#外键关系"><span class="nav-number">1.15.4.</span> <span class="nav-text">外键关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Model类"><span class="nav-number">1.15.5.</span> <span class="nav-text">Model类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化器-3"><span class="nav-number">1.15.6.</span> <span class="nav-text">序列化器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#序列化-2"><span class="nav-number">1.15.7.</span> <span class="nav-text">序列化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#各自独立查询"><span class="nav-number">1.15.8.</span> <span class="nav-text">各自独立查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关联主键"><span class="nav-number">1.15.9.</span> <span class="nav-text">关联主键</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关联字符串表达"><span class="nav-number">1.15.10.</span> <span class="nav-text">关联字符串表达</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关联对象"><span class="nav-number">1.15.11.</span> <span class="nav-text">关联对象</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#DRF视图"><span class="nav-number">1.16.</span> <span class="nav-text">DRF视图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#APIView"><span class="nav-number">1.16.1.</span> <span class="nav-text">APIView</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GET请求测试"><span class="nav-number">1.16.1.1.</span> <span class="nav-text">GET请求测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#POST请求测试"><span class="nav-number">1.16.1.2.</span> <span class="nav-text">POST请求测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#采用表单提交方式"><span class="nav-number">1.16.1.3.</span> <span class="nav-text">采用表单提交方式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Json数据"><span class="nav-number">1.16.1.4.</span> <span class="nav-text">Json数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#请求总结"><span class="nav-number">1.16.1.5.</span> <span class="nav-text">请求总结</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#响应"><span class="nav-number">1.16.2.</span> <span class="nav-text">响应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#应用-1"><span class="nav-number">1.16.3.</span> <span class="nav-text">应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#路由"><span class="nav-number">1.16.3.1.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#列表页"><span class="nav-number">1.16.3.2.</span> <span class="nav-text">列表页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#详情页"><span class="nav-number">1.16.3.3.</span> <span class="nav-text">详情页</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常处理-☆☆☆☆☆"><span class="nav-number">1.17.</span> <span class="nav-text">异常处理(☆☆☆☆☆)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常全局配置"><span class="nav-number">1.17.1.</span> <span class="nav-text">异常全局配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#全局异常处理"><span class="nav-number">1.17.2.</span> <span class="nav-text">全局异常处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#列表页和新增实现"><span class="nav-number">1.18.</span> <span class="nav-text">列表页和新增实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#详情页、修改和删除实现"><span class="nav-number">1.19.</span> <span class="nav-text">详情页、修改和删除实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#完整参考代码"><span class="nav-number">1.19.1.</span> <span class="nav-text">完整参考代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#通用视图"><span class="nav-number">1.20.</span> <span class="nav-text">通用视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Mixins"><span class="nav-number">1.21.</span> <span class="nav-text">Mixins</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Concrete视图类"><span class="nav-number">1.22.</span> <span class="nav-text">Concrete视图类</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#分页"><span class="nav-number">1.23.</span> <span class="nav-text">分页</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#全局配置"><span class="nav-number">1.23.1.</span> <span class="nav-text">全局配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义分页类"><span class="nav-number">1.23.2.</span> <span class="nav-text">自定义分页类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#视图集"><span class="nav-number">1.24.</span> <span class="nav-text">视图集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#视图集类关系"><span class="nav-number">1.24.1.</span> <span class="nav-text">视图集类关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图集应用"><span class="nav-number">1.24.2.</span> <span class="nav-text">视图集应用</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#视图层代码"><span class="nav-number">1.24.2.1.</span> <span class="nav-text">视图层代码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#路由配置"><span class="nav-number">1.24.2.2.</span> <span class="nav-text">路由配置</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Lupinus"
      src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/20160715144434_fZCsF.jpeg">
  <p class="site-author-name" itemprop="name">Lupinus</p>
  <div class="site-description" itemprop="description">Re：从零开始的go学习生活(｀・ω・´)</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">53</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/rogerXS80/roger" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rogerXS80&#x2F;roger" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/fastsword66@gmail.com" title="E-Mail → fastsword66@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5896791111/home?wvr=5&sudaref=graph.qq.com" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5896791111&#x2F;home?wvr&#x3D;5&amp;sudaref&#x3D;graph.qq.com" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

      
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <!-- 选择合适的icon -->
              <i class="fa fa-history fa-" aria-hidden="true"></i>
          <!-- 这里对应下文主题配置文件的recent_posts_title值 -->
              最近文章
            </div>
            <ul class="links-of-blogroll-list"> 
              <!-- 设置排序规格，此处我采用按照文章更新时间排序 -->
              
              <!-- 显示三条近期文章，请自信合理配置 -->
              
                <li>
                  <a href="/2017/06/22/Git%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8/" title="[Git命令大全]" target="_blank">[Git命令大全]</a>
                </li>
              
                <li>
                  <a href="/2022/02/27/Vue%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA/" title="[Vue客户端项目搭建]" target="_blank">[Vue客户端项目搭建]</a>
                </li>
              
                <li>
                  <a href="/2022/02/26/Vue%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7%EF%BC%88Vue-cli%EF%BC%89/" title="[Vue自动化工具（Vue-cli）]" target="_blank">[Vue自动化工具（Vue-cli）]</a>
                </li>
              
            </ul>
          </div>
      

      
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>




      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Roger</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div><!-- 文件位置：~/sourse/_data/footer.swig -->

<div class="weixin-box">
  <div class="weixin-menu">
    <div class="weixin-hover">
      <div class="weixin-description">微信扫一扫，订阅本博客</div>
    </div>
  </div>
</div>


        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="100" alpha="0.4" zIndex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

    </div>

<!-- 鼠标点击特效 -->
<script type="text/javascript" src="/js/fireworks.js"></script>

<!-- 点击爱心 
<script type="text/javascript" src="/js/clicklove.js"></script>
-->

</body>
</html>
