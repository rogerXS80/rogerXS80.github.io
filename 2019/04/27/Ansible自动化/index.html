<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="uW8bwgMGUwIA01nPfItoty1rmtmmuVkOVTeS9O0nAUg">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"yoursite.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。Ansible架构相对比较简单，仅需通过SSH连接客户机执行任务即可...">
<meta property="og:type" content="article">
<meta property="og:title" content="[Ansible自动化]">
<meta property="og:url" content="http://yoursite.com/2019/04/27/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96/index.html">
<meta property="og:site_name" content="Lupinus">
<meta property="og:description" content="Ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。Ansible架构相对比较简单，仅需通过SSH连接客户机执行任务即可...">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/ansible%E6%9E%B6%E6%9E%84.jpg">
<meta property="og:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/ad-hoc%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8.jpg">
<meta property="og:image" content="https://blog.driverzeng.com/wp-content/uploads/2021/08/15689649055718.jpg">
<meta property="article:published_time" content="2019-04-27T09:28:19.000Z">
<meta property="article:modified_time" content="2019-04-27T14:22:10.000Z">
<meta property="article:author" content="Lupinus">
<meta property="article:tag" content="Linxu架构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/ansible%E6%9E%B6%E6%9E%84.jpg">

<link rel="canonical" href="http://yoursite.com/2019/04/27/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>[Ansible自动化] | Lupinus</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Lupinus" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Lupinus</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Re：从零开始的go学习生活(｀・ω・´)</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/rogerXS80" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/27/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/20160715144434_fZCsF.jpeg">
      <meta itemprop="name" content="Lupinus">
      <meta itemprop="description" content="Re：从零开始的go学习生活(｀・ω・´)">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lupinus">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Ansible自动化]
        </h1>

        <div class="post-meta">
          <!-- 置顶图标 -->
            <span class="post-meta-item">
              
              
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2019-04-27 17:28:19 / Modified: 22:22:10" itemprop="dateCreated datePublished" datetime="2019-04-27T17:28:19+08:00">2019-04-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/SRE/" itemprop="url" rel="index"><span itemprop="name">SRE</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
            <div class="post-description">Ansible是新出现的自动化运维工具，基于Python开发，集合了众多运维工具（puppet、cfengine、chef、func、fabric）的优点，实现了批量系统配置、批量程序部署、批量运行命令等功能。Ansible架构相对比较简单，仅需通过SSH连接客户机执行任务即可...</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="Ansible基础入门"><a href="#Ansible基础入门" class="headerlink" title="Ansible基础入门"></a>Ansible基础入门</h1><h2 id="Ansible基础概述"><a href="#Ansible基础概述" class="headerlink" title="Ansible基础概述"></a>Ansible基础概述</h2><p>Ansible是一个自动化统一配置管理工具，自动化主要体现在Ansible集成了丰富模块以及功能组件，可以通过一个命令完成一系列的操作，进而能减少重复性的工作和维护成本，可以提高工作效率</p>
<h2 id="同类型软件对比"><a href="#同类型软件对比" class="headerlink" title="同类型软件对比"></a>同类型软件对比</h2><ul>
<li><p>Ansible</p>
</li>
<li><p>Saltstack</p>
</li>
<li><p>puppet</p>
</li>
</ul>
<table>
<thead>
<tr>
<th align="center">对比</th>
<th align="center">puppet</th>
<th align="center">Ansible</th>
<th align="center">Saltstack</th>
</tr>
</thead>
<tbody><tr>
<td align="center">开发语言</td>
<td align="center">ruby</td>
<td align="center">python</td>
<td align="center">Python</td>
</tr>
<tr>
<td align="center">远程执行功能</td>
<td align="center">没有</td>
<td align="center">有、串行</td>
<td align="center">有、并行</td>
</tr>
<tr>
<td align="center">客户端</td>
<td align="center">没有</td>
<td align="center">没有</td>
<td align="center">有</td>
</tr>
<tr>
<td align="center">架构</td>
<td align="center"></td>
<td align="center">SSH</td>
<td align="center">C/S、也支持SSH</td>
</tr>
</tbody></table>
<h2 id="Ansible的功能"><a href="#Ansible的功能" class="headerlink" title="Ansible的功能"></a>Ansible的功能</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">1.远程执行 批量执行远程命令，可以对多台主机进行远程操作 </span><br><span class="line">2.配置管理 批。。34www量配置软件服务，可以进行自动化方式配置，服务的统一配置管理，和启停 </span><br><span class="line">3.事件驱动 通过Ansible的模块，对服务进行不同的事件驱动 比如： </span><br><span class="line">	1）修改配置后重启 </span><br><span class="line">	2）只修改配置文件，不重启 </span><br><span class="line">	3）修改配置文件后，重新加载</span><br><span class="line">	4）远程启停服务管理 </span><br><span class="line">4.管理公有云 通过API接口的方式管理公有云，不过这方面做的不如saltstack. saltstack本身可以通过saltcloud管理各大云厂商的云平台</span><br><span class="line">5.二次开发 因为语法是Python，所以便于运维进行二次开发</span><br><span class="line">6.任务编排 可以通过playbook的方式来统一管理服务，并且可以使用一条命令，实现一套架构的部署 123456789101112131415161718192021222324</span><br><span class="line">7.跨平台，跨系统 </span><br><span class="line">几乎不受到平台和系统的限制，比如安装apache和启动+服务 </span><br><span class="line">在Ubuntu上安装apache服务名字叫apache23</span><br><span class="line">在CentOS上安装apache服务名字叫httpd </span><br><span class="line"></span><br><span class="line">在CentOS6上启动服务器使用命令：/etc/init.d/nginx start </span><br><span class="line">在CentOS7上启动服务器使用命令：systemctl start nginx</span><br></pre></td></tr></table></figure>

<h2 id="Ansible的架构"><a href="#Ansible的架构" class="headerlink" title="Ansible的架构"></a>Ansible的架构</h2><ol>
<li><p>连接插件connection plugins用于连接主机 用来连接被管理端 </p>
</li>
<li><p>核心模块core modules连接主机实现操作， 它依赖于具体的模块来做具体的事情 </p>
</li>
<li><p>自定义模块custom modules根据自己的需求编写具体的模块 </p>
</li>
<li><p>插件plugins完成模块功能的补充 </p>
</li>
<li><p>剧本playbookansible的配置文件,将多个任务定义在剧本中，由ansible自动执行 </p>
</li>
<li><p>主机清单inventor定义ansible需要操作主机的范围 </p>
</li>
</ol>
<p>最重要的一点是 ansible是模块化的 它所有的操作都依赖于模块</p>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/ansible%E6%9E%B6%E6%9E%84.jpg" alt="ansible架构"></p>
<h2 id="Ansible的执行流程"><a href="#Ansible的执行流程" class="headerlink" title="Ansible的执行流程"></a>Ansible的执行流程</h2><ol>
<li><p>Ansible读取playbook剧本，剧本中会记录对哪些主机执行哪些任务</p>
</li>
<li><p>首先Ansible通过主机清单找到要执行的主机，然后调用具体的模块</p>
</li>
<li><p>其次Ansible会通过连接插件连接对应的主机并推送对应的任务列表</p>
</li>
<li><p>最后被管理的主机会将Ansible发送过来的任务解析为本地Shell命令执行</p>
</li>
</ol>
<h2 id="Ansible安装部署"><a href="#Ansible安装部署" class="headerlink" title="Ansible安装部署"></a>Ansible安装部署</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">WanIP</th>
<th align="center">LanIP</th>
<th align="center">角色</th>
</tr>
</thead>
<tbody><tr>
<td align="center">m01</td>
<td align="center">10.0.0.61</td>
<td align="center">172.16.1.61</td>
<td align="center">Ansible控制端</td>
</tr>
<tr>
<td align="center">web01</td>
<td align="center">10.0.0.7</td>
<td align="center">172.16.1.7</td>
<td align="center">被控端</td>
</tr>
<tr>
<td align="center">web02</td>
<td align="center">10.0.0.8</td>
<td align="center">172.16.1.8</td>
<td align="center">被控端</td>
</tr>
</tbody></table>
<h3 id="安装Ansible"><a href="#安装Ansible" class="headerlink" title="安装Ansible"></a>安装Ansible</h3><table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">–version</td>
<td align="center">ansible版本信息</td>
</tr>
<tr>
<td align="center">-v</td>
<td align="center">显示详细信息</td>
</tr>
<tr>
<td align="center">-i</td>
<td align="center">主机清单文件路径，默认是在/etc/ansible/hosts</td>
</tr>
<tr>
<td align="center">-m</td>
<td align="center">使用的模块名称，默认使用command模块</td>
</tr>
<tr>
<td align="center">-a</td>
<td align="center">使用的模块参数，模块的具体动作</td>
</tr>
<tr>
<td align="center">-k</td>
<td align="center">提示输入ssh密码，而不使用基于ssh的密钥认证</td>
</tr>
<tr>
<td align="center">-C</td>
<td align="center">模拟执行测试，但不会真的执行</td>
</tr>
<tr>
<td align="center">-T</td>
<td align="center">执行命令的超时</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#安装ansible 有epel源 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># yum install -y ansible</span></span><br><span class="line"></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible --version </span></span><br><span class="line"><span class="comment">## ansible版本号 </span></span><br><span class="line">ansible 2.9.27 </span><br><span class="line"><span class="comment">## ansible默认配置文件 </span></span><br><span class="line">config file = ca</span><br><span class="line"><span class="comment">## 配置文件模块路径 </span></span><br><span class="line">configured module search path = [u<span class="string">'/root/.ansible/plugins/modules'</span>, u<span class="string">'/usr/share/ansible/plugins/modules'</span>] </span><br><span class="line"><span class="comment">## python模块路径 </span></span><br><span class="line">ansible python module location = /usr/lib/python2.7/site-packages/ansible </span><br><span class="line"><span class="comment">## ansible可执行命令的路径 </span></span><br><span class="line">executable location = /usr/bin/ansible</span><br><span class="line"><span class="comment">## Python版本 </span></span><br><span class="line">python version = 2.7.5 (default, Oct 30 2018, 23:45:53) [GCC 4.8.5 20150623 (Red Hat 4.8.5-36)]</span><br></pre></td></tr></table></figure>

<h3 id="Ansible配置文件读取顺序"><a href="#Ansible配置文件读取顺序" class="headerlink" title="Ansible配置文件读取顺序"></a>Ansible配置文件读取顺序</h3><ol>
<li><p>$ANSIBLE_CONFIG </p>
</li>
<li><p>.ansible.cfg </p>
</li>
<li><p>~/.ansible.cfg </p>
</li>
<li><p>/etc/ansible/ansible.cfg</p>
</li>
</ol>
<h3 id="Ansible配置文件详解"><a href="#Ansible配置文件详解" class="headerlink" title="Ansible配置文件详解"></a>Ansible配置文件详解</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/ansible.cfg </span></span><br><span class="line"><span class="comment">#inventory      = /etc/ansible/hosts      #主机列表配置文件</span></span><br><span class="line"><span class="comment">#library        = /usr/share/my_modules/  #库文件存放目录</span></span><br><span class="line"><span class="comment">#remote_tmp     = ~/.ansible/tmp          #临时py文件存放在远程主机目录</span></span><br><span class="line"><span class="comment">#local_tmp      = ~/.ansible/tmp          #本机的临时执行目录</span></span><br><span class="line"><span class="comment">#forks          = 5                       #默认并发数</span></span><br><span class="line"><span class="comment">#sudo_user      = root                    #默认sudo用户</span></span><br><span class="line"><span class="comment">#ask_sudo_pass = True                     #每次执行是否询问sudo的ssh密码</span></span><br><span class="line"><span class="comment">#ask_pass      = True                     #每次执行是否询问ssh密码</span></span><br><span class="line"><span class="comment">#remote_port    = 22                      #远程主机端口</span></span><br><span class="line">host_key_checking = False                 <span class="comment">#跳过检查主机指纹</span></span><br><span class="line">log_path = /var/<span class="built_in">log</span>/ansible.log           <span class="comment">#ansible日志</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#普通用户提权操作</span></span><br><span class="line">[privilege_escalation]</span><br><span class="line"><span class="comment">#become=True</span></span><br><span class="line"><span class="comment">#become_method=sudo</span></span><br><span class="line"><span class="comment">#become_user=root</span></span><br><span class="line"><span class="comment">#become_ask_pass=False</span></span><br></pre></td></tr></table></figure>

<h3 id="Ansible-Inventory-主机清单"><a href="#Ansible-Inventory-主机清单" class="headerlink" title="Ansible Inventory(主机清单)"></a>Ansible Inventory(主机清单)</h3><p>/etc/ansible/hosts是ansible默认主机资产清单文件，用于定义被管理主机的认证信息， 例如ssh登录用户名、密码以及key相关信息。Inventory文件中填写需要被管理的主机与主机组信息。还可以自定义Inventory主机清单的位置，使用-i指定文件位置即可</p>
<h4 id="使用IP-端口-用户-密码"><a href="#使用IP-端口-用户-密码" class="headerlink" title="使用IP+端口+用户+密码"></a>使用IP+端口+用户+密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">[web_group] </span><br><span class="line">10.0.0.7 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="string">'123'</span> </span><br><span class="line">10.0.0.8 ansible_ssh_port=22 ansible_ssh_user=root ansible_ssh_pass=<span class="string">'123'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 检测web_group主机是否通 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m ping</span></span><br><span class="line">10.0.0.7 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">10.0.0.8 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line"></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m shell -a 'df -h'</span></span><br><span class="line">10.0.0.7 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3        19G  1.5G   18G   8% /</span><br><span class="line">devtmpfs        476M     0  476M   0% /dev</span><br><span class="line">tmpfs           487M     0  487M   0% /dev/shm</span><br><span class="line">tmpfs           487M  7.7M  479M   2% /run</span><br><span class="line">tmpfs           487M     0  487M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1       497M  120M  378M  25% /boot</span><br><span class="line">tmpfs            98M     0   98M   0% /run/user/0</span><br><span class="line"></span><br><span class="line">10.0.0.8 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class="line">/dev/sda3        19G  1.5G   18G   8% /</span><br><span class="line">devtmpfs        476M     0  476M   0% /dev</span><br><span class="line">tmpfs           487M     0  487M   0% /dev/shm</span><br><span class="line">tmpfs           487M  7.7M  479M   2% /run</span><br><span class="line">tmpfs           487M     0  487M   0% /sys/fs/cgroup</span><br><span class="line">/dev/sda1       497M  120M  378M  25% /boot</span><br><span class="line">tmpfs            98M     0   98M   0% /run/user/0</span><br></pre></td></tr></table></figure>

<h4 id="主机名-密码"><a href="#主机名-密码" class="headerlink" title="主机名+密码"></a>主机名+密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 注意：该方式，需要做域名解析，把主机名解析在IP上，否则ansible无法识别 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">[web_group] </span><br><span class="line">web0[1:2] ansible_ssh_pass=<span class="string">'123'</span></span><br><span class="line"></span><br><span class="line">[root@m01 ~]<span class="comment"># vim /etc/hosts </span></span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 </span><br><span class="line">localhost localhost.localdomain localhost6 localhost6.localdomain6 </span><br><span class="line">10.0.0.7 web01 </span><br><span class="line">10.0.0.8 web02</span><br><span class="line"></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m ping</span></span><br><span class="line">web01 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">web02 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="变量方式，主机名-密码"><a href="#变量方式，主机名-密码" class="headerlink" title="变量方式，主机名+密码"></a>变量方式，主机名+密码</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 使用变量的写法 </span></span><br><span class="line">[web_group] </span><br><span class="line">web0[1:2] </span><br><span class="line">[web_group:vars] </span><br><span class="line">ansible_ssh_pass=<span class="string">'123'</span> </span><br><span class="line"></span><br><span class="line">[root@m01 ~]<span class="comment"># vim /etc/hosts </span></span><br><span class="line">127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4 ::1 </span><br><span class="line">localhost localhost.localdomain localhost6 localhost6.localdomain6 </span><br><span class="line">10.0.0.7 web01 </span><br><span class="line">10.0.0.8 web02</span><br></pre></td></tr></table></figure>

<h4 id="使用秘钥连接"><a href="#使用秘钥连接" class="headerlink" title="使用秘钥连接"></a>使用秘钥连接</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.先在管理机上生成秘钥对 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ssh-keygen </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.推送公钥 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub 172.16.1.7 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub 172.16.1.8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.修改主机清单 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">[web_group] </span><br><span class="line">10.0.0.7:22</span><br><span class="line">10.0.0.8:22</span><br><span class="line"></span><br><span class="line">[root@manage01 ~]<span class="comment"># ansible web_group -m ping</span></span><br><span class="line">10.0.0.8 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong"</span></span><br><span class="line">&#125;</span><br><span class="line">10.0.0.7 | SUCCESS =&gt; &#123;</span><br><span class="line">    <span class="string">"ansible_facts"</span>: &#123;</span><br><span class="line">        <span class="string">"discovered_interpreter_python"</span>: <span class="string">"/usr/bin/python"</span></span><br><span class="line">    &#125;, </span><br><span class="line">    <span class="string">"changed"</span>: <span class="literal">false</span>, </span><br><span class="line">    <span class="string">"ping"</span>: <span class="string">"pong</span></span><br></pre></td></tr></table></figure>

<h4 id="企业使用究极进化版（☆☆☆☆☆）"><a href="#企业使用究极进化版（☆☆☆☆☆）" class="headerlink" title="企业使用究极进化版（☆☆☆☆☆）"></a>企业使用究极进化版（☆☆☆☆☆）</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">[web_group] </span><br><span class="line">web01 ansible_ssh_host=10.0.0.7 ansible_ssh_port=22</span><br><span class="line">web02 ansible_ssh_host=10.0.0.8 ansible_ssh_port=22</span><br></pre></td></tr></table></figure>

<h4 id="配置主机标签组"><a href="#配置主机标签组" class="headerlink" title="配置主机标签组"></a><strong>配置主机标签组</strong></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 标签组配置语法 </span></span><br><span class="line">[标签组名字:children] </span><br><span class="line">主机标签名1 </span><br><span class="line">主机标签名2 </span><br><span class="line"></span><br><span class="line">[lnmp:children] </span><br><span class="line">db_group</span><br><span class="line">web_group</span><br><span class="line"></span><br><span class="line"><span class="comment">## ansible主机写法： </span></span><br><span class="line"><span class="comment">### 主机清单中的所有主机 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible all -m ping</span></span><br><span class="line"><span class="comment">### 只针对某一台主机 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web01 -m ping </span></span><br><span class="line"><span class="comment">### 针对某一个IP </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible 10.0.0.7 -m ping </span></span><br><span class="line"><span class="comment">### 指定某一个标签名中的所有主机 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m ping </span></span><br><span class="line"><span class="comment">### 指定某一个标签组中的所有主机 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible lnmp -m ping</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible执行任务"><a href="#Ansible执行任务" class="headerlink" title="Ansible执行任务"></a>Ansible执行任务</h2><ul>
<li><p>Ad-hoc</p>
</li>
<li><p>playbook</p>
</li>
</ul>
<p><img src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/ad-hoc%E6%A8%A1%E5%BC%8F%E7%9A%84%E5%91%BD%E4%BB%A4%E4%BD%BF%E7%94%A8.jpg" alt="ad-hoc模式的命令使用"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ad-hoc语法： </span><br><span class="line">ansible 主机 -m 模块 -a 动作</span><br></pre></td></tr></table></figure>

<h3 id="ad-hoc结果返回颜色"><a href="#ad-hoc结果返回颜色" class="headerlink" title="ad-hoc结果返回颜色"></a>ad-hoc结果返回颜色</h3><ul>
<li><p>绿色：命令执行成功且无变化的颜色</p>
</li>
<li><p>黄色：命令执行成功，但是有变化（有更改）</p>
</li>
<li><p>红色：命令执行失败，报错msg</p>
</li>
<li><p>粉色|紫色：Warning，警告一般无需处理</p>
</li>
</ul>
<h3 id="ansible查看帮助"><a href="#ansible查看帮助" class="headerlink" title="ansible查看帮助"></a>ansible查看帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-doc 模块名 </span><br><span class="line">找到帮助信息中的：EXAMPLES</span><br></pre></td></tr></table></figure>

<h1 id="Ad-hoc常用模块"><a href="#Ad-hoc常用模块" class="headerlink" title="Ad-hoc常用模块"></a>Ad-hoc常用模块</h1><h2 id="command模块、shell模块"><a href="#command模块、shell模块" class="headerlink" title="command模块、shell模块"></a>command模块、shell模块</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m shell -a 'yum install -y httpd' </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m command -a 'yum install -y httpd' </span></span><br><span class="line"></span><br><span class="line">注意：<span class="built_in">command</span>模块不支持特殊符号</span><br></pre></td></tr></table></figure>

<h2 id="script模块"><a href="#script模块" class="headerlink" title="script模块"></a>script模块</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行脚本 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc script</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#执行本机/root目录下的test.sh脚本 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m script -a '/root/test.sh' </span></span><br><span class="line"></span><br><span class="line">优势：无需将脚本放在其他的机器上</span><br></pre></td></tr></table></figure>

<h2 id="Ansible文件管理模块"><a href="#Ansible文件管理模块" class="headerlink" title="Ansible文件管理模块"></a>Ansible文件管理模块</h2><h3 id="file模块"><a href="#file模块" class="headerlink" title="file模块"></a>file模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#file模块动作 </span></span><br><span class="line">src：指定软链接的源文件 </span><br><span class="line">dest：指定软链接的目标文件 </span><br><span class="line">path：指定文件路径 </span><br><span class="line">owner：指定文件属主 </span><br><span class="line">group：指定文件属组 </span><br><span class="line">mode：指定文件权限 </span><br><span class="line">recurse：递归 </span><br><span class="line">state：</span><br><span class="line">	- touch 创建文件 </span><br><span class="line">	- absent 删除 </span><br><span class="line">	- directory 创建目录 </span><br><span class="line">	- link 软链接 </span><br><span class="line">	- hard 硬链接</span><br><span class="line">	</span><br><span class="line"><span class="comment">## 在/opt目录下创建test目录 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m file -a 'path=/opt/test state=directory' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 在/opt目录下创建efg目录 属主www 属组www 权限200 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m file -a 'path=/opt/efg owner=www group=www mode=200 state=directory' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 在/opt目录下创建文件abc 属主www 属组www 权限200 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m file -a 'path=/opt/abc owner=www group=www mode=200 state=touch' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建软链接文件 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m file -a 'path=/usr/opt_test_link state=absent'</span></span><br></pre></td></tr></table></figure>

<h3 id="copy模块"><a href="#copy模块" class="headerlink" title="copy模块"></a>copy模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#作用：统一配置管理 </span></span><br><span class="line"></span><br><span class="line"><span class="comment">#动作：</span></span><br><span class="line">src：指定源文件的路径 </span><br><span class="line">dest：指定目标路径 </span><br><span class="line">owner：指定属主 </span><br><span class="line">group：指定属组 </span><br><span class="line">mode：指定权限</span><br><span class="line">backup：备份 </span><br><span class="line">	- yes 备份 True </span><br><span class="line">	- no 不备份 False 默认 </span><br><span class="line">remote_src：远端的源文件 </span><br><span class="line">	- yes/True </span><br><span class="line">	- no/False </span><br><span class="line">content：指定内容写入文件(只能覆盖)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 将管理端的配置文件下发到被管理端 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m copy -a 'src=/root/www.zls.com.conf dest=/opt'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用backup做备份 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m copy -a 'src=/root/www.zls.com.conf dest=/opt backup=true' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 指定属主和属组 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m copy -a 'src=/root/www.zls.com.conf dest=/opt owner=www group=www mode=644' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## remote_src指定源文件在远端 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m copy -a 'src=/opt/abc dest=/tmp remote_src=true' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## content往指定文件中写入内容 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m copy -a 'dest=/opt/rsync.passwd content="zls:123456" mode=600'</span></span><br></pre></td></tr></table></figure>

<h3 id="get-url"><a href="#get-url" class="headerlink" title="get_url"></a>get_url</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## wget 下载文件 </span></span><br><span class="line"><span class="comment">## 查看帮助 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc get_url </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作 </span></span><br><span class="line">url：下载的网址 dest：下载的路径 mode：指定权限 </span><br><span class="line"></span><br><span class="line"><span class="comment">## 下载wordpress </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m get_url -a 'url="http://test.driverzeng.com/Nginx_Code/QQ2.8.zip" dest=/opt mode=777' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 下载阿里云的base源 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m get_url -a 'url="https://mirrors.aliyun.com/repo/Centos-7.repo" dest=/opt/CentOS-Base.repo'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible软件管理模块"><a href="#Ansible软件管理模块" class="headerlink" title="Ansible软件管理模块"></a>Ansible软件管理模块</h2><h3 id="yum模块"><a href="#yum模块" class="headerlink" title="yum模块"></a>yum模块</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装rpm包 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc yum </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作： </span></span><br><span class="line">name：指定安装包的名字 </span><br><span class="line">	- http:// 从指定的url下载 yum install -y http://网址 </span><br><span class="line">	- file:// 从本地rpm包安装 yum localinstall </span><br><span class="line">	- 包名 从yum仓库中下载 yum install -y 包名 </span><br><span class="line">state：</span><br><span class="line">	- absent/removed：卸载 yum remove </span><br><span class="line">	- present/installed：安装 yum install 默认 </span><br><span class="line">	- latest：安装最新版本</span><br><span class="line">download_only：只下载不安装 </span><br><span class="line"></span><br><span class="line"><span class="comment">## 安装nginx和mysql客户端 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m yum -a 'name=nginx,mariadb'</span></span><br></pre></td></tr></table></figure>

<h3 id="yum-repository"><a href="#yum-repository" class="headerlink" title="yum_repository"></a>yum_repository</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">## 管理yum源，yum仓库 </span></span><br><span class="line"> [root@m01 ~]<span class="comment"># ansible-doc yum_repository</span></span><br><span class="line"> </span><br><span class="line"> <span class="comment">## yum源配置文件 </span></span><br><span class="line"> [base] </span><br><span class="line"> name=xxxx </span><br><span class="line"> baseurl=http://xxx </span><br><span class="line"> gpgcheck=0 </span><br><span class="line"> gpgkey=file://xxx </span><br><span class="line"> <span class="built_in">enable</span>=1</span><br><span class="line"> </span><br><span class="line"> <span class="comment">## 动作： </span></span><br><span class="line"> name：仓库的名字[base] </span><br><span class="line"> description：仓库的描述信息 name=xxxx </span><br><span class="line"> baseurl：仓库的url地址 baseurl=http://xxx </span><br><span class="line"> file：如果没有指定file则文件名和name指定的一致，如果指定了file，文件名为file指定的内容，仓库名为 name指定的内容 </span><br><span class="line"> owner：指定属主 </span><br><span class="line"> group：指定属组 </span><br><span class="line"> mode：指定权限 </span><br><span class="line"> gpgcheck：秘钥对检测 </span><br><span class="line"> 	- yes/True gpgcheck=1 </span><br><span class="line"> 	- no/False gpgcheck=0 </span><br><span class="line"> enabled：是否开启仓库 </span><br><span class="line"> 	- yes/True <span class="built_in">enable</span>=1 </span><br><span class="line"> 	- no/False <span class="built_in">enable</span>=0 </span><br><span class="line"> state：</span><br><span class="line"> 	- present：创建仓库 </span><br><span class="line"> 	- absent：删除仓库</span><br><span class="line"> 	</span><br><span class="line"><span class="comment">## 创建nginx官方的yum源 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m yum_repository -a 'name=nginx-stable description="nginx stable repo" baseurl=http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck=false enabled=true'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 结果 </span></span><br><span class="line">[root@web01 ~]<span class="comment"># vim /etc/yum.repos.d/nginx-stable.repo </span></span><br><span class="line">[nginx-stable]</span><br><span class="line">baseurl = http://nginx.org/packages/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span>/ </span><br><span class="line">enabled = 1 </span><br><span class="line">gpgcheck = 0 </span><br><span class="line">name = nginx stable repo</span><br><span class="line"></span><br><span class="line"><span class="comment">## 使用file指定yum源的文件名 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m yum_repository -a 'name=nginx-stable description="nginx stable repo" baseurl=http://nginx.org/packages/centos/$releasever/$basearch/ gpgcheck=false enabled=true file=nginx'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除仓库 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m yum_repository -a 'name=nginx-stable file=nginx state=absent'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 追加仓库到同一个文件中 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m yum_repository -a 'name=nginx-mainline description="nginx mainline repo" baseurl=http://nginx.org/packages/mainline/centos/$releasever/$basearch/ gpgcheck=false enabled=true file=nginx'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除指定的仓库名 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m yum_repository -a 'name=nginx-mainline file=nginx state=absent'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible服务管理模块"><a href="#Ansible服务管理模块" class="headerlink" title="Ansible服务管理模块"></a>Ansible服务管理模块</h2><h3 id="service、systemd"><a href="#service、systemd" class="headerlink" title="service、systemd"></a>service、systemd</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 管理服务启停 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc service </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作： </span></span><br><span class="line">name：指定服务名字 </span><br><span class="line">state：</span><br><span class="line">	- started 开启服务 </span><br><span class="line">	- reloaded 重新加载服务 </span><br><span class="line">	- stopped 停止服务 </span><br><span class="line">	- restarted 重启服务 </span><br><span class="line">enabled：开机自启 </span><br><span class="line">	- yes/True 加入开机自启 </span><br><span class="line">	- no/False 不加入开机自启 默认 </span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动nginx并加入开机自启 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m service -a 'name=nginx state=started enabled=true'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible用户管理模块"><a href="#Ansible用户管理模块" class="headerlink" title="Ansible用户管理模块"></a>Ansible用户管理模块</h2><h3 id="user"><a href="#user" class="headerlink" title="user"></a>user</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 创建用户 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc user </span></span><br><span class="line">useradd www -u 666 -g 666 -s /sbin/nologin -M </span><br><span class="line">-c：描述信息</span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作： </span></span><br><span class="line">name：用户名 </span><br><span class="line">comment：-c:指定用户描述信息 </span><br><span class="line">uid：-u:指定用户的uid </span><br><span class="line">group： -g:指定用户的组 gid </span><br><span class="line">shell： -s:指定用户登录的shell -s /sbin/nologin </span><br><span class="line">append：-a:指定附加组并追加附加组 </span><br><span class="line">groups：-G:指定用户附加组 </span><br><span class="line">state：</span><br><span class="line">	- absent 删除用户 userdel </span><br><span class="line">	- present 创建用户 useradd 默认 </span><br><span class="line">remove： </span><br><span class="line">	- yes/True userdel -r 删除用户和用户相关的文件 </span><br><span class="line">	- no/False 默认 </span><br><span class="line">ssh_key_bits：创建用户时，创建私钥，私钥的位数 2048 </span><br><span class="line">ssh_key_file：指定私钥的位置 </span><br><span class="line">create_home： </span><br><span class="line">	- yes/True 创建用户同时创建家目录 默认 </span><br><span class="line">	- no/False 创建用户不创建家目录</span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建www用户禁止登陆，不创建家目录 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m user -a 'name=www uid=666 group=666 shell=/sbin/nologin create_home=false'</span></span><br></pre></td></tr></table></figure>

<h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 管理用户组 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc group </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作：</span></span><br><span class="line">name：指定组名字 </span><br><span class="line">gid：指定组id </span><br><span class="line">state：</span><br><span class="line">	- present 创建组 groupadd 默认 </span><br><span class="line">	- absent 删除组 groupdel </span><br><span class="line">	</span><br><span class="line"><span class="comment">## 创建一个www组并且gid是666 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m group -a 'name=www gid=666'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible定时任务模块"><a href="#Ansible定时任务模块" class="headerlink" title="Ansible定时任务模块"></a>Ansible定时任务模块</h2><h3 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 管理定时任务 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc cron </span></span><br><span class="line">00 05 * * * /usr/bin/ntpdate time1.aliyun.com &amp;&gt;/dev/null </span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作: </span></span><br><span class="line">name：定时任务注释信息 </span><br><span class="line">minute：分 00 </span><br><span class="line">hour：时 04 day：日 </span><br><span class="line">month：月</span><br><span class="line">weekday：周 </span><br><span class="line">job：执行的任务 /bin/ls </span><br><span class="line">state：</span><br><span class="line">	- present 创建定时任务 默认 </span><br><span class="line">	- absent 删除定时任务 </span><br><span class="line">	</span><br><span class="line"><span class="comment">## 创建时间同步定时任务 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m cron -a 'name="time sync" minute=00 hour=04 job="/usr/bin/ntpdate time1.aliyun.com &amp;&gt;/dev/null"' </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除定时任务 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m cron -a 'name="time sync" state=absent'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible磁盘挂载模块"><a href="#Ansible磁盘挂载模块" class="headerlink" title="Ansible磁盘挂载模块"></a>Ansible磁盘挂载模块</h2><h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 管理磁盘挂载 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc mount </span></span><br><span class="line">mount -t nfs 172.16.1.31:/data /code/wordpress/wp-content/uploads </span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作：</span></span><br><span class="line">path：挂载路径 /code/wordpress/wp-content/uploads </span><br><span class="line">src：挂载源 172.16.1.31:/data </span><br><span class="line">fstype：文件类型 -t nfs </span><br><span class="line">state：</span><br><span class="line">	- present：只将挂载信息记录在/etc/fstab中（开机挂载） </span><br><span class="line">	- mounted：立刻挂载，并将配置写入/etc/fstab中 </span><br><span class="line">	- unmounted：卸载设备，但是不会清除/etc/fstab中的内容 </span><br><span class="line">	- absent：卸载设备，并清除/etc/fstab中的内容 </span><br><span class="line">	</span><br><span class="line">挂载：mounted </span><br><span class="line">卸载：absent</span><br><span class="line"></span><br><span class="line">mount -o rw,remount / </span><br><span class="line">opts: 指定挂载路径是否可读可写 rw,remount</span><br><span class="line"></span><br><span class="line"><span class="comment">## 挂载nfs </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web_group -m mount -a 'path=/code/wordpress/wp-content/uploads src=172.16.1.31:/data fstype=nfs state=mounted'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible解压模块"><a href="#Ansible解压模块" class="headerlink" title="Ansible解压模块"></a>Ansible解压模块</h2><h3 id="archive、unarchive"><a href="#archive、unarchive" class="headerlink" title="archive、unarchive"></a>archive、unarchive</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 压缩</span></span><br><span class="line"><span class="comment">## 压缩yum源</span></span><br><span class="line">- name: 压缩yum源</span><br><span class="line">	archive:</span><br><span class="line">		path: /etc/yum.repos.d/ </span><br><span class="line">		dest: /tmp/yum.tgz</span><br><span class="line">		remove: True</span><br><span class="line"></span><br><span class="line"><span class="comment"># 解压一切压缩包 </span></span><br><span class="line"><span class="comment">## 动作 </span></span><br><span class="line">src：指定压缩包路径 </span><br><span class="line">dest：指定解压的目标路径 </span><br><span class="line">owner：属主 </span><br><span class="line">group：数组 </span><br><span class="line">mode：权限 </span><br><span class="line">remote_src：告诉ansible压缩包在远端的服务器上 </span><br><span class="line">	- yes/True </span><br><span class="line">	- no/False 默认</span><br></pre></td></tr></table></figure>

<h2 id="Ansible数据库模块"><a href="#Ansible数据库模块" class="headerlink" title="Ansible数据库模块"></a>Ansible数据库模块</h2><h3 id="mysql-user"><a href="#mysql-user" class="headerlink" title="mysql_user"></a>mysql_user</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 作用：管理mysql用户 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc mysql_user </span></span><br><span class="line">mysql -uroot -p123 grant all on *.* to wp_user@<span class="string">'%'</span> identified by <span class="string">'123'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作 </span></span><br><span class="line">name：指定用户名 wp_user </span><br><span class="line">host：指定允许连接的IP主机 % </span><br><span class="line">password：指定密码 123 </span><br><span class="line">priv：指定权限 <span class="string">'*.*:ALL'</span> </span><br><span class="line">login_user：MySQL登录的用户 root </span><br><span class="line">login_password：MySQL登录用户root的密码 123 </span><br><span class="line">state：</span><br><span class="line">	- present 创建 </span><br><span class="line">	- absent 删除</span><br><span class="line">	</span><br><span class="line"><span class="comment">## MySQL 跳过反向解析，不让IP地址解析成主机名 </span></span><br><span class="line">vim /etc/my.cnf </span><br><span class="line">[mysqld] </span><br><span class="line">skip_name_resolve </span><br><span class="line"></span><br><span class="line">[root@db01 ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line">[root@db01 ~]<span class="comment"># mysql -utest -p123 -h172.16.1.51</span></span><br></pre></td></tr></table></figure>

<h3 id="mysql-db"><a href="#mysql-db" class="headerlink" title="mysql_db"></a>mysql_db</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 管理mysql库</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-doc mysql_db</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### 创建数据库 </span></span><br><span class="line">create database wordpress; </span><br><span class="line"><span class="comment">### 导出wordpress库数据 </span></span><br><span class="line">mysqldump -uroot -p123 -B wordpress &gt; /tmp/wordpress.sql</span><br><span class="line"></span><br><span class="line"><span class="comment">## 动作</span></span><br><span class="line">name：指定库名 </span><br><span class="line">wordpress target：导出数据指定存放sql文件的路径 </span><br><span class="line">login_user：指定登录的用户 </span><br><span class="line">login_password：指定登录的密码 </span><br><span class="line">state：</span><br><span class="line">	- present 创建 </span><br><span class="line">	- absent 删除 </span><br><span class="line">  - import 导入数据</span><br><span class="line">	- dump 导出数据</span><br></pre></td></tr></table></figure>

<h2 id="setup模块"><a href="#setup模块" class="headerlink" title="setup模块"></a>setup模块</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#获取主机信息</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible web01 -m setup -i /root/wordpress_ansible/base/hosts</span></span><br><span class="line">ansible_all_ipv4_addresses：仅显示ipv4的信息</span><br><span class="line">ansible_devices：仅显示磁盘设备信息</span><br><span class="line">ansible_distribution：显示是什么系统，例：centos,suse等</span><br><span class="line">ansible_distribution_major_version：显示是系统主版本</span><br><span class="line">ansible_distribution_version：仅显示系统版本</span><br><span class="line">ansible_machine：显示系统类型，例：32位，还是64位</span><br><span class="line">ansible_eth0：仅显示eth0的信息</span><br><span class="line">ansible_hostname：仅显示主机名</span><br><span class="line">ansible_kernel：仅显示内核版本</span><br><span class="line">ansible_lvm：显示lvm相关信息</span><br><span class="line">ansible_memtotal_mb：显示系统总内存</span><br><span class="line">ansible_memfree_mb：显示可用系统内存</span><br><span class="line">ansible_memory_mb：详细显示内存情况</span><br><span class="line">ansible_swaptotal_mb：显示总的swap内存</span><br><span class="line">ansible_swapfree_mb：显示swap内存的可用内存</span><br><span class="line">ansible_mounts：显示系统磁盘挂载情况</span><br><span class="line">ansible_processor：显示cpu个数(具体显示每个cpu的型号)</span><br><span class="line">ansible_processor_vcpus：显示cpu个数(只显示总的个数)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 主机名 </span></span><br><span class="line">ansible_hostname // 显示第一个.之前的主机名 </span><br><span class="line">ansible_fqdn // 显示完整的主机名 </span><br><span class="line"></span><br><span class="line"><span class="comment">## 内存 </span></span><br><span class="line">ansible_memtotal_mb // 总内存 </span><br><span class="line">ansible_memfree_mb // 空闲内存 </span><br><span class="line">ansible_swaptotal_mb // 总虚拟内存 </span><br><span class="line">ansible_swapfree_mb // 空闲虚拟内存</span><br><span class="line"></span><br><span class="line"><span class="comment">## CPU </span></span><br><span class="line">ansible_processor_cores // cpu核心数 </span><br><span class="line"></span><br><span class="line"><span class="comment">## 系统 </span></span><br><span class="line">ansible_os_family // 系统类型 </span><br><span class="line">RedHat Debain ansible_distribution // 系统发行版 </span><br><span class="line">CentOS ansible_distribution_major_version // 版本号 7 </span><br><span class="line">ansible_distribution_version // 详细版本号 7.6 </span><br><span class="line"></span><br><span class="line"><span class="comment">## IP相关 </span></span><br><span class="line">ansible_dns.nameservers // DNS </span><br><span class="line">ansible_default_ipv4.address // eth0外网IP </span><br><span class="line">ansible_eth0.ipv4.address // eth0外网IP </span><br><span class="line">ansible_eth1.ipv4.address // eth1内网IP </span><br><span class="line"></span><br><span class="line"><span class="comment">## 磁盘 </span></span><br><span class="line">ansible_devices.sda.partitions.sda1.size // sda1分区的磁盘大小：/boot分区 </span><br><span class="line">ansible_devices.sda.partitions.sda3.size // sda3分区的磁盘大小: /分区</span><br></pre></td></tr></table></figure>

<h2 id="快速搭建rsync"><a href="#快速搭建rsync" class="headerlink" title="快速搭建rsync"></a>快速搭建rsync</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 准备rsync配置文件 </span></span><br><span class="line">uid = rsync </span><br><span class="line">gid = rsync </span><br><span class="line">port = 873 </span><br><span class="line">fake super = yes </span><br><span class="line">use chroot = no </span><br><span class="line">max connections = 200 </span><br><span class="line">timeout = 600 </span><br><span class="line">ignore errors </span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">false</span> </span><br><span class="line">list = <span class="literal">false</span> </span><br><span class="line">auth users = rsync_backup </span><br><span class="line">secrets file = /etc/rsync.passwd </span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log </span><br><span class="line"><span class="comment">##################################### </span></span><br><span class="line">[backup] </span><br><span class="line">comment = welcome to oldboyedu backup! </span><br><span class="line">path = /backup</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.安装rsync </span></span><br><span class="line">ansible web01 -m yum -a <span class="string">'name=rsync'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.修改配置文件 </span></span><br><span class="line">ansible web01 -m copy -a <span class="string">'src=/root/rsyncd.conf dest=/etc/'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#3.创建密码文件 </span></span><br><span class="line">ansible web01 -m copy -a <span class="string">'content="rsync_backup:123456" dest=/etc/rsync.pass mode=600'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#4.创建 www用户 </span></span><br><span class="line">ansible web01 -m group -a <span class="string">'name=www gid=666'</span> ansible web01 -m user -a <span class="string">'name=www uid=666 group=666 shell=/sbin/nologin create_home=false'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#5.创建备份目录 </span></span><br><span class="line">ansible web01 -m file -a <span class="string">'path=/backup owner=www group=www state=directory'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#6.启动服务 </span></span><br><span class="line">ansible web01 -m service -a <span class="string">'name=rsyncd state=started enabled=true'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#7.客户端 </span></span><br><span class="line">ansible web02 -m yum -a <span class="string">'name=rsync'</span> </span><br><span class="line"></span><br><span class="line"><span class="comment">#8.创建密码文件 </span></span><br><span class="line">ansible web02 -m copy -a <span class="string">'content="123456" dest=/etc/rsync.pass mode=600'</span></span><br></pre></td></tr></table></figure>

<h2 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h2><p>1.部署rsync</p>
<p>2.部署nfs</p>
<p>3.部署httpd，载上传作业的目录</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zuoye代码压缩包 </span></span><br><span class="line"><span class="comment"># rsync配置文件 </span></span><br><span class="line">uid = www </span><br><span class="line">gid = www </span><br><span class="line">port = 873 </span><br><span class="line">fake super = yes </span><br><span class="line">use chroot = no </span><br><span class="line">max connections = 200 </span><br><span class="line">timeout = 600 </span><br><span class="line">ignore errors </span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">false</span> </span><br><span class="line">list = <span class="literal">false</span> </span><br><span class="line">auth users = rsync_backup </span><br><span class="line">secrets file = /etc/rsync.passwd </span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log </span><br><span class="line"><span class="comment">##################################### </span></span><br><span class="line">[backup] </span><br><span class="line">comment = welcome to oldboyedu backup! </span><br><span class="line">path = /backup </span><br><span class="line"></span><br><span class="line"><span class="comment"># httpd配置文件 </span></span><br><span class="line">User www </span><br><span class="line">Group www</span><br><span class="line"></span><br><span class="line">[root@m01 web]<span class="comment"># ll</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主机清单 </span></span><br><span class="line">[root@m01]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">[web_group] </span><br><span class="line">web01 ansible_ssh_host=10.0.0.7 web02 ansible_ssh_host=10.0.0.8 </span><br><span class="line">[nfs_group] </span><br><span class="line">nfs ansible_ssh_host=10.0.0.31 </span><br><span class="line">[backup_group] </span><br><span class="line">backup ansible_ssh_host=10.0.0.41</span><br><span class="line">[rsyncd:children]</span><br><span class="line">nfs_group</span><br><span class="line">backup_group</span><br><span class="line"></span><br><span class="line"><span class="comment"># 推送公钥</span></span><br><span class="line">[root@m01]<span class="comment"># yum install -y sshpass</span></span><br><span class="line">[root@m01]<span class="comment"># sh ssh_key.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">. /etc/init.d/<span class="built_in">functions</span></span><br><span class="line">ls -l ~/.ssh/id_rsa &amp;&gt;/dev/null || ssh-keygen -t rsa -P <span class="string">''</span> -f ~/.ssh/id_rsa &amp;&gt;/dev/null</span><br><span class="line"><span class="keyword">for</span> n <span class="keyword">in</span> 7 8 31 41;<span class="keyword">do</span></span><br><span class="line">        sshpass -p 12 ssh-copy-id -o <span class="string">'StrictHostKeyChecking no'</span> -i ~/.ssh/id_rsa.pub root@10.0.0.<span class="variable">$n</span> &amp;&gt;/dev/null &amp;&amp; \</span><br><span class="line">        action <span class="string">"10.0.0.<span class="variable">$n</span> send public key "</span> /bin/<span class="literal">true</span> || \</span><br><span class="line">        action <span class="string">"10.0.0.<span class="variable">$n</span> send public key "</span> /bin/<span class="literal">false</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>

<h3 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">WanIP</th>
<th align="center">LanIP</th>
<th align="center">角色</th>
<th align="center">应用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">m01</td>
<td align="center">10.0.0.61</td>
<td align="center">172.16.1.61</td>
<td align="center">ansible管理机</td>
<td align="center">ansible</td>
</tr>
<tr>
<td align="center">web01</td>
<td align="center">10.0.0.7</td>
<td align="center">172.16.1.7</td>
<td align="center">作业网站</td>
<td align="center">httpd、php、nfs</td>
</tr>
<tr>
<td align="center">web02</td>
<td align="center">10.0.0.8</td>
<td align="center">172.16.1.8</td>
<td align="center">作业网站</td>
<td align="center">httpd、php、nfs</td>
</tr>
<tr>
<td align="center">nfs</td>
<td align="center">10.0.0.31</td>
<td align="center">172.16.1.31</td>
<td align="center">共享存储</td>
<td align="center">nfs、rsync</td>
</tr>
<tr>
<td align="center">backup</td>
<td align="center">10.0.0.41</td>
<td align="center">172.16.1.41</td>
<td align="center">实时同步备份</td>
<td align="center">nfs、rsync</td>
</tr>
</tbody></table>
<h3 id="编写Ad-hoc"><a href="#编写Ad-hoc" class="headerlink" title="编写Ad-hoc"></a>编写Ad-hoc</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建www用户</span></span><br><span class="line">ansible all -m group -a <span class="string">'name=www gid=666'</span></span><br><span class="line">ansible all -m user -a <span class="string">'name=www uid=666 group=666 shell=/sbin/nologin create_home=false'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1.安装rsync,nfs </span></span><br><span class="line">ansible rsyncd -m yum -a <span class="string">'name=rsync,nfs-utils state=present'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2.rsync服务端操作 </span></span><br><span class="line">ansible backup -m copy -a <span class="string">'src=/root/web/rsyncd.conf dest=/etc/'</span> </span><br><span class="line">ansible backup -m copy -a <span class="string">'content=rsync_backup:123 dest=/etc/rsync.passwd mode=600'</span></span><br><span class="line">ansible backup -m file -a <span class="string">'path=/backup owner=www group=www mode=755 state=directory'</span></span><br><span class="line">ansible backup -m service -a <span class="string">'name=rsyncd state=started'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#3.rsync客户端 </span></span><br><span class="line">ansible nfs -m copy -a <span class="string">'content=123 dest=/etc/rsync.passwd mode=600'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#4.nfs服务端 </span></span><br><span class="line">ansible nfs -m copy -a <span class="string">'content="/data 172.16.1.0/24(rw,sync,anonuid=666,anongid=666,all_squash)" dest=/etc/exports'</span> </span><br><span class="line">ansible nfs -m file -a <span class="string">'path=/data owner=www group=www mode=755 state=directory'</span> </span><br><span class="line">ansible nfs -m service -a <span class="string">'name=nfs state=started'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#5.web服务器操作 </span></span><br><span class="line">ansible web_group -m yum -a <span class="string">'name=httpd,php state=present'</span> </span><br><span class="line">ansible web_group -m copy -a <span class="string">'src=/root/web/httpd.conf dest=/etc/httpd/conf'</span> </span><br><span class="line">ansible web_group -m unarchive -a <span class="string">'src=/root/web/kaoshi.tgz dest=/var/www/html owner=www group=www'</span> </span><br><span class="line">ansible web_group -m file -a <span class="string">'path=/var/www/html/user_data owner=www group=www state=directory'</span> </span><br><span class="line">ansible web_group -m mount -a <span class="string">'src=172.16.1.31:/data fstype=nfs path=/var/www/html/user_data state=mounted'</span> </span><br><span class="line">ansible web_group -m service -a <span class="string">'name=httpd state=started'</span></span><br></pre></td></tr></table></figure>

<h1 id="Ansible剧本playbook"><a href="#Ansible剧本playbook" class="headerlink" title="Ansible剧本playbook"></a>Ansible剧本playbook</h1><blockquote>
<p> <strong>Q：什么是playbook？</strong></p>
<p> playbook：剧本，兵书之意</p>
<p> playbook是由什么组成</p>
<ul>
<li><p>play：定义主机和角色（主角，配角定义）</p>
</li>
<li><p>task：任务（角色的台词和动作）</p>
<p>在playbook中一个play可以由多个task组成</p>
</li>
</ul>
</blockquote>
<h2 id="playbook语法"><a href="#playbook语法" class="headerlink" title="playbook语法"></a>playbook语法</h2><h3 id="yaml语法"><a href="#yaml语法" class="headerlink" title="yaml语法"></a>yaml语法</h3><ul>
<li><p>缩进：每一个层级，要缩进两个空格</p>
</li>
<li><p>冒号：除了以冒号结尾的内容，冒号后面都要加一个空格</p>
</li>
<li><p>横杠：横杠后面要有空格（Python 列表数据类型）</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group <span class="comment">## play部分，指定要执行的主机 </span></span><br><span class="line">  remote_user: root <span class="comment">## 以root身份执行 （默认） </span></span><br><span class="line">  tasks: <span class="comment">## 定义任务 </span></span><br><span class="line">  - name: install httpd and php <span class="comment">## 给任务起名 </span></span><br><span class="line">	yum: <span class="comment">## 模块 </span></span><br><span class="line">	- httpd <span class="comment">## 动作 </span></span><br><span class="line">	- php </span><br><span class="line">  - name: configure httpd conf </span><br><span class="line">	copy: </span><br><span class="line">      src: /root/web/httpd.conf </span><br><span class="line">      dest: /etc/httpd/conf</span><br></pre></td></tr></table></figure>

<p>ansible 写playbook后缀 .yml 或者 .yaml</p>
<p>saltstack 写sls文件 后缀 .sls</p>
<h2 id="playbook小练习"><a href="#playbook小练习" class="headerlink" title="playbook小练习"></a>playbook小练习</h2><p><strong>安装httpd</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.创建工作目录 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># mkdir /root/ansible</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.编写httpd剧本 </span></span><br><span class="line">[root@m01 ansible]<span class="comment"># vim httpd.yml</span></span><br><span class="line">- hosts: web_group </span><br><span class="line">  tasks: </span><br><span class="line">  	- name: Install httpd </span><br><span class="line">	  yum:</span><br><span class="line">	  	name: httpd </span><br><span class="line">	  	state: present</span><br><span class="line">		</span><br><span class="line"><span class="comment"># 3.执行剧本 </span></span><br><span class="line">[root@m01 ansible]<span class="comment"># ansible-playbook httpd.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 检测剧本语法 </span></span><br><span class="line">[root@m01 ansible]<span class="comment"># ansible-playbook --syntax-check httpd.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 测试执行 </span></span><br><span class="line">[root@m01 ansible]<span class="comment"># ansible-playbook -C httpd.yml</span></span><br></pre></td></tr></table></figure>

<p><strong>启动httpd并加入开机自启</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group </span><br><span class="line">  tasks: </span><br><span class="line">  - name: Install httpd </span><br><span class="line">    yum:</span><br><span class="line">      name: httpd </span><br><span class="line">      state: present </span><br><span class="line">  - name: Start httpd Service </span><br><span class="line">    service: </span><br><span class="line">      name: httpd </span><br><span class="line">      state: started </span><br><span class="line">      enabled: True</span><br></pre></td></tr></table></figure>

<p><strong>编写http前端页面</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ansible]<span class="comment"># cat httpd.yml </span></span><br><span class="line">- hosts: web_group </span><br><span class="line">  tasks: </span><br><span class="line">    - name: Install httpd </span><br><span class="line">      yum:</span><br><span class="line">        name: httpd </span><br><span class="line">        state: present </span><br><span class="line">    - name: Start httpd Service </span><br><span class="line">      service: </span><br><span class="line">        name: httpd </span><br><span class="line">        state: started </span><br><span class="line">        enabled: True </span><br><span class="line">    - name: Set Web Index </span><br><span class="line">      copy: </span><br><span class="line">        content: roger_http_web </span><br><span class="line">        dest: /var/www/html/index.html</span><br></pre></td></tr></table></figure>

<p><strong>不同的主机配置不同的网站</strong></p>
<p>目前来说，想要根据不同主机配置不同的网站，我们可以使用多个play的方式，但是在生产环境中，我们需要写循环，来满足我们的需求，多个play了解即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ansible]<span class="comment"># cat httpd.yml </span></span><br><span class="line">- hosts: web_group </span><br><span class="line">  tasks: </span><br><span class="line">  - name: Install httpd </span><br><span class="line">    yum:</span><br><span class="line">      name: httpd </span><br><span class="line">      state: present </span><br><span class="line">  - name: Start httpd Service </span><br><span class="line">    service: </span><br><span class="line">      name: httpd </span><br><span class="line">      state: started </span><br><span class="line">      enabled: True </span><br><span class="line"></span><br><span class="line">- hosts: web01 </span><br><span class="line">  tasks: </span><br><span class="line">  - name: Set Web01 Index </span><br><span class="line">    copy: </span><br><span class="line">      content: roger_http_web01 </span><br><span class="line">      dest: /var/www/html/index.html </span><br><span class="line">    </span><br><span class="line">- hosts: web02 </span><br><span class="line">  tasks: </span><br><span class="line">  - name: Set Web01 Index </span><br><span class="line">    copy: </span><br><span class="line">      content: roger_http_web02 </span><br><span class="line">      dest: /var/www/html/index.html</span><br></pre></td></tr></table></figure>

<h2 id="playbook实战"><a href="#playbook实战" class="headerlink" title="playbook实战"></a>playbook实战</h2><p>1.部署rsync</p>
<p>2.部署nfs</p>
<p>3.部署httpd，载上传作业的目录</p>
<h3 id="环境准备-2"><a href="#环境准备-2" class="headerlink" title="环境准备"></a>环境准备</h3><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">WanIP</th>
<th align="center">LanIP</th>
<th align="center">角色</th>
<th align="center">应用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">m01</td>
<td align="center">10.0.0.61</td>
<td align="center">172.16.1.61</td>
<td align="center">ansible管理机</td>
<td align="center">ansible</td>
</tr>
<tr>
<td align="center">web01</td>
<td align="center">10.0.0.7</td>
<td align="center">172.16.1.7</td>
<td align="center">作业网站</td>
<td align="center">httpd、php、nfs</td>
</tr>
<tr>
<td align="center">web02</td>
<td align="center">10.0.0.8</td>
<td align="center">172.16.1.8</td>
<td align="center">作业网站</td>
<td align="center">httpd、php、nfs</td>
</tr>
<tr>
<td align="center">nfs</td>
<td align="center">10.0.0.31</td>
<td align="center">172.16.1.31</td>
<td align="center">共享存储</td>
<td align="center">nfs、rsync</td>
</tr>
<tr>
<td align="center">backup</td>
<td align="center">10.0.0.41</td>
<td align="center">172.16.1.41</td>
<td align="center">实时同步备份</td>
<td align="center">nfs、rsync</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#准备工作</span></span><br><span class="line">[root@m01 web]<span class="comment"># ll </span></span><br><span class="line">total 44 </span><br><span class="line">-rw-r--r-- 1 root root 11753 Jun 28 16:41 httpd.conf </span><br><span class="line">-rw-r--r-- 1 root root 26868 Jun 28 16:52 kaoshi.tgz </span><br><span class="line">-rw-r--r-- 1 root root 336 Jun 27 20:35 rsyncd.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">#剧本编辑</span></span><br><span class="line">[root@m01 ansible]<span class="comment"># vim lnmp.yml</span></span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Create www group</span><br><span class="line">    group:</span><br><span class="line">      name: www</span><br><span class="line">      gid: 666</span><br><span class="line">      </span><br><span class="line">  - name: Create www user</span><br><span class="line">    user:</span><br><span class="line">      name: www</span><br><span class="line">      uid: 666</span><br><span class="line">      group: <span class="string">'666'</span></span><br><span class="line">      shell: /sbin/nologin</span><br><span class="line">      create_home: False</span><br><span class="line">  	    </span><br><span class="line">- hosts: rsyncd</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Install rsync,nfs-utils Service</span><br><span class="line">    yum:</span><br><span class="line">      name:</span><br><span class="line">        - rsync</span><br><span class="line">        - nfs-utils</span><br><span class="line">      state: present</span><br><span class="line">      </span><br><span class="line">- hosts: backup</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Configure rsync Conf</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/web/rsyncd.conf</span><br><span class="line">      dest: /etc/</span><br><span class="line">      </span><br><span class="line">  - name: Configure rsync.passwd File</span><br><span class="line">    copy:</span><br><span class="line">      content: rsync_backup:123</span><br><span class="line">      dest: /etc/rsync.passwd</span><br><span class="line">      mode: 0600</span><br><span class="line">      </span><br><span class="line">  - name: Create backup Directory</span><br><span class="line">    file:</span><br><span class="line">      path: /backup</span><br><span class="line">      owner: www</span><br><span class="line">      group: www</span><br><span class="line">      mode: 0755</span><br><span class="line">      state: directory</span><br><span class="line">      </span><br><span class="line">  - name: Start rsync Service</span><br><span class="line">    service:</span><br><span class="line">      name: rsyncd</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line"> </span><br><span class="line">- hosts: nfs</span><br><span class="line">  tasks:</span><br><span class="line">  - name: Create Client rsync.passwd File</span><br><span class="line">    copy:</span><br><span class="line">      content: 123</span><br><span class="line">      dest: /etc/rsync.passwd</span><br><span class="line">      mode: 0600</span><br><span class="line">      </span><br><span class="line">  - name: Configure nfs Conf</span><br><span class="line">    copy:</span><br><span class="line">      content: <span class="string">"/data 172.16.1.0/24(rw,sync,anonuid=666,anongid=666,all_squash)</span></span><br><span class="line"><span class="string">      dest: /etc/exports</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">  - name: Create nfs Directory</span></span><br><span class="line"><span class="string">    file:</span></span><br><span class="line"><span class="string">      path: /data</span></span><br><span class="line"><span class="string">      owner: www</span></span><br><span class="line"><span class="string">      group: www</span></span><br><span class="line"><span class="string">      mode: 0755</span></span><br><span class="line"><span class="string">      state: directory</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">  - name: Start nfs Service</span></span><br><span class="line"><span class="string">    service:</span></span><br><span class="line"><span class="string">      name: nfs</span></span><br><span class="line"><span class="string">      state: started</span></span><br><span class="line"><span class="string">      enabled: True</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">- hosts: web_group</span></span><br><span class="line"><span class="string">  tasks:</span></span><br><span class="line"><span class="string">  - name: Install httpd,php Service</span></span><br><span class="line"><span class="string">    yum:</span></span><br><span class="line"><span class="string">      name:</span></span><br><span class="line"><span class="string">        - httpd</span></span><br><span class="line"><span class="string">        - php</span></span><br><span class="line"><span class="string">      state: present</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">  - name: Configure httpd Conf</span></span><br><span class="line"><span class="string">    copy:</span></span><br><span class="line"><span class="string">      src: /root/web/httpd.conf</span></span><br><span class="line"><span class="string">      dest: /etc/httpd/conf</span></span><br><span class="line"><span class="string">  </span></span><br><span class="line"><span class="string">  - name: Unarchive php Service</span></span><br><span class="line"><span class="string">    unarchive:</span></span><br><span class="line"><span class="string">      src: /root/web/kaoshi.tgz</span></span><br><span class="line"><span class="string">      dest: /var/www/html</span></span><br><span class="line"><span class="string">      owner: www</span></span><br><span class="line"><span class="string">      group: www</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">  - name: Deplay kaoshi Code</span></span><br><span class="line"><span class="string">    unarchive:</span></span><br><span class="line"><span class="string">      src: /root/web/kaoshi.tgz</span></span><br><span class="line"><span class="string">      dest: /var/www/html</span></span><br><span class="line"><span class="string">      owner: www</span></span><br><span class="line"><span class="string">      group: www</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">  - name: Create user_data Directory</span></span><br><span class="line"><span class="string">    file:</span></span><br><span class="line"><span class="string">      path: /var/www/html/user_data</span></span><br><span class="line"><span class="string">      owner: www</span></span><br><span class="line"><span class="string">      group: www</span></span><br><span class="line"><span class="string">      mode: 0755</span></span><br><span class="line"><span class="string">      state: directory</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">  - name: Mount user_data Directory</span></span><br><span class="line"><span class="string">    mount:</span></span><br><span class="line"><span class="string">      src: 172.16.1.31:/data</span></span><br><span class="line"><span class="string">      path: /var/www/html/user_data</span></span><br><span class="line"><span class="string">      fstype: nfs</span></span><br><span class="line"><span class="string">      state: mounted</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">  - name: Start httpd Service</span></span><br><span class="line"><span class="string">    service:</span></span><br><span class="line"><span class="string">      name: httpd</span></span><br><span class="line"><span class="string">      state: started</span></span><br><span class="line"><span class="string">      enabled: True</span></span><br><span class="line"><span class="string">      </span></span><br><span class="line"><span class="string">stat -c %a /var/www/html/user_data/</span></span><br></pre></td></tr></table></figure>

<h2 id="playbook部署wordpress"><a href="#playbook部署wordpress" class="headerlink" title="playbook部署wordpress"></a>playbook部署wordpress</h2><table>
<thead>
<tr>
<th align="center">主机名</th>
<th align="center">WanIP</th>
<th align="center">LanIP</th>
<th align="center">角色</th>
<th align="center">应用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">m01</td>
<td align="center">10.0.0.61</td>
<td align="center">172.16.1.61</td>
<td align="center">ansible管理机</td>
<td align="center">ansible</td>
</tr>
<tr>
<td align="center">web01</td>
<td align="center">10.0.0.7</td>
<td align="center">172.16.1.7</td>
<td align="center">wordpress</td>
<td align="center">httpd、php、nfs</td>
</tr>
<tr>
<td align="center">web02</td>
<td align="center">10.0.0.8</td>
<td align="center">172.16.1.8</td>
<td align="center">wordpress</td>
<td align="center">httpd、php、nfs</td>
</tr>
<tr>
<td align="center">nfs</td>
<td align="center">10.0.0.31</td>
<td align="center">172.16.1.31</td>
<td align="center">共享存储</td>
<td align="center">nfs、rsync</td>
</tr>
<tr>
<td align="center">backup</td>
<td align="center">10.0.0.41</td>
<td align="center">172.16.1.41</td>
<td align="center">实时同步备份</td>
<td align="center">nfs、rsync</td>
</tr>
<tr>
<td align="center">db01</td>
<td align="center">10.0.0.51</td>
<td align="center">172.16.1.51</td>
<td align="center">数据库</td>
<td align="center">MariaDB、MySQL-python</td>
</tr>
</tbody></table>
<h3 id="准备工作-1"><a href="#准备工作-1" class="headerlink" title="准备工作"></a>准备工作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.规划目录 </span></span><br><span class="line">[root@m01 ~]<span class="comment"># tree /root/wordpress_ansible/</span></span><br><span class="line">/root/wordpress_ansible/</span><br><span class="line">├── base</span><br><span class="line">│    ├── hosts</span><br><span class="line">│    └── ssh_key.sh</span><br><span class="line">├── lnmp.yml </span><br><span class="line">├── mariadb </span><br><span class="line">│    ├── my.cnf </span><br><span class="line">│    └── wp_ansible.sql</span><br><span class="line">├── nfs </span><br><span class="line">│    └── 2022.tgz </span><br><span class="line">├── nginx_php </span><br><span class="line">│    ├── blog.roger.com.conf</span><br><span class="line">│    ├── nginx.conf </span><br><span class="line">│    ├── nginx_php.tgz</span><br><span class="line">│    └── www.conf </span><br><span class="line">├── rsync </span><br><span class="line">│    └── rsyncd.conf</span><br><span class="line">├── test.yml</span><br><span class="line">├── wordpress</span><br><span class="line">│    └── wordpress.tgz</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.安装wordpress</span></span><br><span class="line"><span class="comment">## 创建用户</span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># groupadd www -g 666 </span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># useradd www -u 666 -g 666 -s /sbin/nologin -M</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改nginx配置文件</span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">user www;</span><br><span class="line">[root@m01 ngx_php]<span class="comment"># cp /etc/nginx/nginx.conf /root/wordpress_ansible/nginx_php/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 修改php配置文件</span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># vim /etc/php-fpm.d/www.conf</span></span><br><span class="line">[www] </span><br><span class="line">user = www </span><br><span class="line">group = www </span><br><span class="line">listen = /dev/shm/php.sock </span><br><span class="line">listen.owner = www </span><br><span class="line">listen.group = www</span><br><span class="line">[root@m01 ngx_php]<span class="comment"># cp /etc/php-fpm.d/www.conf /root/wordpress_ansible/nginx_php/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 编辑nginx服务配置</span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># vim /etc/nginx/conf.d/blog.roger.com.conf</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 80; </span><br><span class="line">	server_name blog.roger.com; </span><br><span class="line">	root /code/wordpress; </span><br><span class="line">	index index.php index.html; </span><br><span class="line">	</span><br><span class="line">	location ~ \.php$ &#123; </span><br><span class="line">		fastcgi_pass unix:/dev/shm/php.sock; </span><br><span class="line">		fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>; </span><br><span class="line">		include fastcgi_params; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># cp /etc/nginx/conf.d/blog.roger.com.conf /root/wordpress_ansible/nginx_php/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动nginx、php服务</span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># systemctl start nginx php-fpm</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 部署wordpress</span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># mkdir /code </span></span><br><span class="line">[root@m01 ngx_php]<span class="comment"># wget https://cn.wordpress.org/latest-zh_CN.tar.gz -O /code/latest- zh_CN.tar.gz</span></span><br></pre></td></tr></table></figure>

<h3 id="数据备份"><a href="#数据备份" class="headerlink" title="数据备份"></a>数据备份</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 code]<span class="comment"># tar zcf wordpress.tgz wordpress/ </span></span><br><span class="line">[root@db01 ~]<span class="comment"># mysqldump -uroot -p123 wordpress &gt; /opt/wp_ansible.sql </span></span><br><span class="line">[root@db01 ~]<span class="comment"># scp /opt/wp_ansible.sql 172.16.1.61:/root/wordpress_ansible/mariadb </span></span><br><span class="line">[root@m01 code]<span class="comment"># cp wordpress.tgz /root/wordpress_ansible/wordpress/</span></span><br><span class="line">[root@m01 code]<span class="comment"># vim /root/wordpress_ansible/rsync/rsyncd.conf</span></span><br><span class="line">uid = www </span><br><span class="line">gid = www </span><br><span class="line">port = 873 </span><br><span class="line">fake super = yes </span><br><span class="line">use chroot = no </span><br><span class="line">max connections = 200 </span><br><span class="line">timeout = 600 </span><br><span class="line">ignore errors </span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">false</span> </span><br><span class="line">list = <span class="literal">false</span> </span><br><span class="line">auth users = rsync_backup </span><br><span class="line">secrets file = /etc/rsync.passwd </span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log </span><br><span class="line"><span class="comment">##################################### </span></span><br><span class="line">[backup] </span><br><span class="line">comment = welcome to oldboyedu backup! </span><br><span class="line">path = /backup</span><br></pre></td></tr></table></figure>

<h3 id="lnmp-yml"><a href="#lnmp-yml" class="headerlink" title="lnmp.yml"></a>lnmp.yml</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 创建www组</span><br><span class="line">    group:</span><br><span class="line">      name: www</span><br><span class="line">      gid: 666</span><br><span class="line"></span><br><span class="line">  - name: 创建www用户</span><br><span class="line">    user:</span><br><span class="line">      name: www</span><br><span class="line">      uid: 666</span><br><span class="line">      group: 666</span><br><span class="line">      shell: /sbin/nologin</span><br><span class="line">      create_home: False</span><br><span class="line"></span><br><span class="line">  - name: 更新yum缓存</span><br><span class="line">    shell: yum makecache</span><br><span class="line"></span><br><span class="line">- hosts: rsyncd</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 安装rsync, nfs-utils服务</span><br><span class="line">    yum:</span><br><span class="line">      name:</span><br><span class="line">        - rsync</span><br><span class="line">        - nfs-utils</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">- hosts: backup_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 创建backup目录</span><br><span class="line">    file:</span><br><span class="line">      path: /backup</span><br><span class="line">      owner: www </span><br><span class="line">      group: www </span><br><span class="line">      mode: 0755</span><br><span class="line">      state: directory</span><br><span class="line"></span><br><span class="line">  - name: 推送rsync配置文件</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/ansible_wordpress/rsync/rsyncd.conf</span><br><span class="line">      dest: /etc</span><br><span class="line"></span><br><span class="line">  - name: 创建rsync密码文件</span><br><span class="line">    copy:</span><br><span class="line">      content: <span class="string">'rsync_backup:123'</span></span><br><span class="line">      dest: /etc/rsync.passwd</span><br><span class="line">      mode: 0600</span><br><span class="line"></span><br><span class="line">  - name: 启动rsync服务</span><br><span class="line">    service:</span><br><span class="line">      name: rsyncd</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line"></span><br><span class="line">- hosts: nfs_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 创建data目录</span><br><span class="line">    file:</span><br><span class="line">      path: /data</span><br><span class="line">      owner: www </span><br><span class="line">      group: www </span><br><span class="line">      mode: 0755</span><br><span class="line">      state: directory</span><br><span class="line"></span><br><span class="line">  - name: 创建rsync密码文件</span><br><span class="line">    copy:</span><br><span class="line">      content: <span class="string">'123'</span></span><br><span class="line">      dest: /etc/rsync.passwd</span><br><span class="line">      mode: 0600</span><br><span class="line"></span><br><span class="line">  - name: 修改nfs配置文件</span><br><span class="line">    copy:</span><br><span class="line">      content: <span class="string">'/data 172.16.1.0/24(rw,sync,anonuid=666,anongid=666,all_squash)'</span></span><br><span class="line">      dest: /etc/exports</span><br><span class="line"></span><br><span class="line">  - name: 解压静态图片</span><br><span class="line">    unarchive:</span><br><span class="line">      src: /root/ansible_wordpress/nfs/2023.tar.gz</span><br><span class="line">      dest: /data</span><br><span class="line">      owner: www</span><br><span class="line">      group: www</span><br><span class="line">      mode: 0755</span><br><span class="line"></span><br><span class="line">  - name: 启动nfs服务</span><br><span class="line">    service:</span><br><span class="line">      name: nfs</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line"></span><br><span class="line">- hosts: web_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 安装nfs-utils</span><br><span class="line">    yum:</span><br><span class="line">      name: nfs-utils</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">  - name: 创建站点目录</span><br><span class="line">    file:</span><br><span class="line">      path: /code</span><br><span class="line">      owner: www</span><br><span class="line">      group: www </span><br><span class="line">      mode: 0755</span><br><span class="line">      state: directory</span><br><span class="line"></span><br><span class="line">  - name: 推送nginx,php安装包</span><br><span class="line">    unarchive:</span><br><span class="line">      src: /root/ansible_wordpress/nginx_php/nginx_php.tgz</span><br><span class="line">      dest: /code</span><br><span class="line"></span><br><span class="line">  - name: 安装nginx,php服务</span><br><span class="line">    shell: <span class="string">'cd /code &amp;&amp; yum localinstall -y *.rpm'</span></span><br><span class="line"></span><br><span class="line">  - name: 推送nginx.conf配置</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/ansible_wordpress/nginx_php/nginx.conf</span><br><span class="line">      dest: /etc/nginx</span><br><span class="line"></span><br><span class="line">  - name: 推送nginx配置</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/ansible_wordpress/nginx_php/blog.roger.com.conf</span><br><span class="line">      dest: /etc/nginx/conf.d</span><br><span class="line"></span><br><span class="line">  - name: 推送php配置</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/ansible_wordpress/nginx_php/www.conf</span><br><span class="line">      dest: /etc/php-fpm.d</span><br><span class="line"></span><br><span class="line">  - name: 部署wordpress</span><br><span class="line">    unarchive:</span><br><span class="line">      src: /root/ansible_wordpress/wordpress/wordpress.tar.gz</span><br><span class="line">      dest: /code</span><br><span class="line"></span><br><span class="line">  - name: 挂载共享目录</span><br><span class="line">    mount:</span><br><span class="line">      src: 172.16.1.31:/data</span><br><span class="line">      path: /code/wordpress/wp-content/uploads</span><br><span class="line">      fstype: nfs</span><br><span class="line">      state: mounted</span><br><span class="line"></span><br><span class="line">  - name: 启动nginx服务</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line"></span><br><span class="line">  - name: 启动php-fpm服务</span><br><span class="line">    service:</span><br><span class="line">      name: php-fpm</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line"></span><br><span class="line">- hosts: db_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 安装mariadb服务</span><br><span class="line">    yum:</span><br><span class="line">      name: </span><br><span class="line">        - mariadb-server</span><br><span class="line">        - MySQL-python</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">  - name: 推送maridb配置</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/ansible_wordpress/maridb/my.cnf</span><br><span class="line">      dest: /etc</span><br><span class="line"></span><br><span class="line">  - name: 启动mariadb服务</span><br><span class="line">    service:</span><br><span class="line">      name: mariadb</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line"></span><br><span class="line">  <span class="comment"># - name: 创建管理用户密码</span></span><br><span class="line">  <span class="comment">#   shell: mysqladmin -uroot password '123'</span></span><br><span class="line"></span><br><span class="line">  - name: 创建wordprss数据库</span><br><span class="line">    mysql_db:</span><br><span class="line">      login_user: root</span><br><span class="line">      login_password: 123</span><br><span class="line">      name: wordpress</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">  - name: 推送wordprss数据</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/ansible_wordpress/maridb/wordpress.sql</span><br><span class="line">      dest: /opt</span><br><span class="line"></span><br><span class="line">  - name: 导入wordprss数据</span><br><span class="line">    mysql_db:</span><br><span class="line">      login_user: root</span><br><span class="line">      login_password: 123</span><br><span class="line">      name: wordpress</span><br><span class="line">      target: /opt/wordpress.sql</span><br><span class="line">      state: import</span><br><span class="line"></span><br><span class="line">  - name: 创建wordpress用户</span><br><span class="line">    mysql_user:</span><br><span class="line">      login_user: root</span><br><span class="line">      login_password: 123</span><br><span class="line">      name: wp_user</span><br><span class="line">      password: 123</span><br><span class="line">      host: <span class="string">'%'</span></span><br><span class="line">      priv: <span class="string">'*.*:ALL'</span> </span><br><span class="line">      state: present</span><br><span class="line">      </span><br><span class="line">  - name: 启动mariadb服务</span><br><span class="line">    service:</span><br><span class="line">      name: mariadb</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br></pre></td></tr></table></figure>

<h1 id="Ansible变量"><a href="#Ansible变量" class="headerlink" title="Ansible变量"></a>Ansible变量</h1><h2 id="变量的概述"><a href="#变量的概述" class="headerlink" title="变量的概述"></a>变量的概述</h2><p>避免重复代码，方便维护，减少维护成本</p>
<h3 id="Ansible变量定义"><a href="#Ansible变量定义" class="headerlink" title="Ansible变量定义"></a>Ansible变量定义</h3><ul>
<li><p>命令行</p>
</li>
<li><p>play中定义</p>
<ul>
<li>vars</li>
<li>vars_files</li>
</ul>
</li>
<li><p>Inventory中定义</p>
<ul>
<li>hosts文件</li>
<li>host_vars目录</li>
<li>group_vars目录</li>
</ul>
</li>
</ul>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>命令行 &gt; play &gt; inventory</p>
<p>命令行 &gt; vars_files(play) &gt; vars(play) &gt; host_vars(inventory) &gt; group_vars(inventory) &gt; hosts文件(inventory)</p>
<h2 id="定义Ansible变量位置"><a href="#定义Ansible变量位置" class="headerlink" title="定义Ansible变量位置"></a>定义Ansible变量位置</h2><h3 id="在play中定义变量"><a href="#在play中定义变量" class="headerlink" title="在play中定义变量"></a>在play中定义变量</h3><ul>
<li>vars变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在play中用vars定义变量</span></span><br><span class="line">- hosts: web_group</span><br><span class="line">  vars:</span><br><span class="line">  	user_group: huanglong </span><br><span class="line">  	id: <span class="string">'438'</span> </span><br><span class="line">  	pkg:</span><br><span class="line">  		- nginx </span><br><span class="line">  		- php </span><br><span class="line">  		- mariadb-server </span><br><span class="line">  tasks: </span><br><span class="line">  - name: 创建&#123;&#123; user_group &#125;&#125;组 </span><br><span class="line">    group: </span><br><span class="line">      name: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span> </span><br><span class="line">      gid: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">      </span><br><span class="line">  - name: 创建&#123;&#123; user_group &#125;&#125;用户 </span><br><span class="line">    user:</span><br><span class="line">      name: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span> </span><br><span class="line">      uid: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">      group: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">      shell: /sbin/nologin </span><br><span class="line">      create_home: False</span><br><span class="line">      </span><br><span class="line">  - name: 安装nginx php mysql </span><br><span class="line">    yum:</span><br><span class="line">      name: <span class="string">"&#123;&#123; pkg &#125;&#125;"</span> </span><br><span class="line">      state: present</span><br></pre></td></tr></table></figure>

<ul>
<li>vars_files 变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group </span><br><span class="line">  vars: </span><br><span class="line">    user_group: huanglong </span><br><span class="line">    id: <span class="string">'438'</span> </span><br><span class="line">    pkg:</span><br><span class="line">      - nginx </span><br><span class="line">      - php </span><br><span class="line">      - mariadb-server </span><br><span class="line">  vars_files: ./roger_var.yml</span><br><span class="line">  </span><br><span class="line">  tasks: </span><br><span class="line">  - name: 创建&#123;&#123; user_group &#125;&#125;组 </span><br><span class="line">    group: </span><br><span class="line">      name: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span> </span><br><span class="line">      gid: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">      </span><br><span class="line">  - name: 创建&#123;&#123; user_group &#125;&#125;用户 </span><br><span class="line">    user: </span><br><span class="line">      name: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span> </span><br><span class="line">      uid: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">      group: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">      shell: /sbin/nologin </span><br><span class="line">      create_home: False</span><br><span class="line">      </span><br><span class="line">roger_var.yml </span><br><span class="line">user_group: wuyangke </span><br><span class="line">id: <span class="string">'250'</span> </span><br><span class="line">pkg:</span><br><span class="line">	- nginx </span><br><span class="line">	- php </span><br><span class="line">	- mariadb-server</span><br></pre></td></tr></table></figure>

<ul>
<li>层级变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 层级变量定义阶段</span></span><br><span class="line">jiagou:</span><br><span class="line">  - lnmp:</span><br><span class="line">    pkg:</span><br><span class="line">      - nginx</span><br><span class="line">      - php</span><br><span class="line">      - mysql</span><br><span class="line">  - lamp:</span><br><span class="line">    pkg:</span><br><span class="line">      - httpd</span><br><span class="line">      - php</span><br><span class="line">      - mysql</span><br><span class="line">  - lamt:</span><br><span class="line">    pkg:</span><br><span class="line">      - httpd</span><br><span class="line">      - tomcat</span><br><span class="line">      - mysql</span><br><span class="line">      </span><br><span class="line"><span class="comment">## 层级变量调用阶段</span></span><br><span class="line">- hosts: web_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 安装lamt</span><br><span class="line">    yum:</span><br><span class="line">      name: <span class="string">"&#123;&#123; jiagou.lamt.pkg &#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<h3 id="在inventory中定义变量"><a href="#在inventory中定义变量" class="headerlink" title="在inventory中定义变量"></a>在inventory中定义变量</h3><ul>
<li>在inventory文件中定义变量（几乎不用）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># vim /etc/ansible/hosts </span></span><br><span class="line">[web_group] </span><br><span class="line">web01 ansible_ssh_host=10.0.0.7 </span><br><span class="line">web02 ansible_ssh_host=10.0.0.8 </span><br><span class="line"></span><br><span class="line">[web_group:vars] </span><br><span class="line">user_group=xxx </span><br><span class="line">id=<span class="string">'666'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>host_vars</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 和yaml文件同级下创建目录 </span></span><br><span class="line">mkdir host_vars</span><br><span class="line"></span><br><span class="line"><span class="comment">## 针对主机定义变量 </span></span><br><span class="line">vim host_vars/web01 </span><br><span class="line">user_group: user_host_vars_web01 </span><br><span class="line">id: <span class="string">'444'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>group_vars</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 和yaml文件同级下创建目录 </span></span><br><span class="line">mkdir group_vars </span><br><span class="line"></span><br><span class="line"><span class="comment">## 针对主机组定义变量 </span></span><br><span class="line">vim group_vars/web_group </span><br><span class="line">user_group: user_group_vars_web_group </span><br><span class="line">id: <span class="string">'444'</span></span><br></pre></td></tr></table></figure>

<h2 id="优先级测试"><a href="#优先级测试" class="headerlink" title="优先级测试"></a>优先级测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.play中定义变量</span></span><br><span class="line">vars：vars_user </span><br><span class="line">vars_files：user_vars_files </span><br><span class="line">- hosts: web_group </span><br><span class="line">  vars: </span><br><span class="line">    - user_group: vars_user </span><br><span class="line">    - id: <span class="string">'444'</span> </span><br><span class="line">  vars_files: ./roger_var.yml </span><br><span class="line">  </span><br><span class="line">  tasks: </span><br><span class="line">    - name: 创建用户 </span><br><span class="line">    user: name: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span> </span><br><span class="line">    uid: <span class="string">"&#123;&#123; id &#125;&#125;"</span> </span><br><span class="line">    state: present</span><br><span class="line"></span><br><span class="line"><span class="comment">#2.主机清单定义变量</span></span><br><span class="line">hosts文件中：user_inventory </span><br><span class="line">[web_group:vars] </span><br><span class="line">user_group=user_inventory</span><br><span class="line"></span><br><span class="line">host_vars目录下</span><br><span class="line">- web01 user_group: </span><br><span class="line">  user_host_vars_web01 </span><br><span class="line">- web02 user_group: </span><br><span class="line">  user_host_vars_web02</span><br><span class="line">	</span><br><span class="line">group_vars目录下 </span><br><span class="line">web_group user_group: </span><br><span class="line">  user_group_vars_web_group</span><br><span class="line"></span><br><span class="line"><span class="comment">#3.命令行定义变量</span></span><br><span class="line">[root@m01 wordpress_ansible]<span class="comment"># ansible-playbook -e 'user_group=command_user'</span></span><br><span class="line">[root@m01 wordpress_ansible]<span class="comment"># ansible-playbook test.yml -i base/hosts -e 'user_group=command_user'</span></span><br></pre></td></tr></table></figure>

<h2 id="变量注册"><a href="#变量注册" class="headerlink" title="变量注册"></a>变量注册</h2><p>当absible的模块在运行之后，其实都会返回一些result结果，就像是执行脚本，我们有的时候需要脚本给我们一些return返回值，我们才知道，上一步是否可以执行成功，但是…默认情况下，ansible的result并不会显示出来，所以，我们可以把这些返回值’存储’到变量中，这样我们就能通过’调用’对应的变量名，从而获取到这些result，这种将模块的返回值，写入到变量中的方法被称为变量注册</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 查看nginx目录</span><br><span class="line">    shell: <span class="string">"ls -l /etc/nginx"</span></span><br><span class="line">    register: xxx</span><br><span class="line"></span><br><span class="line">  - name: 获取注册的变量值 nginx目录返回记过</span><br><span class="line">    debug:</span><br><span class="line">      msg: <span class="string">"&#123;&#123; xxx &#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<p>只需要打印详细的结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 查看nginx目录</span><br><span class="line">    shell: <span class="string">"ls -l /etc/nginx"</span></span><br><span class="line">    register: xxx</span><br><span class="line"></span><br><span class="line">  - name: 获取注册的变量值 nginx目录返回记过</span><br><span class="line">    debug:</span><br><span class="line">      msg: <span class="string">"&#123;&#123; xxx.stdout_lines &#125;&#125;"</span></span><br></pre></td></tr></table></figure>

<p>利用变量注册做判断</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 查看nginx目录</span><br><span class="line">    shell: <span class="string">"ls -l /etc/nginx"</span></span><br><span class="line">    register: xxx</span><br><span class="line"></span><br><span class="line">  - name: 获取注册的变量值 nginx目录返回结果</span><br><span class="line">    debug:</span><br><span class="line">      msg: <span class="string">"&#123;&#123; xxx.stdout_lines &#125;&#125;"</span></span><br><span class="line"></span><br><span class="line">  - name: 安装nginx和php</span><br><span class="line">    shell: <span class="built_in">cd</span> /opt &amp;&amp; rpm -Uvh *.rpm</span><br><span class="line">    when: xxx.rc != 0</span><br></pre></td></tr></table></figure>

<h2 id="facts缓存"><a href="#facts缓存" class="headerlink" title="facts缓存"></a>facts缓存</h2><p>Ansible facts是在被管理追击上通过Ansible自动采集发现的变量。facts包含每台特定的主机信息。比如：被控端的主机名、IP地址、系统版本、CPU数量、内存状态、磁盘状态等等。</p>
<h3 id="facts缓存应用场景"><a href="#facts缓存应用场景" class="headerlink" title="facts缓存应用场景"></a>facts缓存应用场景</h3><ul>
<li><input disabled="" type="checkbox"> 根据主机CPU，设置nginx配置文件，cpu亲和</li>
<li><input checked="" disabled="" type="checkbox"> 根据内存，配置MySQL的配置文件</li>
<li><input checked="" disabled="" type="checkbox"> 根据IP地址，配置redis配置文件</li>
</ul>
<h3 id="关闭facts缓存"><a href="#关闭facts缓存" class="headerlink" title="关闭facts缓存"></a>关闭facts缓存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- hosts: rsync_nfs</span><br><span class="line">  gather_facts: False  <span class="comment">## 关闭facts缓存</span></span><br><span class="line">  tasks:</span><br><span class="line">  - name: 安装rsync和nfs服务</span><br><span class="line">    yum:</span><br><span class="line">      name:</span><br><span class="line">        - rsync</span><br><span class="line">        - nfs-utils</span><br><span class="line">      state: present</span><br><span class="line"></span><br><span class="line">  - name: 创建目录</span><br><span class="line">    file:</span><br><span class="line">      path: /tmp/&#123;&#123; ansible_memtotal_mb &#125;&#125;</span><br><span class="line">      state: directory</span><br></pre></td></tr></table></figure>

<h1 id="Ansible流程控制"><a href="#Ansible流程控制" class="headerlink" title="Ansible流程控制"></a>Ansible流程控制</h1><h2 id="条件语句（判断）"><a href="#条件语句（判断）" class="headerlink" title="条件语句（判断）"></a>条件语句（判断）</h2><p>当满足什么条件时，就执行哪些tasks</p>
<p>when  当….时</p>
<h3 id="ansible获取主机名"><a href="#ansible获取主机名" class="headerlink" title="ansible获取主机名"></a>ansible获取主机名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 主机名中，不包含'.' 没有区别</span></span><br><span class="line">ansible_hostname  <span class="comment"># 包含'.' 只显示第一个'.'前面的名字</span></span><br><span class="line">ansible_fqdn      <span class="comment"># 包含'.' 显示完整的主机名</span></span><br></pre></td></tr></table></figure>

<p>不管是shell还是各大编程语言中，流程控制，条件判断这些都是必不可少的，在我们使用Ansible的过程中，条件判断的使用频率极其高。<br>例如：<br>1.我们使用不同的系统的时候，可以通过判断系统来对软件包进行安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">centos安装apache: yum install -y httpd</span><br><span class="line">unbuntu安装apache: apt-get install apache2</span><br><span class="line"></span><br><span class="line">tasks:</span><br><span class="line">  - name: <span class="string">"shut down Debian flavored systems"</span></span><br><span class="line">    <span class="built_in">command</span>: /sbin/shutdown -t now</span><br><span class="line">    when: ansible_facts[<span class="string">'os_family'</span>] == <span class="string">"Debian"</span></span><br><span class="line">    </span><br><span class="line">tasks:</span><br><span class="line">  - name: <span class="string">"shut down Debian flavored systems"</span></span><br><span class="line">    <span class="built_in">command</span>: apt-get install apache2</span><br><span class="line">    when: ansible_os_family == <span class="string">"Ubuntu"</span></span><br><span class="line">    </span><br><span class="line">- hosts: rsync_nfs</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 创建目录</span><br><span class="line">      file:</span><br><span class="line">        <span class="comment"># path: /opt/&#123;&#123; ansible_default_ipv4.address &#125;&#125;  ## setup模块，看到什么名字就使用什么名字</span></span><br><span class="line">        path: /usr/<span class="built_in">local</span>/&#123;&#123; ansible_facts[<span class="string">'default_ipv4'</span>][<span class="string">'address'</span>] &#125;&#125;  <span class="comment">## 官方写法</span></span><br><span class="line">        state: directory</span><br></pre></td></tr></table></figure>

<p>2.在nfs和rsync安装过程中，客户端服务器不需要推送配置文件，之前我们都是写多个play，会影响效率。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">- hosts: rsync_nfs</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 安装rsync和nfs服务</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - rsync</span><br><span class="line">          - nfs-utils</span><br><span class="line">        state: present</span><br><span class="line"></span><br><span class="line">    - name: 推送rsync配置文件</span><br><span class="line">      template:</span><br><span class="line">        src: /root/wordpress_ansible/rsync/rsyncd.conf</span><br><span class="line">        dest: /etc</span><br><span class="line">      when: ansible_hostname == <span class="string">'backup'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 多条件判断</span></span><br><span class="line">- hosts: rsync_nfs</span><br><span class="line">  tasks:</span><br><span class="line">    - name: 安装rsync和nfs服务</span><br><span class="line">      yum:</span><br><span class="line">        name:</span><br><span class="line">          - rsync</span><br><span class="line">          - nfs-utils</span><br><span class="line">        state: present</span><br><span class="line">      when: ansible_hostname == <span class="string">'backup'</span> or ansible_hostname == <span class="string">'nfs'</span></span><br><span class="line"></span><br><span class="line">    - name: 推送rsync配置文件</span><br><span class="line">      template:</span><br><span class="line">        src: /root/wordpress_ansible/rsync/rsyncd.conf</span><br><span class="line">        dest: /etc</span><br><span class="line">      when: ansible_hostname == <span class="string">'backup'</span></span><br></pre></td></tr></table></figure>

<p>3.我们在源码安装nginx的时候，执行第二遍就无法执行了，此时我们就可以进行判断是否安装过。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">- hosts: web_group</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 查看nginx目录</span><br><span class="line">    shell: <span class="string">"ls -l /etc/nginx"</span></span><br><span class="line">    register: xxx</span><br><span class="line">    </span><br><span class="line">  - name: 判断是否安装nginx</span><br><span class="line">    shell: <span class="string">'cd /opt &amp;&amp; rpm -Uvh *.rpm'</span></span><br><span class="line">    when: xxx.rc != 0</span><br><span class="line"></span><br><span class="line"> <span class="comment"># - name: 获取注册的变量值 nginx目录返回记过</span></span><br><span class="line"> <span class="comment">#   debug:</span></span><br><span class="line"> <span class="comment">#     msg: "&#123;&#123; xxx &#125;&#125;"</span></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"> <span class="comment">## 判断中的且或非</span></span><br><span class="line"> and</span><br><span class="line"> or</span><br><span class="line"> !</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 不使用and的多条件</span></span><br><span class="line">tasks:</span><br><span class="line">  - name: <span class="string">"shut down CentOS 6 systems"</span></span><br><span class="line">    <span class="built_in">command</span>: /sbin/shutdown -t now</span><br><span class="line">    when:</span><br><span class="line">      - ansible_facts[<span class="string">'distribution'</span>] == <span class="string">"CentOS"</span></span><br><span class="line">      - ansible_facts[<span class="string">'distribution_major_version'</span>]|int == 6</span><br><span class="line"> </span><br><span class="line"><span class="comment">## 模糊匹配</span></span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 推送nginx虚拟主机配置文件</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/wordpress_ansible/nginx_php/blog.zls.com.conf</span><br><span class="line">      dest: /etc/nginx/conf.d</span><br><span class="line">    <span class="comment"># when: ansible_hostname == 'web01' or ansible_hostname == 'web02'</span></span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line"></span><br><span class="line">  - name: 推送php配置文件</span><br><span class="line">    copy:</span><br><span class="line">      src: /root/wordpress_ansible/nginx_php/www.conf</span><br><span class="line">      dest: /etc/php-fpm.d</span><br></pre></td></tr></table></figure>

<h2 id="playbook循环语句"><a href="#playbook循环语句" class="headerlink" title="playbook循环语句"></a>playbook循环语句</h2><p>在之前的学习过程中，我们经常会有传送文件，创建目录之类的操作，创建2个目录就要写两个file模块来创建，如果要创建100个目录，我们需要写100个file模块？？？妈耶<del>~</del> 当然不是，只要有循环即可，减少重复性代码</p>
<h3 id="列表循环"><a href="#列表循环" class="headerlink" title="列表循环"></a>列表循环</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 启动多个服务</span></span><br><span class="line">数据类型：列表</span><br><span class="line"><span class="keyword">for</span> 循环列表类型</span><br><span class="line"></span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 启动nginx 和 php</span><br><span class="line">    service:</span><br><span class="line">      name: <span class="string">"&#123;&#123; item &#125;&#125;"</span> </span><br><span class="line">      state: stopped</span><br><span class="line">    <span class="comment"># when: ansible_hostname == 'web01' or ansible_hostname == 'web02'</span></span><br><span class="line">    with_items:</span><br><span class="line">      - nginx</span><br><span class="line">      - php-fpm</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line">    </span><br><span class="line">注意：一般不用于循环配置文件</span><br></pre></td></tr></table></figure>

<h3 id="字典循环"><a href="#字典循环" class="headerlink" title="字典循环"></a>字典循环</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 启动nginx 和 php</span><br><span class="line">    service:</span><br><span class="line">      name: <span class="string">"&#123;&#123; item &#125;&#125;"</span> </span><br><span class="line">      state: stopped</span><br><span class="line">    <span class="comment"># when: ansible_hostname == 'web01' or ansible_hostname == 'web02'</span></span><br><span class="line">    with_items:</span><br><span class="line">      - nginx</span><br><span class="line">      - php-fpm</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line"></span><br><span class="line">  - name: 推送nginx主配置文件、nginx虚拟主机配置文件和php配置文件</span><br><span class="line">    template:</span><br><span class="line">      src: <span class="string">"&#123;&#123; item.src &#125;&#125;"</span></span><br><span class="line">      dest: <span class="string">"&#123;&#123; item.dest &#125;&#125;"</span></span><br><span class="line">    with_items:</span><br><span class="line">      - &#123;src: <span class="string">"/root/wordpress_ansible/nginx_php/blog.zls.com.conf"</span>,dest: <span class="string">"/etc/nginx/conf.d"</span>&#125;</span><br><span class="line">      - &#123;src: <span class="string">"/root/wordpress_ansible/nginx_php/nginx.conf"</span>,dest: <span class="string">"/etc/nginx"</span>&#125;</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br></pre></td></tr></table></figure>

<h2 id="playbook-handlers（触发器）"><a href="#playbook-handlers（触发器）" class="headerlink" title="playbook handlers（触发器）"></a>playbook handlers（触发器）</h2><p>当修改完某个服务的配置文件时，应该重启该服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - name: 推送nginx和php的配置文件</span><br><span class="line">    template:</span><br><span class="line">      src: <span class="string">"&#123;&#123; item.src &#125;&#125;"</span></span><br><span class="line">      dest: <span class="string">"&#123;&#123; item.dest &#125;&#125;"</span></span><br><span class="line">    with_items:</span><br><span class="line">      - &#123;src: <span class="string">"/root/wordpress_ansible/nginx_php/blog.zls.com.conf"</span>,dest: <span class="string">'/etc/nginx/conf.d'</span>&#125;</span><br><span class="line">      - &#123;src: <span class="string">"/root/wordpress_ansible/nginx_php/nginx.conf"</span>,dest: <span class="string">'/etc/nginx'</span>&#125;</span><br><span class="line">    notify: Restart Nginx xxx</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line"></span><br><span class="line">  - name: 启动nginx服务</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: started</span><br><span class="line">      enabled: True</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line"></span><br><span class="line">  - name: 推送php配置文件</span><br><span class="line">    template:</span><br><span class="line">      src: /root/wordpress_ansible/nginx_php/www.conf</span><br><span class="line">      dest: /etc/php-fpm.d</span><br><span class="line">    notify: aaa</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">  - name: Restart Nginx xxx</span><br><span class="line">    service:</span><br><span class="line">      name: nginx</span><br><span class="line">      state: restarted</span><br><span class="line"></span><br><span class="line">  - name: aaa</span><br><span class="line">    service:</span><br><span class="line">      name: php-fpm</span><br><span class="line">      state: restarted</span><br></pre></td></tr></table></figure>

<h3 id="handler注意点"><a href="#handler注意点" class="headerlink" title="handler注意点"></a>handler注意点</h3><blockquote>
<p>1.无论多少个task调用相同handler，只会在所有tasks执行完成后，触发一次handlers</p>
<p>2.Handlers只有在其所在的任务被执行时，才会被运行；如果一个任务中定义了notify调用Handlers，但是由于条件判断等原因，该任务未被执行，那么Handlers同样不会被执行</p>
<p>3.Handlers只会在每一个play的末尾运行一次；如果想在一个playbook中间运行Handlers，则需要使用meta模块来实现。例如： -meta: flush_handlers。</p>
<p>4.如果一个play在运行到调用Handlers的语句之前失败了，那么这个Handlers将不会被执行。我们可以使用meta模块的–force-handlers选项来强制执行Handlers，即使Handlers所在的play中途运行失败也能执行。</p>
<p>5.不能使用handlers替代tasks</p>
</blockquote>
<h2 id="Ansible任务标签"><a href="#Ansible任务标签" class="headerlink" title="Ansible任务标签"></a>Ansible任务标签</h2><p>默认情况下，Ansible在执行一个playbook时，会执行playbook中定义的所有任务，Ansible的标签(tag)功能可以给单独任务甚至整个playbook打上标签，然后利用这些标签来指定要运行playbook中的个别任务，或不执行指定的任务</p>
<h3 id="打标签的方式"><a href="#打标签的方式" class="headerlink" title="打标签的方式"></a>打标签的方式</h3><ul>
<li>对一个task打一个tag</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- name: 安装rsync</span><br><span class="line">  yum:</span><br><span class="line">    name: rsync</span><br><span class="line">    state: present</span><br><span class="line">  when: ansible_hostname != <span class="string">'db01'</span></span><br><span class="line">  tags: install_rsync</span><br></pre></td></tr></table></figure>

<ul>
<li>对一个task打多个tag</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- name: 推送rsync配置文件</span><br><span class="line">  template:</span><br><span class="line">    src: /root/wordpress_ansible/rsync/rsyncd.conf</span><br><span class="line">    dest: /etc</span><br><span class="line">  when: ansible_hostname == <span class="string">'backup'</span></span><br><span class="line">  notify: Rrestart rsync</span><br><span class="line">  tags:</span><br><span class="line">    - install_rsync</span><br><span class="line">    - send_rsync_config</span><br></pre></td></tr></table></figure>

<ul>
<li>对多个task打一个tag</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">- name: 安装rsync</span><br><span class="line">  yum:</span><br><span class="line">    name: rsync</span><br><span class="line">    state: present</span><br><span class="line">  when: ansible_hostname != <span class="string">'db01'</span></span><br><span class="line">  tags: install_rsync</span><br><span class="line"></span><br><span class="line">- name: 推送rsync配置文件</span><br><span class="line">  template:</span><br><span class="line">    src: /root/wordpress_ansible/rsync/rsyncd.conf</span><br><span class="line">    dest: /etc</span><br><span class="line">  when: ansible_hostname == <span class="string">'backup'</span></span><br><span class="line">  tags: install_rsync</span><br><span class="line"></span><br><span class="line">- name: 创建密码文件</span><br><span class="line">  copy:</span><br><span class="line">    content: <span class="string">"&#123;&#123; rsync_user &#125;&#125;:123"</span></span><br><span class="line">    dest: <span class="string">"&#123;&#123; rsync_pass_path &#125;&#125;"</span></span><br><span class="line">    mode: 0600</span><br><span class="line">  when: ansible_hostname == <span class="string">'backup'</span></span><br><span class="line">  tags: install_rsync</span><br><span class="line"></span><br><span class="line">- name: 创建&#123;&#123; backup_dir &#125;&#125;目录</span><br><span class="line">  file:</span><br><span class="line">    path: /&#123;&#123; backup_dir &#125;&#125;</span><br><span class="line">    owner: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span></span><br><span class="line">    group: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span></span><br><span class="line">    state: directory</span><br><span class="line">  when: ansible_hostname == <span class="string">'backup'</span></span><br><span class="line">  tags: install_rsync</span><br><span class="line"></span><br><span class="line">- name: 启动rsync服务</span><br><span class="line">  service:</span><br><span class="line">    name: rsyncd</span><br><span class="line">    state: started</span><br><span class="line">    enabled: True</span><br><span class="line">  when: ansible_hostname == <span class="string">'backup'</span></span><br><span class="line">  tags: install_rsync</span><br></pre></td></tr></table></figure>

<h3 id="打完标签如何使用"><a href="#打完标签如何使用" class="headerlink" title="打完标签如何使用"></a>打完标签如何使用</h3><p>-t:执行指定的tag标签任务</p>
<p>–skip-tags:执行–skip-tags之外的标签任务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook -i base/hosts lnmp_wp.yml -t <span class="string">'install_rsync'</span></span><br><span class="line">ansible-playbook -i base/hosts lnmp_wp.yml --skip-tags <span class="string">'install_rsync'</span></span><br></pre></td></tr></table></figure>

<h2 id="playbook的复用"><a href="#playbook的复用" class="headerlink" title="playbook的复用"></a>playbook的复用</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - include: nginx/install_nginx.yml</span><br><span class="line">  - include: nginx/start_nginx.yml</span><br><span class="line">  - include: php/install_php.yml</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">  - include: php/handler_php.yml</span><br><span class="line">  </span><br><span class="line">php/config_php.yml</span><br><span class="line">- name: xxx</span><br><span class="line">  template:</span><br><span class="line">    src: xxx</span><br><span class="line">    dest: xxx</span><br><span class="line">  when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line">  notify: restart php</span><br><span class="line"></span><br><span class="line">php/handler_php.yml</span><br><span class="line">- name: restart php</span><br><span class="line">  service:</span><br><span class="line">    name: php-fpm</span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>

<h1 id="Jinja2-模板"><a href="#Jinja2-模板" class="headerlink" title="Jinja2 模板"></a>Jinja2 模板</h1><blockquote>
<p><strong>Q：什么是Jinja2？</strong></p>
<p>jinja2是Python的全功能模板引擎</p>
</blockquote>
<h2 id="Jinja2模板和Ansible关系"><a href="#Jinja2模板和Ansible关系" class="headerlink" title="Jinja2模板和Ansible关系"></a>Jinja2模板和Ansible关系</h2><p>Ansible通常会使用jinja2模板来修改被管理主机的配置文件等…在saltstack中同样会使用到jinja2<br>如果在100台主机上安装nginx，每台nginx的端口都不一样，如何解决？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upstram www.zls.com &#123;</span><br><span class="line">    server 172.16.1.7;</span><br><span class="line">    server 172.16.1.8;</span><br><span class="line">    server 172.16.1.9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2模板基础语法"><a href="#Jinja2模板基础语法" class="headerlink" title="Jinja2模板基础语法"></a>Jinja2模板基础语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; 变量名 &#125;&#125;  ## 调用变量</span><br><span class="line">&#123;# 注释 #&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2判断语法"><a href="#Jinja2判断语法" class="headerlink" title="Jinja2判断语法"></a>Jinja2判断语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">## shell判断</span><br><span class="line">if [ 条件 ];then</span><br><span class="line">xxx</span><br><span class="line">elif [ 条件 ];then</span><br><span class="line">aaa</span><br><span class="line">else</span><br><span class="line">bbb</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">## Python判断</span><br><span class="line">if 条件:</span><br><span class="line">  xxx</span><br><span class="line">elif 条件:</span><br><span class="line">  aaa</span><br><span class="line">else:</span><br><span class="line">  bbb</span><br><span class="line">xxxx</span><br><span class="line"></span><br><span class="line">## Jinja2判断</span><br><span class="line">&#123;% if 条件 %&#125;</span><br><span class="line">xxx</span><br><span class="line">&#123;% elif 条件 %&#125;</span><br><span class="line">aaa</span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">bbb</span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Jinja2循环"><a href="#Jinja2循环" class="headerlink" title="Jinja2循环"></a>Jinja2循环</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% for n in 条件 %&#125;</span><br><span class="line">xxx</span><br><span class="line">&#123;% endfor %&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jinja2实战部署keepalived"><a href="#Jinja2实战部署keepalived" class="headerlink" title="Jinja2实战部署keepalived"></a>Jinja2实战部署keepalived</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#keep配置文件（Master）</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id lb01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script check_web_zls &#123;</span><br><span class="line">    script <span class="string">"/root/check_web.sh"</span></span><br><span class="line">    interval 5</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    priority 150</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;         </span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    track_script &#123;</span><br><span class="line">      check_web_zls</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#keep配置文件（Backup）</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id lb02</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    priority 100</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;         </span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tasks.yml</span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - include: /root/ansible/keepalived/config_keepalived.yml</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">  - name: Restart Keepalived</span><br><span class="line">    service:</span><br><span class="line">      name: keepalived</span><br><span class="line">      </span><br><span class="line">keepalived.j2</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id &#123;&#123; ansible_hostname &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#123;% <span class="keyword">if</span> ansible_hostname == <span class="string">'web01'</span> %&#125;</span><br><span class="line">vrrp_script check_web_zls &#123;</span><br><span class="line">    script <span class="string">"/root/check_web.sh"</span></span><br><span class="line">    interval 5</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      check_web_zls</span><br><span class="line">    &#125;</span><br><span class="line">    priority 150</span><br><span class="line">    state MASTER</span><br><span class="line">&#123;% <span class="keyword">else</span> %&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    priority 100</span><br><span class="line">    state BACKUP</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 50</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;         </span><br><span class="line">        10.0.0.3</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Jinja2实战部署负载均衡"><a href="#Jinja2实战部署负载均衡" class="headerlink" title="Jinja2实战部署负载均衡"></a>Jinja2实战部署负载均衡</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx配置文件</span></span><br><span class="line">upstream &#123;&#123; wordpress_domain &#125;&#125; &#123;</span><br><span class="line">&#123;% <span class="keyword">for</span> num <span class="keyword">in</span> range(7,10) %&#125;</span><br><span class="line">    server 172.16.1.&#123;&#123; num &#125;&#125;;</span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server&#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name &#123;&#123; wordpress_domain &#125;&#125;;</span><br><span class="line"></span><br><span class="line">    location /&#123;</span><br><span class="line">        proxy_pass http://&#123;&#123; wordpress_domain &#125;&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- hosts: all</span><br><span class="line">  tasks:</span><br><span class="line">  - include: /root/ansible/lb/config_lb.yml</span><br><span class="line">    when: ansible_hostname is match <span class="string">'web*'</span></span><br></pre></td></tr></table></figure>

<h1 id="Ansible-Roles"><a href="#Ansible-Roles" class="headerlink" title="Ansible Roles"></a>Ansible Roles</h1><h2 id="roles目录结构"><a href="#roles目录结构" class="headerlink" title="roles目录结构"></a>roles目录结构</h2><p><img src="https://blog.driverzeng.com/wp-content/uploads/2021/08/15689649055718.jpg" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">production                <span class="comment"># inventory file for production servers</span></span><br><span class="line">staging                   <span class="comment"># inventory file for staging environment</span></span><br><span class="line"> </span><br><span class="line">group_vars/</span><br><span class="line">   group1.yml             <span class="comment"># here we assign variables to particular groups</span></span><br><span class="line">   group2.yml</span><br><span class="line">host_vars/</span><br><span class="line">   hostname1.yml          <span class="comment"># here we assign variables to particular systems</span></span><br><span class="line">   hostname2.yml</span><br><span class="line"> </span><br><span class="line">library/                  <span class="comment"># if any custom modules, put them here (optional)</span></span><br><span class="line">module_utils/             <span class="comment"># if any custom module_utils to support modules, put them here (optional)</span></span><br><span class="line">filter_plugins/           <span class="comment"># if any custom filter plugins, put them here (optional)</span></span><br><span class="line"> </span><br><span class="line">site.yml                  <span class="comment"># master playbook</span></span><br><span class="line">webservers.yml            <span class="comment"># playbook for webserver tier</span></span><br><span class="line">dbservers.yml             <span class="comment"># playbook for dbserver tier</span></span><br><span class="line"> </span><br><span class="line">roles/</span><br><span class="line">    common/               <span class="comment"># this hierarchy represents a "role"</span></span><br><span class="line">        tasks/            <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- tasks file can include smaller files if warranted</span></span><br><span class="line">        handlers/         <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- handlers file</span></span><br><span class="line">        templates/        <span class="comment">#  &lt;-- files for use with the template resource</span></span><br><span class="line">            ntp.conf.j2   <span class="comment">#  &lt;------- templates end in .j2</span></span><br><span class="line">        files/            <span class="comment">#</span></span><br><span class="line">            bar.txt       <span class="comment">#  &lt;-- files for use with the copy resource</span></span><br><span class="line">            foo.sh        <span class="comment">#  &lt;-- script files for use with the script resource</span></span><br><span class="line">        vars/             <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- variables associated with this role</span></span><br><span class="line">        defaults/         <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- default lower priority variables for this role</span></span><br><span class="line">        meta/             <span class="comment">#</span></span><br><span class="line">            main.yml      <span class="comment">#  &lt;-- role dependencies</span></span><br><span class="line">        library/          <span class="comment"># roles can also include custom modules</span></span><br><span class="line">        module_utils/     <span class="comment"># roles can also include custom module_utils</span></span><br><span class="line">        lookup_plugins/   <span class="comment"># or other types of plugins, like lookup in this case</span></span><br><span class="line"> </span><br><span class="line">    webtier/              <span class="comment"># same kind of structure as "common" was above, done for the webtier role</span></span><br><span class="line">    monitoring/           <span class="comment"># ""</span></span><br><span class="line">    fooapp/               <span class="comment"># ""</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible-Galaxy创建目录"><a href="#Ansible-Galaxy创建目录" class="headerlink" title="Ansible Galaxy创建目录"></a>Ansible Galaxy创建目录</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># mkdir roles</span></span><br><span class="line">[root@m01 ~]<span class="comment"># cd roles/</span></span><br><span class="line">[root@m01 roles]<span class="comment"># ansible-galaxy init nginx</span></span><br><span class="line">- Role nginx was created successfully</span><br><span class="line">[root@m01 roles]<span class="comment"># ll</span></span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x 10 root root 154 Jul  4 10:29 nginx</span><br><span class="line">[root@m01 roles]<span class="comment"># tree  nginx/</span></span><br><span class="line">nginx/</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── templates</span><br><span class="line">├── tests</span><br><span class="line">│   ├── inventory</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br></pre></td></tr></table></figure>

<h2 id="使用roles重构rsync"><a href="#使用roles重构rsync" class="headerlink" title="使用roles重构rsync"></a>使用roles重构rsync</h2><h3 id="创建项目"><a href="#创建项目" class="headerlink" title="创建项目"></a>创建项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 roles]<span class="comment"># ansible-galaxy init rsync-client</span></span><br><span class="line">- Role rsync-client was created successfully</span><br><span class="line"></span><br><span class="line">[root@m01 roles]<span class="comment"># ansible-galaxy init rsync-server</span></span><br><span class="line">- Role rsync-server was created successfully</span><br></pre></td></tr></table></figure>

<h3 id="rsync-server"><a href="#rsync-server" class="headerlink" title="rsync-server"></a>rsync-server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ansible]<span class="comment"># tree /root/roles/rsync-server/</span></span><br><span class="line">/root/roles/rsync-server/</span><br><span class="line">├── defaults</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── files</span><br><span class="line">├── handlers</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── meta</span><br><span class="line">│   └── main.yml</span><br><span class="line">├── README.md</span><br><span class="line">├── tasks</span><br><span class="line">│   ├── config_rsync.yml</span><br><span class="line">│   ├── main.yml</span><br><span class="line">│   ├── server_rsync.yml</span><br><span class="line">│   └── start_rsync.yml</span><br><span class="line">├── templates</span><br><span class="line">│   └── rsyncd.j2</span><br><span class="line">├── tests</span><br><span class="line">│   ├── inventory</span><br><span class="line">│   └── test.yml</span><br><span class="line">└── vars</span><br><span class="line">    └── main.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">## 配置文件</span></span><br><span class="line">[root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/templates/rsyncd.j2 </span></span><br><span class="line">uid = &#123;&#123; user_group &#125;&#125;</span><br><span class="line">gid = &#123;&#123; user_group &#125;&#125;</span><br><span class="line">port = 873</span><br><span class="line">fake super = yes</span><br><span class="line">use chroot = no</span><br><span class="line">max connections = 200</span><br><span class="line">timeout = 600</span><br><span class="line">ignore errors</span><br><span class="line"><span class="built_in">read</span> only = <span class="literal">false</span></span><br><span class="line">list = <span class="literal">false</span></span><br><span class="line">auth users = &#123;&#123; rsync_user &#125;&#125;</span><br><span class="line">secrets file = &#123;&#123; rsync_pass_file &#125;&#125;</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/rsyncd.log</span><br><span class="line"><span class="comment">#####################################</span></span><br><span class="line">[&#123;&#123; rsync_dir &#125;&#125;]</span><br><span class="line">comment = welcome to oldboyedu backup!</span><br><span class="line">path = /&#123;&#123; rsync_dir &#125;&#125;</span><br><span class="line"></span><br><span class="line">[&#123;&#123; nfs_dir &#125;&#125;]</span><br><span class="line">comment = welcome to oldboyedu backup!</span><br><span class="line">path = /&#123;&#123; nfs_dir &#125;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## tasks</span></span><br><span class="line">[root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/tasks/config_rsync.yml </span></span><br><span class="line">- name: 推送rsync配置文件</span><br><span class="line">  template:</span><br><span class="line">    src: rsyncd.j2</span><br><span class="line">    dest: /etc/rsyncd.conf</span><br><span class="line">  notify: Restart Rsync</span><br><span class="line"></span><br><span class="line">[root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/tasks/server_rsync.yml </span></span><br><span class="line">- name: 创建密码文件</span><br><span class="line">  copy:</span><br><span class="line">    content: <span class="string">"&#123;&#123; rsync_user &#125;&#125;:&#123;&#123; rsync_pass &#125;&#125;"</span></span><br><span class="line">    dest: /&#123;&#123; rsync_pass_file &#125;&#125;</span><br><span class="line">    mode: 0600</span><br><span class="line"></span><br><span class="line">- name: 创建rsync目录</span><br><span class="line">  file:</span><br><span class="line">    path: <span class="string">"&#123;&#123; item &#125;&#125;"</span></span><br><span class="line">    owner: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span></span><br><span class="line">    group: <span class="string">"&#123;&#123; user_group &#125;&#125;"</span></span><br><span class="line">    state: directory</span><br><span class="line">  with_items:</span><br><span class="line">    - /&#123;&#123; rsync_dir &#125;&#125;</span><br><span class="line">    - /&#123;&#123; nfs_dir &#125;&#125;</span><br><span class="line"></span><br><span class="line">  [root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/tasks/start_rsync.yml </span></span><br><span class="line">- name: 启动rsync</span><br><span class="line">  service:</span><br><span class="line">    name: rsyncd</span><br><span class="line">    state: started</span><br><span class="line">    enabled: True</span><br><span class="line">    </span><br><span class="line">[root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/tasks/main.yml </span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># tasks file for rsync-server</span></span><br><span class="line">- include: config_rsync.yml</span><br><span class="line">- include: server_rsync.yml</span><br><span class="line">- include: start_rsync.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">## meta</span></span><br><span class="line">[root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/meta/main.yml </span></span><br><span class="line">dependencies:</span><br><span class="line">  - &#123;role: create-user&#125;</span><br><span class="line">  - &#123;role: rsync-client&#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment">## handlers</span></span><br><span class="line">[root@m01 ansible]<span class="comment"># cat /root/roles/rsync-server/handlers/main.yml </span></span><br><span class="line">---</span><br><span class="line"><span class="comment"># handlers file for rsync-server</span></span><br><span class="line">- name: Restart Rsync</span><br><span class="line">  service:</span><br><span class="line">    name: rsyncd</span><br><span class="line">    state: restarted</span><br></pre></td></tr></table></figure>

<h2 id="系统优化"><a href="#系统优化" class="headerlink" title="系统优化"></a>系统优化</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- name: 压缩yum源</span><br><span class="line">	archive:</span><br><span class="line">		path: /etc/yum.repos.d/ </span><br><span class="line">		dest: /tmp/yum.tgz</span><br><span class="line">		remove: True</span><br><span class="line">		 </span><br><span class="line">- name：优化文件描述符</span><br><span class="line">  pam_limits:</span><br><span class="line">    domain: <span class="string">'*‘</span></span><br><span class="line"><span class="string">    limit_type: '</span>-<span class="string">'</span></span><br><span class="line"><span class="string">    limit_item: nofile</span></span><br><span class="line"><span class="string">    value: '</span>65535<span class="string">'</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible-galaxy"><a href="#Ansible-galaxy" class="headerlink" title="Ansible galaxy"></a>Ansible galaxy</h2><h3 id="Ansible查找roles"><a href="#Ansible查找roles" class="headerlink" title="Ansible查找roles"></a>Ansible查找roles</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># ansible-galaxy search openvpn</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-galaxy search nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="查看详细信息"><a href="#查看详细信息" class="headerlink" title="查看详细信息"></a>查看详细信息</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># ansible-galaxy info kostyrevaa.openvpn</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-galaxy info acandid.nginx</span></span><br></pre></td></tr></table></figure>

<h3 id="安装项目"><a href="#安装项目" class="headerlink" title="安装项目"></a>安装项目</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@m01 ~]<span class="comment"># ansible-galaxy install acandid.nginx</span></span><br></pre></td></tr></table></figure>

<h2 id="Ansible-vault"><a href="#Ansible-vault" class="headerlink" title="Ansible vault"></a>Ansible vault</h2><p>给playbook加密</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 加密</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-vault encrypt test.yml </span></span><br><span class="line">New Vault password: </span><br><span class="line">Confirm New Vault password: </span><br><span class="line">Encryption successful</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查看加密后的playbook</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-vault view test.yml </span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 编辑加密后的playbook</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-vault edit test.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 重置密码</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-vault rekey test.yml</span></span><br><span class="line">Vault password: </span><br><span class="line">New Vault password: </span><br><span class="line">Confirm New Vault password: </span><br><span class="line">Rekey successful</span><br><span class="line"></span><br><span class="line"><span class="comment">## 取消密码</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-vault decrypt test.yml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 执行带密码的ansible playbook</span></span><br><span class="line">[root@m01 ~]<span class="comment"># echo 111 &gt; /tmp/ansible.pass</span></span><br><span class="line">[root@m01 ~]<span class="comment"># ansible-playbook -i /root/ansible/manager/hosts test.yml --vault-password-file=/tmp/ansible.pass</span></span><br></pre></td></tr></table></figure>


    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Lupinus
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="http://yoursite.com/2019/04/27/Ansible%E8%87%AA%E5%8A%A8%E5%8C%96/" title="[Ansible自动化]">http://yoursite.com/2019/04/27/Ansible自动化/</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Linxu%E6%9E%B6%E6%9E%84/" rel="tag"># Linxu架构</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2019/04/26/Nginx%E6%9C%8D%E5%8A%A1/" rel="prev" title="[Nginx服务]">
      <i class="fa fa-chevron-left"></i> [Nginx服务]
    </a></div>
      <div class="post-nav-item">
    <a href="/2019/04/28/Firewalld%E9%98%B2%E7%81%AB%E5%A2%99/" rel="next" title="[Firewalld防火墙]">
      [Firewalld防火墙] <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible基础入门"><span class="nav-number">1.</span> <span class="nav-text">Ansible基础入门</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible基础概述"><span class="nav-number">1.1.</span> <span class="nav-text">Ansible基础概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#同类型软件对比"><span class="nav-number">1.2.</span> <span class="nav-text">同类型软件对比</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible的功能"><span class="nav-number">1.3.</span> <span class="nav-text">Ansible的功能</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible的架构"><span class="nav-number">1.4.</span> <span class="nav-text">Ansible的架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible的执行流程"><span class="nav-number">1.5.</span> <span class="nav-text">Ansible的执行流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible安装部署"><span class="nav-number">1.6.</span> <span class="nav-text">Ansible安装部署</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境准备"><span class="nav-number">1.6.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装Ansible"><span class="nav-number">1.6.2.</span> <span class="nav-text">安装Ansible</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible配置文件读取顺序"><span class="nav-number">1.6.3.</span> <span class="nav-text">Ansible配置文件读取顺序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible配置文件详解"><span class="nav-number">1.6.4.</span> <span class="nav-text">Ansible配置文件详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible-Inventory-主机清单"><span class="nav-number">1.6.5.</span> <span class="nav-text">Ansible Inventory(主机清单)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#使用IP-端口-用户-密码"><span class="nav-number">1.6.5.1.</span> <span class="nav-text">使用IP+端口+用户+密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#主机名-密码"><span class="nav-number">1.6.5.2.</span> <span class="nav-text">主机名+密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#变量方式，主机名-密码"><span class="nav-number">1.6.5.3.</span> <span class="nav-text">变量方式，主机名+密码</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用秘钥连接"><span class="nav-number">1.6.5.4.</span> <span class="nav-text">使用秘钥连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#企业使用究极进化版（☆☆☆☆☆）"><span class="nav-number">1.6.5.5.</span> <span class="nav-text">企业使用究极进化版（☆☆☆☆☆）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置主机标签组"><span class="nav-number">1.6.5.6.</span> <span class="nav-text">配置主机标签组</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible执行任务"><span class="nav-number">1.7.</span> <span class="nav-text">Ansible执行任务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ad-hoc结果返回颜色"><span class="nav-number">1.7.1.</span> <span class="nav-text">ad-hoc结果返回颜色</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible查看帮助"><span class="nav-number">1.7.2.</span> <span class="nav-text">ansible查看帮助</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ad-hoc常用模块"><span class="nav-number">2.</span> <span class="nav-text">Ad-hoc常用模块</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#command模块、shell模块"><span class="nav-number">2.1.</span> <span class="nav-text">command模块、shell模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#script模块"><span class="nav-number">2.2.</span> <span class="nav-text">script模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible文件管理模块"><span class="nav-number">2.3.</span> <span class="nav-text">Ansible文件管理模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#file模块"><span class="nav-number">2.3.1.</span> <span class="nav-text">file模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#copy模块"><span class="nav-number">2.3.2.</span> <span class="nav-text">copy模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-url"><span class="nav-number">2.3.3.</span> <span class="nav-text">get_url</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible软件管理模块"><span class="nav-number">2.4.</span> <span class="nav-text">Ansible软件管理模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#yum模块"><span class="nav-number">2.4.1.</span> <span class="nav-text">yum模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yum-repository"><span class="nav-number">2.4.2.</span> <span class="nav-text">yum_repository</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible服务管理模块"><span class="nav-number">2.5.</span> <span class="nav-text">Ansible服务管理模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#service、systemd"><span class="nav-number">2.5.1.</span> <span class="nav-text">service、systemd</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible用户管理模块"><span class="nav-number">2.6.</span> <span class="nav-text">Ansible用户管理模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#user"><span class="nav-number">2.6.1.</span> <span class="nav-text">user</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#group"><span class="nav-number">2.6.2.</span> <span class="nav-text">group</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible定时任务模块"><span class="nav-number">2.7.</span> <span class="nav-text">Ansible定时任务模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cron"><span class="nav-number">2.7.1.</span> <span class="nav-text">cron</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible磁盘挂载模块"><span class="nav-number">2.8.</span> <span class="nav-text">Ansible磁盘挂载模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mount"><span class="nav-number">2.8.1.</span> <span class="nav-text">mount</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible解压模块"><span class="nav-number">2.9.</span> <span class="nav-text">Ansible解压模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#archive、unarchive"><span class="nav-number">2.9.1.</span> <span class="nav-text">archive、unarchive</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible数据库模块"><span class="nav-number">2.10.</span> <span class="nav-text">Ansible数据库模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql-user"><span class="nav-number">2.10.1.</span> <span class="nav-text">mysql_user</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql-db"><span class="nav-number">2.10.2.</span> <span class="nav-text">mysql_db</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#setup模块"><span class="nav-number">2.11.</span> <span class="nav-text">setup模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#快速搭建rsync"><span class="nav-number">2.12.</span> <span class="nav-text">快速搭建rsync</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#作业"><span class="nav-number">2.13.</span> <span class="nav-text">作业</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作"><span class="nav-number">2.13.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#环境准备-1"><span class="nav-number">2.13.2.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写Ad-hoc"><span class="nav-number">2.13.3.</span> <span class="nav-text">编写Ad-hoc</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible剧本playbook"><span class="nav-number">3.</span> <span class="nav-text">Ansible剧本playbook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook语法"><span class="nav-number">3.1.</span> <span class="nav-text">playbook语法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#yaml语法"><span class="nav-number">3.1.1.</span> <span class="nav-text">yaml语法</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook小练习"><span class="nav-number">3.2.</span> <span class="nav-text">playbook小练习</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook实战"><span class="nav-number">3.3.</span> <span class="nav-text">playbook实战</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境准备-2"><span class="nav-number">3.3.1.</span> <span class="nav-text">环境准备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook部署wordpress"><span class="nav-number">3.4.</span> <span class="nav-text">playbook部署wordpress</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作-1"><span class="nav-number">3.4.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据备份"><span class="nav-number">3.4.2.</span> <span class="nav-text">数据备份</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lnmp-yml"><span class="nav-number">3.4.3.</span> <span class="nav-text">lnmp.yml</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible变量"><span class="nav-number">4.</span> <span class="nav-text">Ansible变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#变量的概述"><span class="nav-number">4.1.</span> <span class="nav-text">变量的概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible变量定义"><span class="nav-number">4.1.1.</span> <span class="nav-text">Ansible变量定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优先级"><span class="nav-number">4.1.2.</span> <span class="nav-text">优先级</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#定义Ansible变量位置"><span class="nav-number">4.2.</span> <span class="nav-text">定义Ansible变量位置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#在play中定义变量"><span class="nav-number">4.2.1.</span> <span class="nav-text">在play中定义变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在inventory中定义变量"><span class="nav-number">4.2.2.</span> <span class="nav-text">在inventory中定义变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#优先级测试"><span class="nav-number">4.3.</span> <span class="nav-text">优先级测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量注册"><span class="nav-number">4.4.</span> <span class="nav-text">变量注册</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#facts缓存"><span class="nav-number">4.5.</span> <span class="nav-text">facts缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#facts缓存应用场景"><span class="nav-number">4.5.1.</span> <span class="nav-text">facts缓存应用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭facts缓存"><span class="nav-number">4.5.2.</span> <span class="nav-text">关闭facts缓存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible流程控制"><span class="nav-number">5.</span> <span class="nav-text">Ansible流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#条件语句（判断）"><span class="nav-number">5.1.</span> <span class="nav-text">条件语句（判断）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ansible获取主机名"><span class="nav-number">5.1.1.</span> <span class="nav-text">ansible获取主机名</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook循环语句"><span class="nav-number">5.2.</span> <span class="nav-text">playbook循环语句</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#列表循环"><span class="nav-number">5.2.1.</span> <span class="nav-text">列表循环</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字典循环"><span class="nav-number">5.2.2.</span> <span class="nav-text">字典循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook-handlers（触发器）"><span class="nav-number">5.3.</span> <span class="nav-text">playbook handlers（触发器）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#handler注意点"><span class="nav-number">5.3.1.</span> <span class="nav-text">handler注意点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible任务标签"><span class="nav-number">5.4.</span> <span class="nav-text">Ansible任务标签</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#打标签的方式"><span class="nav-number">5.4.1.</span> <span class="nav-text">打标签的方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#打完标签如何使用"><span class="nav-number">5.4.2.</span> <span class="nav-text">打完标签如何使用</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#playbook的复用"><span class="nav-number">5.5.</span> <span class="nav-text">playbook的复用</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Jinja2-模板"><span class="nav-number">6.</span> <span class="nav-text">Jinja2 模板</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Jinja2模板和Ansible关系"><span class="nav-number">6.1.</span> <span class="nav-text">Jinja2模板和Ansible关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2模板基础语法"><span class="nav-number">6.1.1.</span> <span class="nav-text">Jinja2模板基础语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2判断语法"><span class="nav-number">6.1.2.</span> <span class="nav-text">Jinja2判断语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jinja2循环"><span class="nav-number">6.1.3.</span> <span class="nav-text">Jinja2循环</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jinja2实战部署keepalived"><span class="nav-number">6.2.</span> <span class="nav-text">Jinja2实战部署keepalived</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jinja2实战部署负载均衡"><span class="nav-number">6.3.</span> <span class="nav-text">Jinja2实战部署负载均衡</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible-Roles"><span class="nav-number">7.</span> <span class="nav-text">Ansible Roles</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#roles目录结构"><span class="nav-number">7.1.</span> <span class="nav-text">roles目录结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible-Galaxy创建目录"><span class="nav-number">7.2.</span> <span class="nav-text">Ansible Galaxy创建目录</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用roles重构rsync"><span class="nav-number">7.3.</span> <span class="nav-text">使用roles重构rsync</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建项目"><span class="nav-number">7.3.1.</span> <span class="nav-text">创建项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#rsync-server"><span class="nav-number">7.3.2.</span> <span class="nav-text">rsync-server</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统优化"><span class="nav-number">7.4.</span> <span class="nav-text">系统优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible-galaxy"><span class="nav-number">7.5.</span> <span class="nav-text">Ansible galaxy</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Ansible查找roles"><span class="nav-number">7.5.1.</span> <span class="nav-text">Ansible查找roles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看详细信息"><span class="nav-number">7.5.2.</span> <span class="nav-text">查看详细信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装项目"><span class="nav-number">7.5.3.</span> <span class="nav-text">安装项目</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Ansible-vault"><span class="nav-number">7.6.</span> <span class="nav-text">Ansible vault</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Lupinus"
      src="https://roger-hub.oss-cn-shanghai.aliyuncs.com/img_devops/20160715144434_fZCsF.jpeg">
  <p class="site-author-name" itemprop="name">Lupinus</p>
  <div class="site-description" itemprop="description">Re：从零开始的go学习生活(｀・ω・´)</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">49</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">16</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/rogerXS80/roger" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;rogerXS80&#x2F;roger" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/fastsword66@gmail.com" title="E-Mail → fastsword66@gmail.com"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/u/5896791111/home?wvr=5&sudaref=graph.qq.com" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;u&#x2F;5896791111&#x2F;home?wvr&#x3D;5&amp;sudaref&#x3D;graph.qq.com" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>



      </div>

      
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <!-- 选择合适的icon -->
              <i class="fa fa-history fa-" aria-hidden="true"></i>
          <!-- 这里对应下文主题配置文件的recent_posts_title值 -->
              最近文章
            </div>
            <ul class="links-of-blogroll-list"> 
              <!-- 设置排序规格，此处我采用按照文章更新时间排序 -->
              
              <!-- 显示三条近期文章，请自信合理配置 -->
              
                <li>
                  <a href="/2017/06/22/Git%E5%91%BD%E4%BB%A4%E5%A4%A7%E5%85%A8/" title="[Git命令大全]" target="_blank">[Git命令大全]</a>
                </li>
              
                <li>
                  <a href="/2022/02/27/Vue%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A1%B9%E7%9B%AE%E6%90%AD%E5%BB%BA/" title="[Vue客户端项目搭建]" target="_blank">[Vue客户端项目搭建]</a>
                </li>
              
                <li>
                  <a href="/2022/02/26/Vue%E8%87%AA%E5%8A%A8%E5%8C%96%E5%B7%A5%E5%85%B7%EF%BC%88Vue-cli%EF%BC%89/" title="[Vue自动化工具（Vue-cli）]" target="_blank">[Vue自动化工具（Vue-cli）]</a>
                </li>
              
            </ul>
          </div>
      

      
    </div>
  </aside>
  <div id="sidebar-dimmer"></div>




      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Roger</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div><!-- 文件位置：~/sourse/_data/footer.swig -->

<div class="weixin-box">
  <div class="weixin-menu">
    <div class="weixin-hover">
      <div class="weixin-description">微信扫一扫，订阅本博客</div>
    </div>
  </div>
</div>


        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script size="100" alpha="0.4" zIndex="-1" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-ribbon@1/canvas-ribbon.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>


  <script defer src="/lib/three/three.min.js"></script>
    <script defer src="/lib/three/three-waves.min.js"></script>
    <script defer src="/lib/three/canvas_lines.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













    <div id="pjax">
  

  

    </div>

<!-- 鼠标点击特效 -->
<script type="text/javascript" src="/js/fireworks.js"></script>

<!-- 点击爱心 
<script type="text/javascript" src="/js/clicklove.js"></script>
-->

</body>
</html>
